<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#f8f3eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>寶寶照護筆記</title>
    <style>
        :root {
            --primary: #7caacb;
            --primary-light: #d4e5f7;
            --secondary: #f3a683;
            --secondary-light: #fce8d9;
            --tertiary: #a0c1b8;
            --tertiary-light: #e5f0ee;
            --background: #f8f3eb;
            --card-bg: #ffffff;
            --text: #383838;
            --text-light: #767676;
            --border: #eaeaea;
            --shadow: rgba(0, 0, 0, 0.05);
            
            --font-main: system-ui, -apple-system, "PingFang TC", "Microsoft JhengHei", sans-serif;
            --radius: 12px;
            --spacing: 16px;
        }

        [data-theme="dark"] {
            --primary: #5a89ad;
            --primary-light: #2a4053;
            --secondary: #e3855e;
            --secondary-light: #4d3328;
            --tertiary: #7ba89e;
            --tertiary-light: #2c3b38;
            --background: #1a1a1a;
            --card-bg: #2c2c2c;
            --text: #f0f0f0;
            --text-light: #a0a0a0;
            --border: #3a3a3a;
            --shadow: rgba(0, 0, 0, 0.2);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--background);
            color: var(--text);
            min-height: 100vh;
            padding-bottom: 60px;
            overflow-x: hidden;
            line-height: 1.5;
        }

        .container {
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            padding: var(--spacing);
        }

        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--spacing);
            position: sticky;
            top: 0;
            background-color: var(--background);
            z-index: 10;
            padding: 12px var(--spacing);
            border-bottom: 1px solid var(--border);
        }

        .header-title {
            font-size: 1.2rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-action {
            display: flex;
            gap: 8px;
        }

        .child-selector {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: var(--spacing);
            overflow-x: auto;
            padding-bottom: 8px;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }

        .child-selector::-webkit-scrollbar {
            display: none;
        }

        .child-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--primary-light);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary);
            cursor: pointer;
            flex-shrink: 0;
            position: relative;
            transition: transform 0.2s;
            border: 2px solid transparent;
            overflow: hidden;
        }

        .child-avatar.active {
            border-color: var(--primary);
            transform: scale(1.1);
        }

        .child-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .add-child {
            background-color: var(--border);
            color: var(--text-light);
        }

        .card {
            background-color: var(--card-bg);
            border-radius: var(--radius);
            padding: var(--spacing);
            margin-bottom: var(--spacing);
            box-shadow: 0 2px 10px var(--shadow);
            overflow: hidden;
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .card-title {
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
        }

        .card-content {
            margin-bottom: 12px;
        }

        .overview-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }

        .overview-item {
            background-color: var(--primary-light);
            border-radius: var(--radius);
            padding: 12px 8px;
            text-align: center;
        }

        .overview-item.feeding {
            background-color: var(--primary-light);
        }

        .overview-item.sleep {
            background-color: var(--secondary-light);
        }

        .overview-item.diaper {
            background-color: var(--tertiary-light);
        }

        .overview-number {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .overview-label {
            font-size: 0.85rem;
            color: var(--text-light);
        }

        .quick-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 16px;
        }

        .action-btn {
            background-color: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 8px 16px;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: background-color 0.2s;
            color: var(--text);
            flex-grow: 1;
            justify-content: center;
            white-space: nowrap;
        }

        .action-btn:active {
            background-color: var(--border);
        }

        .btn {
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 24px;
            padding: 8px 16px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .btn:active {
            opacity: 0.8;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.8rem;
        }

        .btn-text {
            background: none;
            border: none;
            color: var(--primary);
            cursor: pointer;
            font-size: 0.9rem;
        }

        .btn-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--primary-light);
            color: var(--primary);
            border: none;
            cursor: pointer;
        }

        .nav-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--card-bg);
            display: flex;
            justify-content: space-around;
            padding: 8px 0;
            box-shadow: 0 -2px 10px var(--shadow);
            z-index: 100;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 4px 0;
            cursor: pointer;
            color: var(--text-light);
            font-size: 0.7rem;
            width: 20%;
        }

        .nav-item.active {
            color: var(--primary);
        }

        .nav-icon {
            font-size: 1.3rem;
            margin-bottom: 2px;
        }

        .records-list {
            max-height: 300px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .record-item {
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .record-item:last-child {
            border-bottom: none;
        }

        .record-main {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .record-time {
            font-size: 0.8rem;
            color: var(--text-light);
        }

        .record-details {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .record-tag {
            font-size: 0.8rem;
            background-color: var(--primary-light);
            padding: 2px 8px;
            border-radius: 12px;
            color: var(--primary);
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: var(--text-light);
        }

        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-family: var(--font-main);
            font-size: 1rem;
            background-color: var(--card-bg);
            color: var(--text);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
        }

        .toggle-group {
            display: flex;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
        }

        .toggle-option {
            flex: 1;
            padding: 8px 0;
            text-align: center;
            background-color: var(--card-bg);
            cursor: pointer;
            font-size: 0.9rem;
            border-right: 1px solid var(--border);
        }

        .toggle-option:last-child {
            border-right: none;
        }

        .toggle-option.active {
            background-color: var(--primary);
            color: white;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .modal.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: var(--card-bg);
            border-radius: var(--radius);
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            padding: var(--spacing);
            transform: translateY(20px);
            transition: transform 0.3s;
        }

        .modal.active .modal-content {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .modal-title {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.5rem;
            color: var(--text-light);
            line-height: 1;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            margin-bottom: 16px;
            gap: 16px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }

        .tabs::-webkit-scrollbar {
            display: none;
        }

        .tab {
            padding: 8px 4px;
            cursor: pointer;
            font-size: 0.9rem;
            color: var(--text-light);
            position: relative;
            white-space: nowrap;
        }

        .tab.active {
            color: var(--primary);
            font-weight: 600;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background-color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .stat-chart {
            height: 150px;
            margin: 16px 0;
            display: flex;
            align-items: flex-end;
            gap: 6px;
        }

        .stat-bar {
            flex: 1;
            background-color: var(--primary-light);
            position: relative;
            border-radius: 4px 4px 0 0;
            min-height: 4px;
        }

        .stat-label {
            position: absolute;
            bottom: -24px;
            left: 0;
            right: 0;
            font-size: 0.7rem;
            text-align: center;
            color: var(--text-light);
        }

        .mini-stat {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 0.9rem;
        }

        .mini-stat-value {
            font-weight: 600;
        }

        .empty-state {
            text-align: center;
            padding: 32px 0;
            color: var(--text-light);
        }

        .empty-icon {
            font-size: 3rem;
            margin-bottom: 16px;
            opacity: 0.2;
        }

        .empty-text {
            font-size: 0.9rem;
        }

        .timer-display {
            font-size: 2.5rem;
            text-align: center;
            margin: 24px 0;
            font-weight: 600;
            font-variant-numeric: tabular-nums;
        }

        .timer-controls {
            display: flex;
            justify-content: center;
            gap: 16px;
        }

        .timer-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            border: none;
            cursor: pointer;
        }

        .timer-start {
            background-color: var(--primary);
            color: white;
        }

        .timer-stop {
            background-color: var(--secondary);
            color: white;
        }

        .milestone-item {
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            margin-bottom: 12px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .milestone-item.completed {
            background-color: var(--tertiary-light);
            border-color: var(--tertiary);
        }

        .milestone-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }

        .milestone-age {
            font-size: 0.8rem;
            color: var(--text-light);
        }

        .checkmark {
            color: var(--tertiary);
        }

        .settings-item {
            padding: 16px 0;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .settings-item:last-child {
            border-bottom: none;
        }

        .photo-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 16px;
        }

        .photo-item {
            aspect-ratio: 1;
            background-color: var(--primary-light);
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }

        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-date {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            font-size: 0.7rem;
            padding: 4px;
            text-align: center;
        }

        .interaction-photo {
            margin-top: 8px;
            width: 100%;
            border-radius: 8px;
            overflow: hidden;
            max-height: 200px;
        }

        .interaction-photo img {
            width: 100%;
            object-fit: cover;
        }

        .growth-chart {
            padding: 16px 0;
        }

        .chart-line {
            position: relative;
            height: 2px;
            background-color: var(--border);
            margin: 40px 0;
        }

        .chart-point {
            position: absolute;
            width: 12px;
            height: 12px;
            background-color: var(--primary);
            border-radius: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            cursor: pointer;
        }

        .chart-point::after {
            content: attr(data-value);
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.8rem;
            white-space: nowrap;
        }

        .chart-point::before {
            content: attr(data-date);
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.7rem;
            color: var(--text-light);
            white-space: nowrap;
        }

        .chart-section-title {
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: var(--text-light);
        }

        .toast {
            position: fixed;
            bottom: 70px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 16px;
            border-radius: 24px;
            font-size: 0.9rem;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .toast.active {
            opacity: 1;
        }

        .loader {
            width: 36px;
            height: 36px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            margin: 20px auto;
            animation: spin 1s infinite linear;
        }

        .image-preview {
            width: 100%;
            height: 200px;
            margin-top: 8px;
            border-radius: var(--radius);
            background-color: var(--primary-light);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .file-input {
            display: none;
        }

        .file-label {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 10px;
            background-color: var(--primary-light);
            color: var(--primary);
            border-radius: var(--radius);
            cursor: pointer;
        }

        .mood-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .mood-grid .toggle-option {
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 12px 8px;
            text-align: center;
            font-size: 0.85rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- Header (動態更新) -->
        <div class="header">
            <div class="header-title">
                <span id="page-title">首頁</span>
            </div>
            <div class="header-action" id="header-action">
                <!-- 動態插入內容 -->
            </div>
        </div>

        <!-- 兒童選擇器 -->
        <div class="container" id="child-selector-container">
            <div class="child-selector" id="child-selector">
                <!-- 動態插入兒童頭像 -->
            </div>
        </div>

        <!-- 主要內容區域 -->
        <div class="container" id="main-content">
            <!-- 內容將由 JavaScript 動態生成 -->
        </div>

        <!-- 導覽列 -->
        <div class="nav-bar">
            <div class="nav-item active" data-page="home">
                <div class="nav-icon">🏠</div>
                <div>首頁</div>
            </div>
            <div class="nav-item" data-page="care">
                <div class="nav-icon">🍼</div>
                <div>照護</div>
            </div>
            <div class="nav-item" data-page="development">
                <div class="nav-icon">📈</div>
                <div>發展</div>
            </div>
            <div class="nav-item" data-page="health">
                <div class="nav-icon">💊</div>
                <div>健康</div>
            </div>
            <div class="nav-item" data-page="settings">
                <div class="nav-icon">⚙️</div>
                <div>設定</div>
            </div>
        </div>
    </div>

    <!-- 模態框 -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modal-title">標題</div>
                <button class="modal-close" id="modal-close">×</button>
            </div>
            <div class="modal-body" id="modal-body">
                <!-- 模態內容將由 JavaScript 動態生成 -->
            </div>
        </div>
    </div>

    <!-- 吐司提示 -->
    <div class="toast" id="toast"></div>

    <script>
        // 嬰幼兒照護追蹤系統 - 主要程式碼

        // 初始化 IndexedDB
        let db;
        const DB_NAME = 'BabyCareDB';
        const DB_VERSION = 1;
        
        // 當前選中的孩子 ID 及頁面
        let currentChildId = null;
        let currentPage = 'home';

        // 定義 IndexedDB 架構
        function initDB() {
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            
            request.onerror = (event) => {
                showToast('資料庫連接失敗');
                console.error('IndexedDB 錯誤:', event.target.error);
            };
            
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                
                // 孩子資料表
                if (!db.objectStoreNames.contains('children')) {
                    const childrenStore = db.createObjectStore('children', { keyPath: 'id' });
                    childrenStore.createIndex('name', 'name', { unique: false });
                }
                
                // 餵食紀錄表
                if (!db.objectStoreNames.contains('feeding')) {
                    const feedingStore = db.createObjectStore('feeding', { keyPath: 'id', autoIncrement: true });
                    feedingStore.createIndex('childId', 'childId', { unique: false });
                    feedingStore.createIndex('timestamp', 'timestamp', { unique: false });
                }
                
                // 睡眠紀錄表
                if (!db.objectStoreNames.contains('sleep')) {
                    const sleepStore = db.createObjectStore('sleep', { keyPath: 'id', autoIncrement: true });
                    sleepStore.createIndex('childId', 'childId', { unique: false });
                    sleepStore.createIndex('timestamp', 'timestamp', { unique: false });
                }
                
                // 尿布紀錄表
                if (!db.objectStoreNames.contains('diaper')) {
                    const diaperStore = db.createObjectStore('diaper', { keyPath: 'id', autoIncrement: true });
                    diaperStore.createIndex('childId', 'childId', { unique: false });
                    diaperStore.createIndex('timestamp', 'timestamp', { unique: false });
                }
                
                // 發展里程碑表
                if (!db.objectStoreNames.contains('milestones')) {
                    const milestonesStore = db.createObjectStore('milestones', { keyPath: 'id', autoIncrement: true });
                    milestonesStore.createIndex('childId', 'childId', { unique: false });
                    milestonesStore.createIndex('category', 'category', { unique: false });
                }
                
                // 活動紀錄表
                if (!db.objectStoreNames.contains('activities')) {
                    const activitiesStore = db.createObjectStore('activities', { keyPath: 'id', autoIncrement: true });
                    activitiesStore.createIndex('childId', 'childId', { unique: false });
                    activitiesStore.createIndex('timestamp', 'timestamp', { unique: false });
                    activitiesStore.createIndex('type', 'type', { unique: false });
                }
                
                // 健康紀錄表
                if (!db.objectStoreNames.contains('health')) {
                    const healthStore = db.createObjectStore('health', { keyPath: 'id', autoIncrement: true });
                    healthStore.createIndex('childId', 'childId', { unique: false });
                    healthStore.createIndex('timestamp', 'timestamp', { unique: false });
                    healthStore.createIndex('type', 'type', { unique: false });
                }
                
                // 親子互動表
                if (!db.objectStoreNames.contains('interactions')) {
                    const interactionsStore = db.createObjectStore('interactions', { keyPath: 'id', autoIncrement: true });
                    interactionsStore.createIndex('childId', 'childId', { unique: false });
                    interactionsStore.createIndex('timestamp', 'timestamp', { unique: false });
                }
            };
            
            request.onsuccess = (event) => {
                db = event.target.result;
                console.log('IndexedDB 連接成功');
                
                // 檢查是否已有小孩資料，如果沒有則顯示初始設定畫面
                checkAndInitializeApp();
            };
        }

        // 檢查是否已有資料並初始化應用程式
        function checkAndInitializeApp() {
            const transaction = db.transaction(['children'], 'readonly');
            const childrenStore = transaction.objectStore('children');
            const countRequest = childrenStore.count();
            
            countRequest.onsuccess = () => {
                if (countRequest.result === 0) {
                    // 沒有孩子資料，顯示歡迎畫面
                    showWelcomeScreen();
                } else {
                    // 已有孩子資料，載入第一個孩子的資料
                    loadChildrenSelector();
                }
            };
        }

        // 顯示歡迎/初始設定畫面
        function showWelcomeScreen() {
            document.getElementById('page-title').textContent = '寶寶照護筆記';
            document.getElementById('child-selector-container').style.display = 'none';
            
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">歡迎使用寶寶照護筆記</div>
                    </div>
                    <div class="card-content">
                        <p>這是一款專為台灣父母設計的嬰幼兒照護追蹤系統，幫助您簡單地記錄寶寶的成長歷程。</p>
                        <div class="empty-state">
                            <div class="empty-icon">👶</div>
                            <div class="empty-text">開始前，請先新增您的寶寶資料</div>
                        </div>
                    </div>
                    <button class="btn" style="width: 100%;" id="add-first-child-btn">新增寶寶資料</button>
                </div>
            `;
            
            // 綁定新增第一個孩子按鈕事件
            document.getElementById('add-first-child-btn').addEventListener('click', () => {
                showAddChildModal();
            });
        }

        // 顯示新增孩子彈窗
        function showAddChildModal() {
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            
            modalTitle.textContent = '新增寶寶資料';
            modalBody.innerHTML = `
                <form id="add-child-form">
                    <div class="form-group">
                        <label class="form-label">寶寶暱稱</label>
                        <input type="text" class="form-control" id="child-name" placeholder="例：小寶" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">性別</label>
                        <div class="toggle-group">
                            <div class="toggle-option" data-value="男">男寶寶</div>
                            <div class="toggle-option" data-value="女">女寶寶</div>
                            <div class="toggle-option" data-value="其他">其他</div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">出生日期</label>
                        <input type="date" class="form-control" id="child-birthdate" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">上傳頭像</label>
                        <input type="file" id="child-avatar" class="file-input" accept="image/*">
                        <label for="child-avatar" class="file-label">選擇照片</label>
                        <div id="avatar-preview" class="image-preview" style="display: none;">
                            <img id="avatar-image" src="" alt="預覽">
                        </div>
                    </div>
                    <button type="submit" class="btn" style="width: 100%;">儲存</button>
                </form>
            `;
            
            // 性別選擇切換
            const toggleOptions = modalBody.querySelectorAll('.toggle-option');
            let selectedGender = null;
            
            toggleOptions.forEach(option => {
                option.addEventListener('click', () => {
                    toggleOptions.forEach(opt => opt.classList.remove('active'));
                    option.classList.add('active');
                    selectedGender = option.dataset.value;
                });
            });
            
            // 頭像預覽
            const avatarInput = document.getElementById('child-avatar');
            const avatarPreview = document.getElementById('avatar-preview');
            const avatarImage = document.getElementById('avatar-image');
            
            avatarInput.addEventListener('change', (e) => {
                if (e.target.files && e.target.files[0]) {
                    const reader = new FileReader();
                    
                    reader.onload = (e) => {
                        avatarImage.src = e.target.result;
                        avatarPreview.style.display = 'block';
                    };
                    
                    reader.readAsDataURL(e.target.files[0]);
                }
            });
            
            // 表單提交
            const form = document.getElementById('add-child-form');
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const name = document.getElementById('child-name').value.trim();
                const birthdate = document.getElementById('child-birthdate').value;
                
                if (!name || !birthdate || !selectedGender) {
                    showToast('請填寫所有欄位');
                    return;
                }
                
                // 新增孩子資料到 IndexedDB
                const childData = {
                    id: generateId(),
                    name: name,
                    gender: selectedGender,
                    birthdate: birthdate,
                    createdAt: new Date().toISOString(),
                    avatar: avatarImage.src || null
                };
                
                addChild(childData);
            });
            
            openModal();
        }

        // 新增孩子到資料庫
        function addChild(childData) {
            const transaction = db.transaction(['children'], 'readwrite');
            const childrenStore = transaction.objectStore('children');
            
            const request = childrenStore.add(childData);
            
            request.onsuccess = () => {
                showToast('成功新增寶寶資料');
                closeModal();
                
                // 預設選中新增的孩子
                currentChildId = childData.id;
                
                // 產生預設里程碑資料
                generateDefaultMilestones(childData.id);
                
                // 刷新孩子選擇器
                loadChildrenSelector();
                
                // 顯示儀表板
                updatePage('home');
            };
            
            request.onerror = () => {
                showToast('新增寶寶資料失敗');
            };
        }

        // 產生預設里程碑資料 (擴充版)
        function generateDefaultMilestones(childId) {
            const defaultMilestones = [
                // 動作發展里程碑 (motor)
                { childId, category: 'motor', title: '能抬頭', ageMonths: 1, completed: false, description: '趴著時能抬頭45度角' },
                { childId, category: 'motor', title: '能頭部平穩', ageMonths: 3, completed: false, description: '豎抱時頭部能保持平穩' },
                { childId, category: 'motor', title: '翻身(趴翻仰)', ageMonths: 4, completed: false, description: '能從趴姿翻轉為仰躺' },
                { childId, category: 'motor', title: '翻身(仰翻趴)', ageMonths: 5, completed: false, description: '能從仰躺翻轉為趴姿' },
                { childId, category: 'motor', title: '獨坐', ageMonths: 6, completed: false, description: '能不支撐獨自坐立片刻' },
                { childId, category: 'motor', title: '穩坐', ageMonths: 7, completed: false, description: '能穩定獨坐較長時間' },
                { childId, category: 'motor', title: '爬行', ageMonths: 8, completed: false, description: '能有效爬行移動' },
                { childId, category: 'motor', title: '扶站', ageMonths: 9, completed: false, description: '能扶著物體站立' },
                { childId, category: 'motor', title: '扶走', ageMonths: 10, completed: false, description: '能扶著物體走路' },
                { childId, category: 'motor', title: '獨站', ageMonths: 11, completed: false, description: '能不扶物短暫獨立站立' },
                { childId, category: 'motor', title: '獨走', ageMonths: 12, completed: false, description: '能獨立走幾步' },
                { childId, category: 'motor', title: '穩定走路', ageMonths: 15, completed: false, description: '能穩定走路較長距離' },
                { childId, category: 'motor', title: '蹲下再站起', ageMonths: 18, completed: false, description: '能獨立蹲下拿東西再站起' },
                { childId, category: 'motor', title: '上下樓梯', ageMonths: 24, completed: false, description: '能扶著扶手上下樓梯' },
                { childId, category: 'motor', title: '跳躍', ageMonths: 30, completed: false, description: '能雙腳跳躍' },
                
                // 語言能力里程碑 (language)
                { childId, category: 'language', title: '咕咕聲', ageMonths: 2, completed: false, description: '能發出咕咕聲回應' },
                { childId, category: 'language', title: '笑聲', ageMonths: 3, completed: false, description: '能發出笑聲' },
                { childId, category: 'language', title: '牙牙學語', ageMonths: 6, completed: false, description: '能發出連續音節如"爸爸媽媽"' },
                { childId, category: 'language', title: '模仿聲音', ageMonths: 9, completed: false, description: '能嘗試模仿大人說話的聲音' },
                { childId, category: 'language', title: '理解詞意', ageMonths: 10, completed: false, description: '懂得"不要"、"再見"等常用詞' },
                { childId, category: 'language', title: '第一個詞', ageMonths: 12, completed: false, description: '能有意義地說出第一個詞' },
                { childId, category: 'language', title: '詞彙增加', ageMonths: 15, completed: false, description: '能說出5-10個有意義的詞語' },
                { childId, category: 'language', title: '兩字組合', ageMonths: 18, completed: false, description: '能用兩個詞語組合表達意思' },
                { childId, category: 'language', title: '簡單句子', ageMonths: 24, completed: false, description: '能說出簡單的句子' },
                { childId, category: 'language', title: '複雜對話', ageMonths: 36, completed: false, description: '能進行簡單的對話交流' },
                
                // 社交能力里程碑 (social)
                { childId, category: 'social', title: '社交性微笑', ageMonths: 2, completed: false, description: '能對人表現出社交性的微笑' },
                { childId, category: 'social', title: '回應名字', ageMonths: 4, completed: false, description: '聽到名字時會有反應' },
                { childId, category: 'social', title: '害怕陌生人', ageMonths: 6, completed: false, description: '對陌生人表現出不安或害怕' },
                { childId, category: 'social', title: '玩躲貓貓', ageMonths: 7, completed: false, description: '喜歡參與躲貓貓等互動遊戲' },
                { childId, category: 'social', title: '模仿動作', ageMonths: 9, completed: false, description: '會模仿大人的簡單動作' },
                { childId, category: 'social', title: '揮手再見', ageMonths: 10, completed: false, description: '會揮手表示再見' },
                { childId, category: 'social', title: '展示物品', ageMonths: 12, completed: false, description: '主動向他人展示自己的物品' },
                { childId, category: 'social', title: '幫忙收拾', ageMonths: 15, completed: false, description: '願意參與簡單的家務活動' },
                { childId, category: 'social', title: '平行遊戲', ageMonths: 18, completed: false, description: '能在其他孩子旁邊玩耍(但不一定互動)' },
                { childId, category: 'social', title: '輪流玩', ageMonths: 24, completed: false, description: '能理解輪流的概念' },
                { childId, category: 'social', title: '合作遊戲', ageMonths: 36, completed: false, description: '能與其他孩子合作玩耍' },
                
                // 認知發展里程碑 (cognitive)
                { childId, category: 'cognitive', title: '目光追蹤', ageMonths: 1, completed: false, description: '能用目光追蹤移動中的物體' },
                { childId, category: 'cognitive', title: '認識熟人', ageMonths: 3, completed: false, description: '能認出熟悉的人' },
                { childId, category: 'cognitive', title: '尋找物體', ageMonths: 5, completed: false, description: '會尋找部分隱藏的物體' },
                { childId, category: 'cognitive', title: '因果關係', ageMonths: 7, completed: false, description: '理解簡單的因果關係，如按鈕發聲' },
                { childId, category: 'cognitive', title: '物體恆存', ageMonths: 8, completed: false, description: '理解看不見的物體仍然存在' },
                { childId, category: 'cognitive', title: '指物', ageMonths: 11, completed: false, description: '用手指向想要的物體' },
                { childId, category: 'cognitive', title: '功能理解', ageMonths: 14, completed: false, description: '理解物品的基本功能，如杯子用來喝水' },
                { childId, category: 'cognitive', title: '符號使用', ageMonths: 18, completed: false, description: '使用物體代表其他事物進行象徵性遊戲' },
                { childId, category: 'cognitive', title: '配對分類', ageMonths: 24, completed: false, description: '能按形狀或顏色進行簡單分類' },
                { childId, category: 'cognitive', title: '數量概念', ageMonths: 30, completed: false, description: '理解"多"和"少"的區別' },
                { childId, category: 'cognitive', title: '顏色辨識', ageMonths: 36, completed: false, description: '能正確辨認並命名主要顏色' },
                
                // 情緒發展里程碑 (emotional)
                { childId, category: 'emotional', title: '表達不適', ageMonths: 0, completed: false, description: '能用哭聲表達不適或需求' },
                { childId, category: 'emotional', title: '情緒分化', ageMonths: 3, completed: false, description: '表現出不同情緒如高興、生氣' },
                { childId, category: 'emotional', title: '自我安撫', ageMonths: 6, completed: false, description: '能用吸手指等方式自我安撫' },
                { childId, category: 'emotional', title: '分離焦慮', ageMonths: 8, completed: false, description: '父母離開時表現出不安' },
                { childId, category: 'emotional', title: '情緒參照', ageMonths: 10, completed: false, description: '通過觀察成人反應調整自己行為' },
                { childId, category: 'emotional', title: '情緒表達', ageMonths: 15, completed: false, description: '能明確表達自己的情緒需求' },
                { childId, category: 'emotional', title: '情緒辨識', ageMonths: 24, completed: false, description: '能辨認他人的基本情緒' },
                { childId, category: 'emotional', title: '情緒控制', ageMonths: 36, completed: false, description: '開始學習控制情緒表達' },
                
                // 自理能力里程碑 (self-help)
                { childId, category: 'self-help', title: '吸允', ageMonths: 0, completed: false, description: '能有效吸允' },
                { childId, category: 'self-help', title: '自己拿物', ageMonths: 5, completed: false, description: '能自己抓取小物品' },
                { childId, category: 'self-help', title: '用杯喝水', ageMonths: 9, completed: false, description: '能扶著杯子喝水' },
                { childId, category: 'self-help', title: '用湯匙', ageMonths: 12, completed: false, description: '能嘗試用湯匙進食' },
                { childId, category: 'self-help', title: '脫簡單衣物', ageMonths: 18, completed: false, description: '能脫掉簡單的衣物如襪子' },
                { childId, category: 'self-help', title: '便盆訓練', ageMonths: 24, completed: false, description: '開始進行便盆訓練，表現出上廁所意識' },
                { childId, category: 'self-help', title: '自己穿衣', ageMonths: 30, completed: false, description: '能穿上簡單的衣物' },
                { childId, category: 'self-help', title: '如廁自理', ageMonths: 36, completed: false, description: '大部分時間能自己如廁' }
            ];
            
            const transaction = db.transaction(['milestones'], 'readwrite');
            const milestonesStore = transaction.objectStore('milestones');
            
            defaultMilestones.forEach(milestone => {
                milestonesStore.add(milestone);
            });
        }

        // 載入孩子選擇器
        function loadChildrenSelector() {
            const transaction = db.transaction(['children'], 'readonly');
            const childrenStore = transaction.objectStore('children');
            const request = childrenStore.getAll();
            
            request.onsuccess = () => {
                const children = request.result;
                
                if (children.length > 0) {
                    document.getElementById('child-selector-container').style.display = 'block';
                    
                    const childSelector = document.getElementById('child-selector');
                    childSelector.innerHTML = '';
                    
                    children.forEach(child => {
                        const childAvatar = document.createElement('div');
                        childAvatar.className = 'child-avatar';
                        childAvatar.dataset.childId = child.id;
                        
                        if (child.avatar) {
                            childAvatar.innerHTML = `<img src="${child.avatar}" alt="${child.name}">`;
                        } else {
                            // 如果沒有頭像，顯示首字母
                            const initial = child.name.charAt(0);
                            const backgroundColor = child.gender === '男' ? 'var(--primary-light)' : 
                                                  child.gender === '女' ? 'var(--secondary-light)' : 'var(--tertiary-light)';
                            const textColor = child.gender === '男' ? 'var(--primary)' : 
                                            child.gender === '女' ? 'var(--secondary)' : 'var(--tertiary)';
                            
                            childAvatar.style.backgroundColor = backgroundColor;
                            childAvatar.style.color = textColor;
                            childAvatar.textContent = initial;
                        }
                        
                        if (!currentChildId) {
                            currentChildId = child.id;
                            childAvatar.classList.add('active');
                        } else if (child.id === currentChildId) {
                            childAvatar.classList.add('active');
                        }
                        
                        childAvatar.addEventListener('click', () => {
                            document.querySelectorAll('.child-avatar').forEach(avatar => {
                                avatar.classList.remove('active');
                            });
                            childAvatar.classList.add('active');
                            currentChildId = child.id;
                            
                            // 重新載入當前頁面
                            updatePage(currentPage);
                        });
                        
                        childSelector.appendChild(childAvatar);
                    });
                    
                    // 如果孩子數量少於 4 個，顯示新增按鈕
                    if (children.length < 4) {
                        const addButton = document.createElement('div');
                        addButton.className = 'child-avatar add-child';
                        addButton.textContent = '+';
                        addButton.addEventListener('click', () => {
                            showAddChildModal();
                        });
                        
                        childSelector.appendChild(addButton);
                    }
                    
                    // 確保有選中的孩子
                    if (!currentChildId && children.length > 0) {
                        currentChildId = children[0].id;
                    }
                    
                    // 載入首頁內容
                    updatePage('home');
                } else {
                    // 如果沒有孩子資料，顯示歡迎畫面
                    showWelcomeScreen();
                }
            };
        }

        // 產生唯一 ID
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        }

        // 顯示吐司提示
        function showToast(message, duration = 2000) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('active');
            
            setTimeout(() => {
                toast.classList.remove('active');
            }, duration);
        }

        // 開啟模態框
        function openModal() {
            document.getElementById('modal').classList.add('active');
        }

        // 關閉模態框
        function closeModal() {
            document.getElementById('modal').classList.remove('active');
        }

        // 情緒相關工具函數
        function getMoodEmoji(mood) {
            const moodMap = {
                'happy': '😄',
                'excited': '🤩',
                'calm': '😊',
                'sleepy': '😴',
                'curious': '🤔',
                'playful': '😆',
                'sad': '😢',
                'angry': '😠'
            };
            return moodMap[mood] || '😊';
        }

        function getMoodText(mood) {
            const moodMap = {
                'happy': '開心',
                'excited': '興奮',
                'calm': '平靜',
                'sleepy': '想睡',
                'curious': '好奇',
                'playful': '愛玩',
                'sad': '難過',
                'angry': '生氣'
            };
            return moodMap[mood] || '平靜';
        }

        // 更新頁面內容
        function updatePage(page) {
            currentPage = page;
            
            // 更新導覽列選中狀態
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`.nav-item[data-page="${page}"]`).classList.add('active');
            
            // 更新頁面標題
            const pageTitles = {
                'home': '首頁',
                'care': '照護',
                'development': '發展',
                'health': '健康',
                'settings': '設定'
            };
            document.getElementById('page-title').textContent = pageTitles[page];
            
            // 更新頁面操作按鈕
            const headerAction = document.getElementById('header-action');
            headerAction.innerHTML = '';
            
            // 載入對應頁面內容
            if (currentChildId) {
                switch (page) {
                    case 'home':
                        loadHomePage();
                        break;
                    case 'care':
                        loadCarePage();
                        break;
                    case 'development':
                        loadDevelopmentPage();
                        break;
                    case 'health':
                        loadHealthPage();
                        break;
                    case 'settings':
                        loadSettingsPage();
                        break;
                }
            }
        }

        // 載入首頁
        function loadHomePage() {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = '<div class="loader"></div>';
            
            // 獲取今日的開始和結束時間
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            // 獲取目前選取的寶寶資料
            getChildById(currentChildId, (child) => {
                // 計算年齡
                const birthDate = new Date(child.birthdate);
                const ageInMonths = Math.floor((today - birthDate) / (1000 * 60 * 60 * 24 * 30.44));
                const ageYears = Math.floor(ageInMonths / 12);
                const ageMonths = ageInMonths % 12;
                const ageString = ageYears > 0 
                    ? `${ageYears}歲${ageMonths}個月` 
                    : `${ageMonths}個月`;
                
                // 獲取今日餵食次數
                getTodayRecordsCount('feeding', (feedingCount) => {
                    // 獲取今日睡眠時數
                    getTodaySleepHours((sleepHours) => {
                        // 獲取今日尿布次數
                        getTodayRecordsCount('diaper', (diaperCount) => {
                            // 設定頁面內容
                            mainContent.innerHTML = `
                                <div class="card">
                                    <div class="card-header">
                                        <div class="card-title">
                                            <span>${child.name}</span>
                                            <span style="font-size: 0.8rem; color: var(--text-light); font-weight: normal; margin-left: 8px;">${ageString}</span>
                                        </div>
                                        <div>
                                            <span style="font-size: 0.8rem;">${formatDate(today, true)}</span>
                                        </div>
                                    </div>
                                    <div class="card-content">
                                        <div class="overview-grid">
                                            <div class="overview-item feeding">
                                                <div class="overview-number">${feedingCount}</div>
                                                <div class="overview-label">餵食次數</div>
                                            </div>
                                            <div class="overview-item sleep">
                                                <div class="overview-number">${sleepHours.toFixed(1)}</div>
                                                <div class="overview-label">睡眠小時</div>
                                            </div>
                                            <div class="overview-item diaper">
                                                <div class="overview-number">${diaperCount}</div>
                                                <div class="overview-label">尿布更換</div>
                                            </div>
                                        </div>
                                        
                                        <div class="quick-actions">
                                            <button class="action-btn" id="quick-feeding">
                                                <span>🍼</span>
                                                <span>記錄餵食</span>
                                            </button>
                                            <button class="action-btn" id="quick-sleep">
                                                <span>😴</span>
                                                <span>記錄睡眠</span>
                                            </button>
                                            <button class="action-btn" id="quick-diaper">
                                                <span>🧷</span>
                                                <span>記錄尿布</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="card">
                                    <div class="card-header">
                                        <div class="card-title">今日紀錄</div>
                                    </div>
                                    <div class="records-list" id="today-records">
                                        <div class="loader"></div>
                                    </div>
                                </div>
                                
                                <div class="card">
                                    <div class="card-header">
                                        <div class="card-title">近期發展里程碑</div>
                                    </div>
                                    <div id="upcoming-milestones">
                                        <div class="loader"></div>
                                    </div>
                                </div>
                            `;
                            
                            // 綁定快速操作按鈕
                            document.getElementById('quick-feeding').addEventListener('click', () => {
                                showAddFeedingModal();
                            });
                            
                            document.getElementById('quick-sleep').addEventListener('click', () => {
                                showAddSleepModal();
                            });
                            
                            document.getElementById('quick-diaper').addEventListener('click', () => {
                                showAddDiaperModal();
                            });
                            
                            // 載入今日紀錄
                            loadTodayRecords();
                            
                            // 載入即將到來的里程碑
                            loadUpcomingMilestones(ageInMonths);
                        });
                    });
                });
            });
        }

        // 載入今日紀錄
        function loadTodayRecords() {
            const todayRecordsElement = document.getElementById('today-records');
            
            // 獲取今日的開始和結束時間
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            // 獲取所有類型的紀錄
            const recordTypes = ['feeding', 'sleep', 'diaper', 'activities', 'health', 'interactions'];
            let allRecords = [];
            let loadedTypesCount = 0;
            
            recordTypes.forEach(type => {
                getRecordsBetweenDates(type, today, tomorrow, (records) => {
                    allRecords = allRecords.concat(records.map(record => ({...record, type})));
                    loadedTypesCount++;
                    
                    if (loadedTypesCount === recordTypes.length) {
                        // 排序所有紀錄（從新到舊）
                        allRecords.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                        
                        if (allRecords.length === 0) {
                            todayRecordsElement.innerHTML = `
                                <div class="empty-state">
                                    <div class="empty-text">今天還沒有紀錄</div>
                                </div>
                            `;
                        } else {
                            // 顯示紀錄
                            todayRecordsElement.innerHTML = '';
                            
                            allRecords.forEach(record => {
                                const recordItem = document.createElement('div');
                                recordItem.className = 'record-item';
                                
                                let recordContent = '';
                                let recordIcon = '';
                                
                                switch (record.type) {
                                    case 'feeding':
                                        recordIcon = '🍼';
                                        recordContent = `
                                            <div class="record-details">
                                                <span class="record-tag">${record.method === 'breastfeeding' ? '母乳' : 
                                                                           record.method === 'formula' ? '配方奶' : '副食品'}</span>
                                                ${record.method === 'breastfeeding' ? 
                                                  `<span class="record-tag">${record.side === 'left' ? '左側' : '右側'}</span>` : ''}
                                                ${record.amount ? `<span class="record-tag">${record.amount} ml</span>` : ''}
                                            </div>
                                        `;
                                        break;
                                    case 'sleep':
                                        recordIcon = '😴';
                                        recordContent = `
                                            <div class="record-details">
                                                <span class="record-tag">${record.duration} 分鐘</span>
                                                <span class="record-tag">${record.quality === 'good' ? '安穩' : 
                                                                           record.quality === 'normal' ? '普通' : '不佳'}</span>
                                            </div>
                                        `;
                                        break;
                                    case 'diaper':
                                        recordIcon = '🧷';
                                        recordContent = `
                                            <div class="record-details">
                                                <span class="record-tag">${record.type === 'wet' ? '尿布' : 
                                                                           record.type === 'dirty' ? '便便' : '混合'}</span>
                                                ${record.note ? `<span class="record-tag">${record.note}</span>` : ''}
                                            </div>
                                        `;
                                        break;
                                    case 'activities':
                                        recordIcon = '🎯';
                                        recordContent = `
                                            <div class="record-details">
                                                <span class="record-tag">${record.type}</span>
                                                ${record.duration ? `<span class="record-tag">${record.duration} 分鐘</span>` : ''}
                                            </div>
                                        `;
                                        break;
                                    case 'health':
                                        recordIcon = '💊';
                                        
                                        if (record.type === 'temperature') {
                                            let tempStatus = '';
                                            let tempColor = '';
                                            if (record.value >= 38) {
                                                tempStatus = '發燒';
                                                tempColor = '#ff6b6b';
                                            } else if (record.value >= 37.5) {
                                                tempStatus = '微燒';
                                                tempColor = '#ffa500';
                                            } else if (record.value < 36) {
                                                tempStatus = '偏低';
                                                tempColor = '#6bb6ff';
                                            } else {
                                                tempStatus = '正常';
                                                tempColor = '#51cf66';
                                            }
                                            
                                            recordContent = `
                                                <div class="record-details">
                                                    <span class="record-tag">體溫</span>
                                                    <span class="record-tag" style="background-color: ${tempColor}; color: white;">
                                                        ${record.value}°C ${tempStatus}
                                                    </span>
                                                </div>
                                            `;
                                        } else if (record.type === 'weight') {
                                            recordContent = `
                                                <div class="record-details">
                                                    <span class="record-tag">體重</span>
                                                    <span class="record-tag">${record.value} kg</span>
                                                </div>
                                            `;
                                        } else if (record.type === 'height') {
                                            recordContent = `
                                                <div class="record-details">
                                                    <span class="record-tag">身高</span>
                                                    <span class="record-tag">${record.value} cm</span>
                                                </div>
                                            `;
                                        } else if (record.type === 'vaccine') {
                                            recordContent = `
                                                <div class="record-details">
                                                    <span class="record-tag">疫苗</span>
                                                    <span class="record-tag">${record.name}</span>
                                                </div>
                                            `;
                                        } else if (record.type === 'medication') {
                                            recordContent = `
                                                <div class="record-details">
                                                    <span class="record-tag">用藥</span>
                                                    <span class="record-tag">${record.name}</span>
                                                </div>
                                            `;
                                        }
                                        break;
                                    case 'interactions':
                                        recordIcon = '👨‍👩‍👧';
                                        
                                        const moodEmoji = getMoodEmoji(record.mood);
                                        const moodText = getMoodText(record.mood);
                                        
                                        recordContent = `
                                            <div class="record-details">
                                                <span class="record-tag">${moodEmoji} ${moodText}</span>
                                            </div>
                                            ${record.note ? `<div style="font-size: 0.9rem; margin-top: 4px;">${record.note}</div>` : ''}
                                            ${record.photoData ? `
                                                <div class="interaction-photo">
                                                    <img src="${record.photoData}" alt="互動照片">
                                                </div>` : ''}
                                        `;
                                        break;
                                }
                                
                                recordItem.innerHTML = `
                                    <div style="display: flex; align-items: flex-start; gap: 10px; width: 100%;">
                                        <div style="font-size: 1.2rem;">${recordIcon}</div>
                                        <div class="record-main" style="flex-grow: 1;">
                                            <div class="record-time">${formatTime(new Date(record.timestamp))}</div>
                                            ${recordContent}
                                        </div>
                                    </div>
                                `;
                                
                                todayRecordsElement.appendChild(recordItem);
                            });
                        }
                    }
                });
            });
        }

        // 載入即將到來的里程碑
        function loadUpcomingMilestones(currentAgeMonths) {
            const upcomingMilestonesElement = document.getElementById('upcoming-milestones');
            
            const transaction = db.transaction(['milestones'], 'readonly');
            const milestonesStore = transaction.objectStore('milestones');
            const index = milestonesStore.index('childId');
            const range = IDBKeyRange.only(currentChildId);
            const request = index.openCursor(range);
            
            let milestones = [];
            
            request.onsuccess = (event) => {
                const cursor = event.target.result;
                
                if (cursor) {
                    milestones.push(cursor.value);
                    cursor.continue();
                } else {
                    // 過濾未完成且年齡接近的里程碑（±3個月）
                    const relevantMilestones = milestones.filter(m => 
                        !m.completed && 
                        Math.abs(m.ageMonths - currentAgeMonths) <= 3
                    );
                    
                    // 排序（先顯示較即將到來的）
                    relevantMilestones.sort((a, b) => Math.abs(a.ageMonths - currentAgeMonths) - Math.abs(b.ageMonths - currentAgeMonths));
                    
                    if (relevantMilestones.length === 0) {
                        upcomingMilestonesElement.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-text">目前沒有近期里程碑</div>
                            </div>
                        `;
                    } else {
                        upcomingMilestonesElement.innerHTML = '';
                        
                        // 只顯示最多 3 個
                        relevantMilestones.slice(0, 3).forEach(milestone => {
                            const monthDiff = milestone.ageMonths - currentAgeMonths;
                            let timeDescription = '';
                            
                            if (monthDiff > 0) {
                                timeDescription = `約 ${monthDiff} 個月後`;
                            } else if (monthDiff < 0) {
                                timeDescription = `已延遲 ${Math.abs(monthDiff)} 個月`;
                            } else {
                                timeDescription = '現在適合的時間';
                            }
                            
                            const milestoneItem = document.createElement('div');
                            milestoneItem.className = 'milestone-item';
                            milestoneItem.dataset.id = milestone.id;
                            
                            milestoneItem.innerHTML = `
                                <div class="milestone-header">
                                    <div>${milestone.title}</div>
                                    <div class="milestone-age">${milestone.ageMonths} 個月</div>
                                </div>
                                <div style="font-size: 0.8rem; color: var(--text-light);">${timeDescription}</div>
                                ${milestone.description ? `<div style="font-size: 0.85rem; margin-top: 6px;">${milestone.description}</div>` : ''}
                            `;
                            
                            // 點擊里程碑切換完成狀態
                            milestoneItem.addEventListener('click', () => {
                                toggleMilestoneStatus(milestone.id);
                            });
                            
                            upcomingMilestonesElement.appendChild(milestoneItem);
                        });
                    }
                }
            };
        }

        // 切換里程碑完成狀態
        function toggleMilestoneStatus(milestoneId) {
            const transaction = db.transaction(['milestones'], 'readwrite');
            const milestonesStore = transaction.objectStore('milestones');
            const request = milestonesStore.get(milestoneId);
            
            request.onsuccess = () => {
                const milestone = request.result;
                milestone.completed = !milestone.completed;
                
                milestonesStore.put(milestone);
                
                // 更新 UI
                const milestoneItem = document.querySelector(`.milestone-item[data-id="${milestoneId}"]`);
                
                if (milestoneItem) {
                    if (milestone.completed) {
                        milestoneItem.classList.add('completed');
                        milestoneItem.innerHTML += `<div class="checkmark">✓ 已完成</div>`;
                        
                        // 顯示祝賀提示
                        showToast('太棒了！里程碑已完成');
                    } else {
                        milestoneItem.classList.remove('completed');
                        const checkmark = milestoneItem.querySelector('.checkmark');
                        if (checkmark) {
                            checkmark.remove();
                        }
                    }
                }
            };
        }

        // 載入照護頁面
        function loadCarePage() {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <div class="tabs">
                    <div class="tab active" data-tab="feeding">餵食</div>
                    <div class="tab" data-tab="sleep">睡眠</div>
                    <div class="tab" data-tab="diaper">尿布</div>
                </div>
                
                <div class="tab-content active" id="feeding-content">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">餵食記錄</div>
                            <button class="btn-icon" id="add-feeding-btn">+</button>
                        </div>
                        <div class="card-content">
                            <div class="stat-chart" id="feeding-chart">
                                <!-- 餵食統計圖表 -->
                            </div>
                            
                            <div class="mini-stat">
                                <div>今日次數</div>
                                <div class="mini-stat-value" id="feeding-count">-</div>
                            </div>
                            
                            <div class="mini-stat">
                                <div>平均間隔</div>
                                <div class="mini-stat-value" id="feeding-interval">-</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">最近紀錄</div>
                        </div>
                        <div class="records-list" id="feeding-records">
                            <div class="loader"></div>
                        </div>
                    </div>
                </div>
                
                <div class="tab-content" id="sleep-content">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">睡眠計時</div>
                        </div>
                        <div class="card-content">
                            <div class="timer-display" id="sleep-timer">00:00:00</div>
                            <div class="timer-controls">
                                <button class="timer-btn timer-start" id="sleep-timer-start">▶</button>
                                <button class="timer-btn timer-stop" id="sleep-timer-stop" style="display: none;">■</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">睡眠記錄</div>
                            <button class="btn-icon" id="add-sleep-btn">+</button>
                        </div>
                        <div class="card-content">
                            <div class="mini-stat">
                                <div>今日睡眠</div>
                                <div class="mini-stat-value" id="sleep-hours">-</div>
                            </div>
                            
                            <div class="mini-stat">
                                <div>平均品質</div>
                                <div class="mini-stat-value" id="sleep-quality">-</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">最近紀錄</div>
                        </div>
                        <div class="records-list" id="sleep-records">
                            <div class="loader"></div>
                        </div>
                    </div>
                </div>
                
                <div class="tab-content" id="diaper-content">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">尿布記錄</div>
                            <button class="btn-icon" id="add-diaper-btn">+</button>
                        </div>
                        <div class="card-content">
                            <div class="stat-chart" id="diaper-chart">
                                <!-- 尿布統計圖表 -->
                            </div>
                            
                            <div class="mini-stat">
                                <div>今日次數</div>
                                <div class="mini-stat-value" id="diaper-count">-</div>
                            </div>
                            
                            <div class="mini-stat">
                                <div>類型分布</div>
                                <div class="mini-stat-value" id="diaper-types">-</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">最近紀錄</div>
                        </div>
                        <div class="records-list" id="diaper-records">
                            <div class="loader"></div>
                        </div>
                    </div>
                </div>
            `;
            
            // 設定頁籤切換
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    tab.classList.add('active');
                    document.getElementById(`${tab.dataset.tab}-content`).classList.add('active');
                });
            });
            
            // 綁定新增按鈕
            document.getElementById('add-feeding-btn').addEventListener('click', () => {
                showAddFeedingModal();
            });
            
            document.getElementById('add-sleep-btn').addEventListener('click', () => {
                showAddSleepModal();
            });
            
            document.getElementById('add-diaper-btn').addEventListener('click', () => {
                showAddDiaperModal();
            });
            
            // 載入餵食記錄
            loadFeedingRecords();
            
            // 載入睡眠記錄
            loadSleepRecords();
            
            // 載入尿布記錄
            loadDiaperRecords();
            
            // 設定睡眠計時器
            initSleepTimer();
        }

        // 初始化睡眠計時器
        let sleepTimerInterval;
        let sleepTimerStartTime;
        let sleepTimerRunning = false;
        
        function initSleepTimer() {
            const timerDisplay = document.getElementById('sleep-timer');
            const startButton = document.getElementById('sleep-timer-start');
            const stopButton = document.getElementById('sleep-timer-stop');
            
            startButton.addEventListener('click', () => {
                if (!sleepTimerRunning) {
                    sleepTimerStartTime = new Date();
                    sleepTimerRunning = true;
                    
                    sleepTimerInterval = setInterval(() => {
                        const elapsed = new Date() - sleepTimerStartTime;
                        const hours = Math.floor(elapsed / (1000 * 60 * 60));
                        const minutes = Math.floor((elapsed % (1000 * 60 * 60)) / (1000 * 60));
                        const seconds = Math.floor((elapsed % (1000 * 60)) / 1000);
                        
                        timerDisplay.textContent = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                    }, 1000);
                    
                    startButton.style.display = 'none';
                    stopButton.style.display = 'flex';
                }
            });
            
            stopButton.addEventListener('click', () => {
                if (sleepTimerRunning) {
                    clearInterval(sleepTimerInterval);
                    sleepTimerRunning = false;
                    
                    const elapsed = new Date() - sleepTimerStartTime;
                    const minutes = Math.floor(elapsed / (1000 * 60));
                    
                    // 詢問是否儲存睡眠紀錄
                    if (minutes > 0) {
                        const sleepData = {
                            childId: currentChildId,
                            timestamp: sleepTimerStartTime.toISOString(),
                            duration: minutes,
                            quality: 'normal',
                            note: ''
                        };
                        
                        // 儲存睡眠紀錄
                        addRecord('sleep', sleepData, () => {
                            showToast(`已記錄 ${minutes} 分鐘的睡眠`);
                            timerDisplay.textContent = '00:00:00';
                            loadSleepRecords();
                        });
                    }
                    
                    startButton.style.display = 'flex';
                    stopButton.style.display = 'none';
                }
            });
        }

        // 載入餵食記錄
        function loadFeedingRecords() {
            getTodayRecordsCount('feeding', (count) => {
                document.getElementById('feeding-count').textContent = count;
                
                getAverageFeedingInterval((interval) => {
                    document.getElementById('feeding-interval').textContent = interval ? `${interval.toFixed(1)} 小時` : '-';
                    
                    getRecentRecords('feeding', 20, (records) => {
                        renderFeedingRecords(records);
                        renderFeedingChart(records);
                    });
                });
            });
        }

        // 載入睡眠記錄
        function loadSleepRecords() {
            getTodaySleepHours((hours) => {
                document.getElementById('sleep-hours').textContent = `${hours.toFixed(1)} 小時`;
                
                getAverageSleepQuality((quality) => {
                    document.getElementById('sleep-quality').textContent = quality === 'good' ? '良好' : quality === 'normal' ? '普通' : '不佳';
                    
                    getRecentRecords('sleep', 20, (records) => {
                        renderSleepRecords(records);
                    });
                });
            });
        }

        // 載入尿布記錄
        function loadDiaperRecords() {
            getTodayRecordsCount('diaper', (count) => {
                document.getElementById('diaper-count').textContent = count;
                
                getDiaperTypeDistribution((distribution) => {
                    document.getElementById('diaper-types').textContent = 
                        `尿布 ${distribution.wet || 0}、便便 ${distribution.dirty || 0}、混合 ${distribution.mixed || 0}`;
                    
                    getRecentRecords('diaper', 20, (records) => {
                        renderDiaperRecords(records);
                        renderDiaperChart(records);
                    });
                });
            });
        }

        // 渲染餵食記錄
        function renderFeedingRecords(records) {
            const recordsElement = document.getElementById('feeding-records');
            
            if (records.length === 0) {
                recordsElement.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-text">尚無餵食紀錄</div>
                    </div>
                `;
                return;
            }
            
            recordsElement.innerHTML = '';
            
            records.forEach(record => {
                const recordItem = document.createElement('div');
                recordItem.className = 'record-item';
                
                const methodText = record.method === 'breastfeeding' ? '母乳' : 
                                  record.method === 'formula' ? '配方奶' : '副食品';
                
                const sideText = record.method === 'breastfeeding' ? 
                                (record.side === 'left' ? '左側' : '右側') : '';
                
                recordItem.innerHTML = `
                    <div class="record-main">
                        <div class="record-time">${formatDateTime(new Date(record.timestamp))}</div>
                        <div class="record-details">
                            <span class="record-tag">${methodText}</span>
                            ${sideText ? `<span class="record-tag">${sideText}</span>` : ''}
                            ${record.amount ? `<span class="record-tag">${record.amount} ml</span>` : ''}
                        </div>
                    </div>
                    <button class="btn-icon" data-id="${record.id}">×</button>
                `;
                
                // 綁定刪除按鈕
                recordItem.querySelector('.btn-icon').addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteRecord('feeding', record.id, () => {
                        loadFeedingRecords();
                    });
                });
                
                recordsElement.appendChild(recordItem);
            });
        }

        // 渲染餵食統計圖表
        function renderFeedingChart(records) {
            const chartElement = document.getElementById('feeding-chart');
            
            // 若記錄少於 2 筆，不顯示圖表
            if (records.length < 2) {
                chartElement.innerHTML = `
                    <div class="empty-state" style="padding: 10px 0;">
                        <div class="empty-text">資料不足，無法顯示趨勢</div>
                    </div>
                `;
                return;
            }
            
            // 計算過去 7 天每天的餵食次數
            const days = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                days.push({
                    date: date,
                    count: 0
                });
            }
            
            records.forEach(record => {
                const recordDate = new Date(record.timestamp);
                
                for (let day of days) {
                    if (recordDate.toDateString() === day.date.toDateString()) {
                        day.count++;
                        break;
                    }
                }
            });
            
            // 找出最大值，用於計算比例
            const maxCount = Math.max(...days.map(day => day.count));
            
            // 渲染簡易柱狀圖
            chartElement.innerHTML = '';
            
            days.forEach(day => {
                const height = day.count > 0 ? (day.count / maxCount) * 100 : 4;
                
                const bar = document.createElement('div');
                bar.className = 'stat-bar';
                bar.style.height = `${height}%`;
                
                const dayLabel = document.createElement('div');
                dayLabel.className = 'stat-label';
                dayLabel.textContent = formatDayOfWeek(day.date);
                
                bar.appendChild(dayLabel);
                chartElement.appendChild(bar);
            });
        }

        // 渲染睡眠記錄
        function renderSleepRecords(records) {
            const recordsElement = document.getElementById('sleep-records');
            
            if (records.length === 0) {
                recordsElement.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-text">尚無睡眠紀錄</div>
                    </div>
                `;
                return;
            }
            
            recordsElement.innerHTML = '';
            
            records.forEach(record => {
                const recordItem = document.createElement('div');
                recordItem.className = 'record-item';
                
                const qualityText = record.quality === 'good' ? '安穩' : 
                                  record.quality === 'normal' ? '普通' : '不佳';
                
                const hours = Math.floor(record.duration / 60);
                const minutes = record.duration % 60;
                const durationText = hours > 0 ? 
                                    `${hours} 小時 ${minutes} 分鐘` : 
                                    `${minutes} 分鐘`;
                
                recordItem.innerHTML = `
                    <div class="record-main">
                        <div class="record-time">${formatDateTime(new Date(record.timestamp))}</div>
                        <div class="record-details">
                            <span class="record-tag">${durationText}</span>
                            <span class="record-tag">${qualityText}</span>
                        </div>
                    </div>
                    <button class="btn-icon" data-id="${record.id}">×</button>
                `;
                
                // 綁定刪除按鈕
                recordItem.querySelector('.btn-icon').addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteRecord('sleep', record.id, () => {
                        loadSleepRecords();
                    });
                });
                
                recordsElement.appendChild(recordItem);
            });
        }

        // 渲染尿布記錄
        function renderDiaperRecords(records) {
            const recordsElement = document.getElementById('diaper-records');
            
            if (records.length === 0) {
                recordsElement.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-text">尚無尿布紀錄</div>
                    </div>
                `;
                return;
            }
            
            recordsElement.innerHTML = '';
            
            records.forEach(record => {
                const recordItem = document.createElement('div');
                recordItem.className = 'record-item';
                
                const typeText = record.type === 'wet' ? '尿布' : 
                               record.type === 'dirty' ? '便便' : '混合';
                
                recordItem.innerHTML = `
                    <div class="record-main">
                        <div class="record-time">${formatDateTime(new Date(record.timestamp))}</div>
                        <div class="record-details">
                            <span class="record-tag">${typeText}</span>
                            ${record.note ? `<span class="record-tag">${record.note}</span>` : ''}
                        </div>
                    </div>
                    <button class="btn-icon" data-id="${record.id}">×</button>
                `;
                
                // 綁定刪除按鈕
                recordItem.querySelector('.btn-icon').addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteRecord('diaper', record.id, () => {
                        loadDiaperRecords();
                    });
                });
                
                recordsElement.appendChild(recordItem);
            });
        }

        // 渲染尿布統計圖表
        function renderDiaperChart(records) {
            const chartElement = document.getElementById('diaper-chart');
            
            // 若記錄少於 2 筆，不顯示圖表
            if (records.length < 2) {
                chartElement.innerHTML = `
                    <div class="empty-state" style="padding: 10px 0;">
                        <div class="empty-text">資料不足，無法顯示趨勢</div>
                    </div>
                `;
                return;
            }
            
            // 計算過去 7 天每天的尿布次數
            const days = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                days.push({
                    date: date,
                    count: 0
                });
            }
            
            records.forEach(record => {
                const recordDate = new Date(record.timestamp);
                
                for (let day of days) {
                    if (recordDate.toDateString() === day.date.toDateString()) {
                        day.count++;
                        break;
                    }
                }
            });
            
            // 找出最大值，用於計算比例
            const maxCount = Math.max(...days.map(day => day.count));
            
            // 渲染簡易柱狀圖
            chartElement.innerHTML = '';
            
            days.forEach(day => {
                const height = day.count > 0 ? (day.count / maxCount) * 100 : 4;
                
                const bar = document.createElement('div');
                bar.className = 'stat-bar';
                bar.style.height = `${height}%`;
                bar.style.backgroundColor = 'var(--tertiary-light)';
                
                const dayLabel = document.createElement('div');
                dayLabel.className = 'stat-label';
                dayLabel.textContent = formatDayOfWeek(day.date);
                
                bar.appendChild(dayLabel);
                chartElement.appendChild(bar);
            });
        }

        // 顯示新增餵食記錄彈窗
        function showAddFeedingModal() {
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            
            modalTitle.textContent = '新增餵食紀錄';
            modalBody.innerHTML = `
                <form id="add-feeding-form">
                    <div class="form-group">
                        <label class="form-label">餵食類型</label>
                        <div class="toggle-group" id="feeding-method">
                            <div class="toggle-option active" data-value="breastfeeding">母乳</div>
                            <div class="toggle-option" data-value="formula">配方奶</div>
                            <div class="toggle-option" data-value="solid">副食品</div>
                        </div>
                    </div>
                    
                    <div class="form-group" id="breast-side-group">
                        <label class="form-label">哺乳側邊</label>
                        <div class="toggle-group" id="breast-side">
                            <div class="toggle-option active" data-value="left">左側</div>
                            <div class="toggle-option" data-value="right">右側</div>
                        </div>
                    </div>
                    
                    <div class="form-group" id="amount-group" style="display: none;">
                        <label class="form-label">餵食量 (ml)</label>
                        <input type="number" class="form-control" id="feeding-amount" placeholder="例：120">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">時間</label>
                        <input type="datetime-local" class="form-control" id="feeding-time" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">備註</label>
                        <input type="text" class="form-control" id="feeding-note" placeholder="選填">
                    </div>
                    
                    <button type="submit" class="btn" style="width: 100%;">儲存</button>
                </form>
            `;
            
            // 設定預設時間為現在
            document.getElementById('feeding-time').value = formatDateTimeLocal(new Date());
            
            // 餵食類型切換
            const methodOptions = modalBody.querySelectorAll('#feeding-method .toggle-option');
            let selectedMethod = 'breastfeeding';
            
            methodOptions.forEach(option => {
                option.addEventListener('click', () => {
                    methodOptions.forEach(opt => opt.classList.remove('active'));
                    option.classList.add('active');
                    selectedMethod = option.dataset.value;
                    
                    // 根據餵食類型顯示/隱藏相關欄位
                    if (selectedMethod === 'breastfeeding') {
                        document.getElementById('breast-side-group').style.display = 'block';
                        document.getElementById('amount-group').style.display = 'none';
                    } else {
                        document.getElementById('breast-side-group').style.display = 'none';
                        document.getElementById('amount-group').style.display = 'block';
                    }
                });
            });
            
            // 哺乳側邊切換
            const sideOptions = modalBody.querySelectorAll('#breast-side .toggle-option');
            let selectedSide = 'left';
            
            sideOptions.forEach(option => {
                option.addEventListener('click', () => {
                    sideOptions.forEach(opt => opt.classList.remove('active'));
                    option.classList.add('active');
                    selectedSide = option.dataset.value;
                });
            });
            
            // 表單提交
            const form = document.getElementById('add-feeding-form');
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const time = document.getElementById('feeding-time').value;
                const note = document.getElementById('feeding-note').value.trim();
                const amount = document.getElementById('feeding-amount').value;
                
                if (!time) {
                    showToast('請選擇時間');
                    return;
                }
                
                // 新增餵食記錄
                const feedingData = {
                    childId: currentChildId,
                    timestamp: new Date(time).toISOString(),
                    method: selectedMethod,
                    note: note
                };
                
                if (selectedMethod === 'breastfeeding') {
                    feedingData.side = selectedSide;
                } else if (amount) {
                    feedingData.amount = parseInt(amount);
                }
                
                addRecord('feeding', feedingData, () => {
                    showToast('成功新增餵食紀錄');
                    closeModal();
                    
                    // 重新載入餵食記錄
                    loadFeedingRecords();
                    
                    // 如果在首頁，也重新載入今日記錄
                    if (currentPage === 'home') {
                        loadTodayRecords();
                    }
                });
            });
            
            openModal();
        }

        // 顯示新增睡眠記錄彈窗
        function showAddSleepModal() {
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            
            modalTitle.textContent = '新增睡眠紀錄';
            modalBody.innerHTML = `
                <form id="add-sleep-form">
                    <div class="form-group">
                        <label class="form-label">開始時間</label>
                        <input type="datetime-local" class="form-control" id="sleep-start-time" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">持續時間 (分鐘)</label>
                        <input type="number" class="form-control" id="sleep-duration" placeholder="例：120" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">睡眠品質</label>
                        <div class="toggle-group" id="sleep-quality">
                            <div class="toggle-option" data-value="good">安穩</div>
                            <div class="toggle-option active" data-value="normal">普通</div>
                            <div class="toggle-option" data-value="poor">不佳</div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">備註</label>
                        <input type="text" class="form-control" id="sleep-note" placeholder="選填">
                    </div>
                    
                    <button type="submit" class="btn" style="width: 100%;">儲存</button>
                </form>
            `;
            
            // 設定預設時間為現在
            document.getElementById('sleep-start-time').value = formatDateTimeLocal(new Date(new Date().getTime() - 60 * 60 * 1000)); // 預設一小時前
            
            // 睡眠品質切換
            const qualityOptions = modalBody.querySelectorAll('#sleep-quality .toggle-option');
            let selectedQuality = 'normal';
            
            qualityOptions.forEach(option => {
                option.addEventListener('click', () => {
                    qualityOptions.forEach(opt => opt.classList.remove('active'));
                    option.classList.add('active');
                    selectedQuality = option.dataset.value;
                });
            });
            
            // 表單提交
            const form = document.getElementById('add-sleep-form');
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const startTime = document.getElementById('sleep-start-time').value;
                const duration = document.getElementById('sleep-duration').value;
                const note = document.getElementById('sleep-note').value.trim();
                
                if (!startTime || !duration) {
                    showToast('請填寫所有必填欄位');
                    return;
                }
                
                // 新增睡眠記錄
                const sleepData = {
                    childId: currentChildId,
                    timestamp: new Date(startTime).toISOString(),
                    duration: parseInt(duration),
                    quality: selectedQuality,
                    note: note
                };
                
                addRecord('sleep', sleepData, () => {
                    showToast('成功新增睡眠紀錄');
                    closeModal();
                    
                    // 重新載入睡眠記錄
                    loadSleepRecords();
                    
                    // 如果在首頁，也重新載入今日記錄
                    if (currentPage === 'home') {
                        loadTodayRecords();
                    }
                });
            });
            
            openModal();
        }

        // 顯示新增尿布記錄彈窗
        function showAddDiaperModal() {
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            
            modalTitle.textContent = '新增尿布紀錄';
            modalBody.innerHTML = `
                <form id="add-diaper-form">
                    <div class="form-group">
                        <label class="form-label">尿布類型</label>
                        <div class="toggle-group" id="diaper-type">
                            <div class="toggle-option active" data-value="wet">尿布</div>
                            <div class="toggle-option" data-value="dirty">便便</div>
                            <div class="toggle-option" data-value="mixed">混合</div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">時間</label>
                        <input type="datetime-local" class="form-control" id="diaper-time" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">特徵</label>
                        <input type="text" class="form-control" id="diaper-note" placeholder="例：顏色、質地等">
                    </div>
                    
                    <button type="submit" class="btn" style="width: 100%;">儲存</button>
                </form>
            `;
            
            // 設定預設時間為現在
            document.getElementById('diaper-time').value = formatDateTimeLocal(new Date());
            
            // 尿布類型切換
            const typeOptions = modalBody.querySelectorAll('#diaper-type .toggle-option');
            let selectedType = 'wet';
            
            typeOptions.forEach(option => {
                option.addEventListener('click', () => {
                    typeOptions.forEach(opt => opt.classList.remove('active'));
                    option.classList.add('active');
                    selectedType = option.dataset.value;
                });
            });
            
            // 表單提交
            const form = document.getElementById('add-diaper-form');
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const time = document.getElementById('diaper-time').value;
                const note = document.getElementById('diaper-note').value.trim();
                
                if (!time) {
                    showToast('請選擇時間');
                    return;
                }
                
                // 新增尿布記錄
                const diaperData = {
                    childId: currentChildId,
                    timestamp: new Date(time).toISOString(),
                    type: selectedType,
                    note: note
                };
                
                addRecord('diaper', diaperData, () => {
                    showToast('成功新增尿布紀錄');
                    closeModal();
                    
                    // 重新載入尿布記錄
                    loadDiaperRecords();
                    
                    // 如果在首頁，也重新載入今日記錄
                    if (currentPage === 'home') {
                        loadTodayRecords();
                    }
                });
            });
            
            openModal();
        }

        // 載入發展頁面
        function loadDevelopmentPage() {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <div class="tabs">
                    <div class="tab active" data-tab="milestones">里程碑</div>
                    <div class="tab" data-tab="activities">活動</div>
                    <div class="tab" data-tab="interaction">親子互動</div>
                </div>
                
                <div class="tab-content active" id="milestones-content">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">發展里程碑</div>
                        </div>
                        <div class="card-content">
                            <div class="tabs" id="milestone-categories">
                                <div class="tab active" data-category="all">全部</div>
                                <div class="tab" data-category="motor">動作</div>
                                <div class="tab" data-category="language">語言</div>
                                <div class="tab" data-category="social">社交</div>
                                <div class="tab" data-category="cognitive">認知</div>
                                <div class="tab" data-category="emotional">情緒</div>
                                <div class="tab" data-category="self-help">自理</div>
                            </div>
                            
                            <div id="milestones-list">
                                <div class="loader"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="tab-content" id="activities-content">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">日常活動</div>
                            <button class="btn-icon" id="add-activity-btn">+</button>
                        </div>
                        <div class="card-content">
                            <div id="activities-list">
                                <div class="loader"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="tab-content" id="interaction-content">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">親子互動</div>
                            <button class="btn-icon" id="add-interaction-btn">+</button>
                        </div>
                        <div class="card-content">
                            <div id="interactions-list">
                                <div class="loader"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // 設定頁籤切換
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    // 檢查是否為主頁籤或子頁籤
                    if (tab.closest('.tabs').id === 'milestone-categories') {
                        // 子頁籤（里程碑分類）
                        document.querySelectorAll('#milestone-categories .tab').forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        loadMilestones(tab.dataset.category);
                    } else {
                        // 主頁籤
                        document.querySelectorAll('.tabs:not(#milestone-categories) .tab').forEach(t => t.classList.remove('active'));
                        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                        
                        tab.classList.add('active');
                        document.getElementById(`${tab.dataset.tab}-content`).classList.add('active');
                    }
                });
            });
            
            // 綁定新增按鈕
            document.getElementById('add-activity-btn').addEventListener('click', () => {
                showAddActivityModal();
            });
            
            document.getElementById('add-interaction-btn').addEventListener('click', () => {
                showAddInteractionModal();
            });
            
            // 載入里程碑
            loadMilestones('all');
            
            // 載入活動記錄
            loadActivities();
            
            // 載入親子互動記錄
            loadInteractions();
        }

        // 載入里程碑
        function loadMilestones(category = 'all') {
            const milestonesListElement = document.getElementById('milestones-list');
            milestonesListElement.innerHTML = '<div class="loader"></div>';
            
            const transaction = db.transaction(['milestones'], 'readonly');
            const milestonesStore = transaction.objectStore('milestones');
            const index = milestonesStore.index('childId');
            const range = IDBKeyRange.only(currentChildId);
            const request = index.openCursor(range);
            
            let milestones = [];
            
            request.onsuccess = (event) => {
                const cursor = event.target.result;
                
                if (cursor) {
                    milestones.push(cursor.value);
                    cursor.continue();
                } else {
                    // 如果指定了分類，過濾里程碑
                    if (category !== 'all') {
                        milestones = milestones.filter(m => m.category === category);
                    }
                    
                    // 排序（按年齡）
                    milestones.sort((a, b) => a.ageMonths - b.ageMonths);
                    
                    if (milestones.length === 0) {
                        milestonesListElement.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-text">沒有里程碑記錄</div>
                            </div>
                        `;
                    } else {
                        milestonesListElement.innerHTML = '';
                        
                        // 按類別分組顯示
                        const categories = {
                            'motor': '動作能力',
                            'language': '語言能力',
                            'social': '社交能力',
                            'cognitive': '認知能力',
                            'emotional': '情緒發展',
                            'self-help': '自理能力'
                        };
                        
                        // 如果是全部分類，先分組
                        if (category === 'all') {
                            const groupedMilestones = {};
                            
                            for (const cat in categories) {
                                groupedMilestones[cat] = milestones.filter(m => m.category === cat);
                            }
                            
                            for (const cat in groupedMilestones) {
                                if (groupedMilestones[cat].length > 0) {
                                    const categoryTitle = document.createElement('div');
                                    categoryTitle.textContent = categories[cat];
                                    categoryTitle.style.fontWeight = '600';
                                    categoryTitle.style.marginTop = '16px';
                                    categoryTitle.style.marginBottom = '8px';
                                    
                                    milestonesListElement.appendChild(categoryTitle);
                                    
                                    groupedMilestones[cat].forEach(milestone => {
                                        appendMilestoneItem(milestone, milestonesListElement);
                                    });
                                }
                            }
                        } else {
                            // 單一分類直接顯示
                            milestones.forEach(milestone => {
                                appendMilestoneItem(milestone, milestonesListElement);
                            });
                        }
                    }
                }
            };
        }

        // 添加里程碑項目
        function appendMilestoneItem(milestone, container) {
            const milestoneItem = document.createElement('div');
            milestoneItem.className = 'milestone-item';
            milestoneItem.dataset.id = milestone.id;
            
            if (milestone.completed) {
                milestoneItem.classList.add('completed');
            }
            
            milestoneItem.innerHTML = `
                <div class="milestone-header">
                    <div>${milestone.title}</div>
                    <div class="milestone-age">${milestone.ageMonths} 個月</div>
                </div>
                ${milestone.description ? `<div style="font-size: 0.85rem; margin-top: 6px;">${milestone.description}</div>` : ''}
                ${milestone.completed ? '<div class="checkmark">✓ 已完成</div>' : ''}
            `;
            
            // 點擊里程碑切換完成狀態
            milestoneItem.addEventListener('click', () => {
                toggleMilestoneStatus(milestone.id);
            });
            
            container.appendChild(milestoneItem);
        }

        // 載入活動記錄
        function loadActivities() {
            const activitiesListElement = document.getElementById('activities-list');
            
            getRecentRecords('activities', 20, (records) => {
                if (records.length === 0) {
                    activitiesListElement.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-text">尚無活動紀錄</div>
                        </div>
                    `;
                } else {
                    activitiesListElement.innerHTML = '';
                    
                    records.forEach(activity => {
                        const activityItem = document.createElement('div');
                        activityItem.className = 'record-item';
                        
                        activityItem.innerHTML = `
                            <div class="record-main">
                                <div class="record-time">${formatDateTime(new Date(activity.timestamp))}</div>
                                <div class="record-details">
                                    <span class="record-tag">${activity.type}</span>
                                    ${activity.duration ? `<span class="record-tag">${activity.duration} 分鐘</span>` : ''}
                                </div>
                                ${activity.note ? `<div style="font-size: 0.9rem; margin-top: 4px;">${activity.note}</div>` : ''}
                            </div>
                            <button class="btn-icon" data-id="${activity.id}">×</button>
                        `;
                        
                        // 綁定刪除按鈕
                        activityItem.querySelector('.btn-icon').addEventListener('click', (e) => {
                            e.stopPropagation();
                            deleteRecord('activities', activity.id, () => {
                                loadActivities();
                            });
                        });
                        
                        activitiesListElement.appendChild(activityItem);
                    });
                }
            });
        }

        // 載入親子互動記錄
        function loadInteractions() {
            const interactionsListElement = document.getElementById('interactions-list');
            
            getRecentRecords('interactions', 20, (records) => {
                if (records.length === 0) {
                    interactionsListElement.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-text">尚無親子互動紀錄</div>
                        </div>
                    `;
                } else {
                    interactionsListElement.innerHTML = '';
                    
                    // 顯示所有互動記錄（含照片）
                    records.forEach(interaction => {
                        const interactionItem = document.createElement('div');
                        interactionItem.className = 'record-item';
                        
                        const moodEmoji = getMoodEmoji(interaction.mood);
                        const moodText = getMoodText(interaction.mood);
                        
                        interactionItem.innerHTML = `
                            <div class="record-main">
                                <div class="record-time">${formatDateTime(new Date(interaction.timestamp))}</div>
                                <div class="record-details">
                                    <span class="record-tag">${moodEmoji} ${moodText}</span>
                                </div>
                                ${interaction.note ? `<div style="font-size: 0.9rem; margin-top: 4px;">${interaction.note}</div>` : ''}
                                ${interaction.photoData ? `
                                    <div class="interaction-photo">
                                        <img src="${interaction.photoData}" alt="互動照片">
                                    </div>` : ''}
                            </div>
                            <button class="btn-icon" data-id="${interaction.id}">×</button>
                        `;
                        
                        // 綁定刪除按鈕
                        interactionItem.querySelector('.btn-icon').addEventListener('click', (e) => {
                            e.stopPropagation();
                            deleteRecord('interactions', interaction.id, () => {
                                loadInteractions();
                            });
                        });
                        
                        interactionsListElement.appendChild(interactionItem);
                    });
                }
            });
        }

        // 顯示新增活動記錄彈窗
        function showAddActivityModal() {
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            
            modalTitle.textContent = '新增活動紀錄';
            modalBody.innerHTML = `
                <form id="add-activity-form">
                    <div class="form-group">
                        <label class="form-label">活動類型</label>
                        <input type="text" class="form-control" id="activity-type" placeholder="例：閱讀、玩耍、外出" list="activity-types" required>
                        <datalist id="activity-types">
                            <option value="閱讀">
                            <option value="玩耍">
                            <option value="外出">
                            <option value="洗澡">
                            <option value="運動">
                            <option value="音樂">
                            <option value="學習">
                        </datalist>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">時間</label>
                        <input type="datetime-local" class="form-control" id="activity-time" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">持續時間 (分鐘)</label>
                        <input type="number" class="form-control" id="activity-duration" placeholder="選填">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">備註</label>
                        <textarea class="form-control" id="activity-note" placeholder="選填" rows="3"></textarea>
                    </div>
                    
                    <button type="submit" class="btn" style="width: 100%;">儲存</button>
                </form>
            `;
            
            // 設定預設時間為現在
            document.getElementById('activity-time').value = formatDateTimeLocal(new Date());
            
            // 表單提交
            const form = document.getElementById('add-activity-form');
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const type = document.getElementById('activity-type').value.trim();
                const time = document.getElementById('activity-time').value;
                const duration = document.getElementById('activity-duration').value;
                const note = document.getElementById('activity-note').value.trim();
                
                if (!type || !time) {
                    showToast('請填寫所有必填欄位');
                    return;
                }
                
                // 新增活動記錄
                const activityData = {
                    childId: currentChildId,
                    timestamp: new Date(time).toISOString(),
                    type: type,
                    note: note
                };
                
                if (duration) {
                    activityData.duration = parseInt(duration);
                }
                
                addRecord('activities', activityData, () => {
                    showToast('成功新增活動紀錄');
                    closeModal();
                    
                    // 重新載入活動記錄
                    loadActivities();
                });
            });
            
            openModal();
        }

        // 顯示新增親子互動記錄彈窗（增強版 - 8種情緒）
        function showAddInteractionModal() {
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            
            modalTitle.textContent = '新增親子互動';
            modalBody.innerHTML = `
                <form id="add-interaction-form">
                    <div class="form-group">
                        <label class="form-label">時間</label>
                        <input type="datetime-local" class="form-control" id="interaction-time" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">寶寶情緒</label>
                        <div class="mood-grid" id="interaction-mood">
                            <div class="toggle-option active" data-value="happy">😄 開心</div>
                            <div class="toggle-option" data-value="excited">🤩 興奮</div>
                            <div class="toggle-option" data-value="calm">😊 平靜</div>
                            <div class="toggle-option" data-value="sleepy">😴 想睡</div>
                            <div class="toggle-option" data-value="curious">🤔 好奇</div>
                            <div class="toggle-option" data-value="playful">😆 愛玩</div>
                            <div class="toggle-option" data-value="sad">😢 難過</div>
                            <div class="toggle-option" data-value="angry">😠 生氣</div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">記錄照片</label>
                        <input type="file" id="interaction-photo" class="file-input" accept="image/*">
                        <label for="interaction-photo" class="file-label">選擇照片</label>
                        <div id="photo-preview" class="image-preview" style="display: none;">
                            <img id="preview-image" src="" alt="預覽">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">備註</label>
                        <textarea class="form-control" id="interaction-note" placeholder="選填" rows="3"></textarea>
                    </div>
                    
                    <button type="submit" class="btn" style="width: 100%;">儲存</button>
                </form>
            `;
            
            // 設定預設時間為現在
            document.getElementById('interaction-time').value = formatDateTimeLocal(new Date());
            
            // 情緒切換 - 支援8種情緒
            const moodOptions = modalBody.querySelectorAll('#interaction-mood .toggle-option');
            let selectedMood = 'happy';
            
            moodOptions.forEach(option => {
                option.addEventListener('click', () => {
                    moodOptions.forEach(opt => opt.classList.remove('active'));
                    option.classList.add('active');
                    selectedMood = option.dataset.value;
                });
            });
            
            // 照片預覽
            const photoInput = document.getElementById('interaction-photo');
            const photoPreview = document.getElementById('photo-preview');
            const previewImage = document.getElementById('preview-image');
            
            photoInput.addEventListener('change', (e) => {
                if (e.target.files && e.target.files[0]) {
                    const reader = new FileReader();
                    
                    reader.onload = (e) => {
                        previewImage.src = e.target.result;
                        photoPreview.style.display = 'block';
                    };
                    
                    reader.readAsDataURL(e.target.files[0]);
                }
            });
            
            // 表單提交
            const form = document.getElementById('add-interaction-form');
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const time = document.getElementById('interaction-time').value;
                const note = document.getElementById('interaction-note').value.trim();
                
                if (!time) {
                    showToast('請選擇時間');
                    return;
                }
                
                // 新增親子互動記錄
                const interactionData = {
                    childId: currentChildId,
                    timestamp: new Date(time).toISOString(),
                    mood: selectedMood,
                    note: note,
                    photoData: previewImage.src || null
                };
                
                addRecord('interactions', interactionData, () => {
                    showToast('成功新增親子互動');
                    closeModal();
                    
                    // 重新載入親子互動記錄
                    loadInteractions();
                });
            });
            
            openModal();
        }

        // 載入健康頁面（增加體溫標籤頁）
        function loadHealthPage() {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <div class="tabs">
                    <div class="tab active" data-tab="growth">成長</div>
                    <div class="tab" data-tab="temperature">體溫</div>
                    <div class="tab" data-tab="vaccine">疫苗</div>
                    <div class="tab" data-tab="medication">用藥</div>
                </div>
                
                <div class="tab-content active" id="growth-content">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">身高體重</div>
                            <button class="btn-icon" id="add-growth-btn">+</button>
                        </div>
                        <div class="card-content">
                            <div class="growth-chart">
                                <div class="chart-section-title">體重 (kg)</div>
                                <div class="chart-line" id="weight-chart">
                                    <!-- 體重數據點將動態添加 -->
                                </div>
                                
                                <div class="chart-section-title" style="margin-top: 40px;">身高 (cm)</div>
                                <div class="chart-line" id="height-chart">
                                    <!-- 身高數據點將動態添加 -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">最近紀錄</div>
                        </div>
                        <div class="records-list" id="growth-records">
                            <div class="loader"></div>
                        </div>
                    </div>
                </div>
                
                <!-- 新增體溫記錄標籤頁 -->
                <div class="tab-content" id="temperature-content">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">體溫記錄</div>
                            <button class="btn-icon" id="add-temperature-btn">+</button>
                        </div>
                        <div class="card-content">
                            <div class="growth-chart">
                                <div class="chart-section-title">體溫趨勢 (°C)</div>
                                <div class="chart-line" id="temperature-chart">
                                    <!-- 體溫數據點將動態添加 -->
                                </div>
                            </div>
                            
                            <div class="mini-stat">
                                <div>最近體溫</div>
                                <div class="mini-stat-value" id="recent-temperature">-</div>
                            </div>
                            
                            <div class="mini-stat">
                                <div>平均體溫</div>
                                <div class="mini-stat-value" id="average-temperature">-</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">最近紀錄</div>
                        </div>
                        <div class="records-list" id="temperature-records">
                            <div class="loader"></div>
                        </div>
                    </div>
                </div>
                
                <div class="tab-content" id="vaccine-content">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">疫苗接種</div>
                            <button class="btn-icon" id="add-vaccine-btn">+</button>
                        </div>
                        <div class="card-content">
                            <div id="vaccine-schedule">
                                <div class="loader"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="tab-content" id="medication-content">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">用藥紀錄</div>
                            <button class="btn-icon" id="add-medication-btn">+</button>
                        </div>
                        <div class="records-list" id="medication-records">
                            <div class="loader"></div>
                        </div>
                    </div>
                </div>
            `;
            
            // 設定頁籤切換
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    tab.classList.add('active');
                    document.getElementById(`${tab.dataset.tab}-content`).classList.add('active');
                });
            });
            
            // 綁定新增按鈕
            document.getElementById('add-growth-btn').addEventListener('click', () => {
                showAddGrowthModal();
            });
            
            document.getElementById('add-temperature-btn').addEventListener('click', () => {
                showAddTemperatureModal();
            });
            
            document.getElementById('add-vaccine-btn').addEventListener('click', () => {
                showAddVaccineModal();
            });
            
            document.getElementById('add-medication-btn').addEventListener('click', () => {
                showAddMedicationModal();
            });
            
            // 載入成長記錄
            loadGrowthRecords();
            
            // 載入體溫記錄
            loadTemperatureRecords();
            
            // 載入疫苗接種記錄
            loadVaccineRecords();
            
            // 載入用藥記錄
            loadMedicationRecords();
        }

        // 新增體溫記錄相關功能
        function showAddTemperatureModal() {
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            
            modalTitle.textContent = '新增體溫記錄';
            modalBody.innerHTML = `
                <form id="add-temperature-form">
                    <div class="form-group">
                        <label class="form-label">體溫 (°C)</label>
                        <input type="number" class="form-control" id="temperature-value" 
                               step="0.1" min="30" max="45" placeholder="例：36.5" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">測量方式</label>
                        <div class="toggle-group" id="temperature-method">
                            <div class="toggle-option active" data-value="forehead">額溫</div>
                            <div class="toggle-option" data-value="ear">耳溫</div>
                            <div class="toggle-option" data-value="armpit">腋溫</div>
                            <div class="toggle-option" data-value="oral">口溫</div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">時間</label>
                        <input type="datetime-local" class="form-control" id="temperature-time" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">備註</label>
                        <textarea class="form-control" id="temperature-note" 
                                  placeholder="例：發燒、活動後等" rows="2"></textarea>
                    </div>
                    
                    <button type="submit" class="btn" style="width: 100%;">儲存</button>
                </form>
            `;
            
            // 設定預設時間為現在
            document.getElementById('temperature-time').value = formatDateTimeLocal(new Date());
            
            // 測量方式切換
            const methodOptions = modalBody.querySelectorAll('#temperature-method .toggle-option');
            let selectedMethod = 'forehead';
            
            methodOptions.forEach(option => {
                option.addEventListener('click', () => {
                    methodOptions.forEach(opt => opt.classList.remove('active'));
                    option.classList.add('active');
                    selectedMethod = option.dataset.value;
                });
            });
            
            // 表單提交
            const form = document.getElementById('add-temperature-form');
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const value = document.getElementById('temperature-value').value;
                const time = document.getElementById('temperature-time').value;
                const note = document.getElementById('temperature-note').value.trim();
                
                if (!value || !time) {
                    showToast('請填寫所有必填欄位');
                    return;
                }
                
                const tempValue = parseFloat(value);
                if (tempValue < 30 || tempValue > 45) {
                    showToast('請輸入合理的體溫值');
                    return;
                }
                
                // 新增體溫記錄
                const temperatureData = {
                    childId: currentChildId,
                    timestamp: new Date(time).toISOString(),
                    type: 'temperature',
                    value: tempValue,
                    method: selectedMethod,
                    note: note
                };
                
                addRecord('health', temperatureData, () => {
                    showToast('成功新增體溫紀錄');
                    closeModal();
                    
                    // 重新載入體溫記錄
                    loadTemperatureRecords();
                });
            });
            
            openModal();
        }

        function loadTemperatureRecords() {
            const temperatureRecordsElement = document.getElementById('temperature-records');
            const recentTemperatureElement = document.getElementById('recent-temperature');
            const averageTemperatureElement = document.getElementById('average-temperature');
            
            getHealthRecordsByType('temperature', (records) => {
                if (records.length === 0) {
                    temperatureRecordsElement.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-text">尚無體溫紀錄</div>
                        </div>
                    `;
                    recentTemperatureElement.textContent = '-';
                    averageTemperatureElement.textContent = '-';
                } else {
                    // 顯示最近體溫
                    recentTemperatureElement.textContent = `${records[0].value}°C`;
                    
                    // 計算平均體溫
                    const avgTemp = records.reduce((sum, record) => sum + record.value, 0) / records.length;
                    averageTemperatureElement.textContent = `${avgTemp.toFixed(1)}°C`;
                    
                    // 渲染記錄列表
                    temperatureRecordsElement.innerHTML = '';
                    
                    records.forEach(record => {
                        const recordItem = document.createElement('div');
                        recordItem.className = 'record-item';
                        
                        const methodText = {
                            'forehead': '額溫',
                            'ear': '耳溫',
                            'armpit': '腋溫',
                            'oral': '口溫'
                        }[record.method] || '額溫';
                        
                        // 判斷體溫狀態
                        let tempStatus = '';
                        let tempColor = '';
                        if (record.value >= 38) {
                            tempStatus = '發燒';
                            tempColor = '#ff6b6b';
                        } else if (record.value >= 37.5) {
                            tempStatus = '微燒';
                            tempColor = '#ffa500';
                        } else if (record.value < 36) {
                            tempStatus = '偏低';
                            tempColor = '#6bb6ff';
                        } else {
                            tempStatus = '正常';
                            tempColor = '#51cf66';
                        }
                        
                        recordItem.innerHTML = `
                            <div class="record-main">
                                <div class="record-time">${formatDateTime(new Date(record.timestamp))}</div>
                                <div class="record-details">
                                    <span class="record-tag" style="background-color: ${tempColor}; color: white;">
                                        ${record.value}°C ${tempStatus}
                                    </span>
                                    <span class="record-tag">${methodText}</span>
                                </div>
                                ${record.note ? `<div style="font-size: 0.9rem; margin-top: 4px;">${record.note}</div>` : ''}
                            </div>
                            <button class="btn-icon" data-id="${record.id}">×</button>
                        `;
                        
                        // 綁定刪除按鈕
                        recordItem.querySelector('.btn-icon').addEventListener('click', (e) => {
                            e.stopPropagation();
                            deleteRecord('health', record.id, () => {
                                loadTemperatureRecords();
                            });
                        });
                        
                        temperatureRecordsElement.appendChild(recordItem);
                    });
                    
                    // 渲染體溫圖表
                    renderTemperatureChart(records);
                }
            });
        }

        function renderTemperatureChart(records) {
            const chartElement = document.getElementById('temperature-chart');
            
            if (records.length < 2) {
                chartElement.innerHTML = `
                    <div class="empty-state" style="padding: 10px 0;">
                        <div class="empty-text">資料不足，無法顯示趨勢</div>
                    </div>
                `;
                return;
            }
            
            // 對記錄進行排序（從舊到新）
            const sortedRecords = [...records].sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            
            // 取最近 10 筆記錄
            const recentRecords = sortedRecords.slice(-10);
            
            // 清空圖表
            chartElement.innerHTML = '';
            
            const totalWidth = chartElement.offsetWidth;
            const stepWidth = totalWidth / (recentRecords.length > 1 ? (recentRecords.length - 1) : 2);
            
            recentRecords.forEach((record, index) => {
                const point = document.createElement('div');
                point.className = 'chart-point';
                point.style.left = `${index * stepWidth}px`;
                point.dataset.value = `${record.value}°C`;
                point.dataset.date = formatDate(new Date(record.timestamp));
                
                // 根據體溫設定顏色
                if (record.value >= 38) {
                    point.style.backgroundColor = '#ff6b6b';
                } else if (record.value >= 37.5) {
                    point.style.backgroundColor = '#ffa500';
                } else if (record.value < 36) {
                    point.style.backgroundColor = '#6bb6ff';
                } else {
                    point.style.backgroundColor = '#51cf66';
                }
                
                chartElement.appendChild(point);
            });
        }
        // 載入成長記錄
        function loadGrowthRecords() {
            const growthRecordsElement = document.getElementById('growth-records');
            
            // 查詢體重記錄
            getHealthRecordsByType('weight', (weightRecords) => {
                // 查詢身高記錄
                getHealthRecordsByType('height', (heightRecords) => {
                    // 合併並排序（從新到舊）
                    const allRecords = [...weightRecords, ...heightRecords].sort((a, b) => 
                        new Date(b.timestamp) - new Date(a.timestamp)
                    );
                    
                    if (allRecords.length === 0) {
                        growthRecordsElement.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-text">尚無身高體重紀錄</div>
                            </div>
                        `;
                    } else {
                        growthRecordsElement.innerHTML = '';
                        
                        allRecords.forEach(record => {
                            const recordItem = document.createElement('div');
                            recordItem.className = 'record-item';
                            
                            const isWeight = record.type === 'weight';
                            
                            recordItem.innerHTML = `
                                <div class="record-main">
                                    <div class="record-time">${formatDateTime(new Date(record.timestamp))}</div>
                                    <div class="record-details">
                                        <span class="record-tag">${isWeight ? '體重' : '身高'}</span>
                                        <span class="record-tag">${record.value} ${isWeight ? 'kg' : 'cm'}</span>
                                    </div>
                                </div>
                                <button class="btn-icon" data-id="${record.id}">×</button>
                            `;
                            
                            // 綁定刪除按鈕
                            recordItem.querySelector('.btn-icon').addEventListener('click', (e) => {
                                e.stopPropagation();
                                deleteRecord('health', record.id, () => {
                                    loadGrowthRecords();
                                });
                            });
                            
                            growthRecordsElement.appendChild(recordItem);
                        });
                    }
                    
                    // 載入成長圖表
                    renderGrowthCharts(weightRecords, heightRecords);
                });
            });
        }

        // 渲染成長圖表
        function renderGrowthCharts(weightRecords, heightRecords) {
            const weightChartElement = document.getElementById('weight-chart');
            const heightChartElement = document.getElementById('height-chart');
            
            // 清空圖表
            weightChartElement.innerHTML = '';
            heightChartElement.innerHTML = '';
            
            // 對記錄進行排序（從舊到新）
            weightRecords.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            heightRecords.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            
            // 渲染體重圖表
            if (weightRecords.length > 0) {
                const totalWidth = weightChartElement.offsetWidth;
                const stepWidth = totalWidth / (weightRecords.length > 1 ? (weightRecords.length - 1) : 2);
                
                weightRecords.forEach((record, index) => {
                    const point = document.createElement('div');
                    point.className = 'chart-point';
                    point.style.left = `${index * stepWidth}px`;
                    point.dataset.value = `${record.value} kg`;
                    point.dataset.date = formatDate(new Date(record.timestamp));
                    
                    weightChartElement.appendChild(point);
                });
            }
            
            // 渲染身高圖表
            if (heightRecords.length > 0) {
                const totalWidth = heightChartElement.offsetWidth;
                const stepWidth = totalWidth / (heightRecords.length > 1 ? (heightRecords.length - 1) : 2);
                
                heightRecords.forEach((record, index) => {
                    const point = document.createElement('div');
                    point.className = 'chart-point';
                    point.style.left = `${index * stepWidth}px`;
                    point.dataset.value = `${record.value} cm`;
                    point.dataset.date = formatDate(new Date(record.timestamp));
                    
                    heightChartElement.appendChild(point);
                });
            }
        }

        // 載入疫苗接種記錄
        function loadVaccineRecords() {
            const vaccineScheduleElement = document.getElementById('vaccine-schedule');
            
            // 獲取台灣疫苗接種時程表
            const taiwanVaccineSchedule = [
                { month: 0, name: 'B 型肝炎疫苗第 1 劑' },
                { month: 1, name: '卡介苗' },
                { month: 1, name: 'B 型肝炎疫苗第 2 劑' },
                { month: 2, name: '13 價結合型肺炎鏈球菌疫苗第 1 劑' },
                { month: 2, name: '五合一疫苗第 1 劑' },
                { month: 4, name: '13 價結合型肺炎鏈球菌疫苗第 2 劑' },
                { month: 4, name: '五合一疫苗第 2 劑' },
                { month: 6, name: '13 價結合型肺炎鏈球菌疫苗第 3 劑' },
                { month: 6, name: '五合一疫苗第 3 劑' },
                { month: 6, name: 'B 型肝炎疫苗第 3 劑' },
                { month: 12, name: '麻疹腮腺炎德國麻疹疫苗第 1 劑' },
                { month: 12, name: '水痘疫苗' },
                { month: 12, name: '日本腦炎疫苗第 1、2 劑' },
                { month: 15, name: '13 價結合型肺炎鏈球菌疫苗追加劑' },
                { month: 18, name: '五合一疫苗追加劑' },
                { month: 18, name: 'A 型肝炎疫苗第 1 劑' },
                { month: 24, name: 'A 型肝炎疫苗第 2 劑' },
                { month: 36, name: '日本腦炎疫苗第 3 劑' },
                { month: 60, name: '麻疹腮腺炎德國麻疹疫苗第 2 劑' }
            ];
            
            // 獲取已接種的疫苗記錄
            getHealthRecordsByType('vaccine', (vaccineRecords) => {
                // 獲取孩子的年齡（月）
                getChildById(currentChildId, (child) => {
                    const birthDate = new Date(child.birthdate);
                    const today = new Date();
                    const ageInMonths = Math.floor((today - birthDate) / (1000 * 60 * 60 * 24 * 30.44));
                    
                    // 渲染疫苗接種時程表
                    vaccineScheduleElement.innerHTML = '';
                    
                    // 依年齡分組顯示
                    const ageGroups = [
                        { label: '出生', months: [0] },
                        { label: '1 個月', months: [1] },
                        { label: '2 個月', months: [2] },
                        { label: '4 個月', months: [4] },
                        { label: '6 個月', months: [6] },
                        { label: '12-15 個月', months: [12, 15] },
                        { label: '18-24 個月', months: [18, 24] },
                        { label: '3-5 歲', months: [36, 60] }
                    ];
                    
                    ageGroups.forEach(group => {
                        const groupVaccines = taiwanVaccineSchedule.filter(v => group.months.includes(v.month));
                        
                        if (groupVaccines.length > 0) {
                            const groupElement = document.createElement('div');
                            groupElement.style.marginBottom = '16px';
                            
                            const groupTitle = document.createElement('div');
                            groupTitle.textContent = group.label;
                            groupTitle.style.fontWeight = '600';
                            groupTitle.style.marginBottom = '8px';
                            
                            groupElement.appendChild(groupTitle);
                            
                            groupVaccines.forEach(vaccine => {
                                // 檢查此疫苗是否已接種
                                const isVaccinated = vaccineRecords.some(record => record.name === vaccine.name);
                                
                                // 檢查此疫苗是否為當前年齡應接種的疫苗
                                const isDue = ageInMonths >= vaccine.month;
                                
                                const vaccineItem = document.createElement('div');
                                vaccineItem.className = 'milestone-item';
                                
                                if (isVaccinated) {
                                    vaccineItem.classList.add('completed');
                                }
                                
                                vaccineItem.innerHTML = `
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>${vaccine.name}</div>
                                        <div>
                                            ${isVaccinated ? 
                                              '<span class="checkmark">✓ 已接種</span>' : 
                                              isDue ? '<span style="color: var(--secondary);">應接種</span>' : ''}
                                        </div>
                                    </div>
                                `;
                                
                                // 點擊未接種的疫苗可新增接種記錄
                                if (!isVaccinated) {
                                    vaccineItem.style.cursor = 'pointer';
                                    vaccineItem.addEventListener('click', () => {
                                        showAddVaccineModal(vaccine.name);
                                    });
                                }
                                
                                groupElement.appendChild(vaccineItem);
                            });
                            
                            vaccineScheduleElement.appendChild(groupElement);
                        }
                    });
                });
            });
        }

        // 載入用藥記錄
        function loadMedicationRecords() {
            const medicationRecordsElement = document.getElementById('medication-records');
            
            getHealthRecordsByType('medication', (records) => {
                if (records.length === 0) {
                    medicationRecordsElement.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-text">尚無用藥紀錄</div>
                        </div>
                    `;
                } else {
                    medicationRecordsElement.innerHTML = '';
                    
                    records.forEach(record => {
                        const recordItem = document.createElement('div');
                        recordItem.className = 'record-item';
                        
                        recordItem.innerHTML = `
                            <div class="record-main">
                                <div class="record-time">${formatDateTime(new Date(record.timestamp))}</div>
                                <div class="record-details">
                                    <span class="record-tag">${record.name}</span>
                                    ${record.dose ? `<span class="record-tag">${record.dose}</span>` : ''}
                                </div>
                                ${record.note ? `<div style="font-size: 0.9rem; margin-top: 4px;">${record.note}</div>` : ''}
                            </div>
                            <button class="btn-icon" data-id="${record.id}">×</button>
                        `;
                        
                        // 綁定刪除按鈕
                        recordItem.querySelector('.btn-icon').addEventListener('click', (e) => {
                            e.stopPropagation();
                            deleteRecord('health', record.id, () => {
                                loadMedicationRecords();
                            });
                        });
                        
                        medicationRecordsElement.appendChild(recordItem);
                    });
                }
            });
        }

        // 顯示新增身高體重記錄彈窗
        function showAddGrowthModal() {
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            
            modalTitle.textContent = '新增身高體重';
            modalBody.innerHTML = `
                <form id="add-growth-form">
                    <div class="form-group">
                        <label class="form-label">紀錄類型</label>
                        <div class="toggle-group" id="growth-type">
                            <div class="toggle-option active" data-value="weight">體重</div>
                            <div class="toggle-option" data-value="height">身高</div>
                        </div>
                    </div>
                    
                    <div class="form-group" id="weight-input-group">
                        <label class="form-label">體重 (kg)</label>
                        <input type="number" class="form-control" id="weight-value" step="0.1" min="0" max="50" required>
                    </div>
                    
                    <div class="form-group" id="height-input-group" style="display: none;">
                        <label class="form-label">身高 (cm)</label>
                        <input type="number" class="form-control" id="height-value" step="0.1" min="0" max="200" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">時間</label>
                        <input type="datetime-local" class="form-control" id="growth-time" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">備註</label>
                        <input type="text" class="form-control" id="growth-note" placeholder="選填">
                    </div>
                    
                    <button type="submit" class="btn" style="width: 100%;">儲存</button>
                </form>
            `;
            
            // 設定預設時間為現在
            document.getElementById('growth-time').value = formatDateTimeLocal(new Date());
            
            // 紀錄類型切換
            const typeOptions = modalBody.querySelectorAll('#growth-type .toggle-option');
            let selectedType = 'weight';
            
            typeOptions.forEach(option => {
                option.addEventListener('click', () => {
                    typeOptions.forEach(opt => opt.classList.remove('active'));
                    option.classList.add('active');
                    selectedType = option.dataset.value;
                    
                    // 顯示對應的輸入欄位
                    document.getElementById('weight-input-group').style.display = selectedType === 'weight' ? 'block' : 'none';
                    document.getElementById('height-input-group').style.display = selectedType === 'height' ? 'block' : 'none';
                });
            });
            
            // 表單提交
            const form = document.getElementById('add-growth-form');
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const time = document.getElementById('growth-time').value;
                const note = document.getElementById('growth-note').value.trim();
                
                let value;
                if (selectedType === 'weight') {
                    value = document.getElementById('weight-value').value;
                } else {
                    value = document.getElementById('height-value').value;
                }
                
                if (!time || !value) {
                    showToast('請填寫所有必填欄位');
                    return;
                }
                
                // 新增成長記錄
                const growthData = {
                    childId: currentChildId,
                    timestamp: new Date(time).toISOString(),
                    type: selectedType,
                    value: parseFloat(value),
                    note: note
                };
                
                addRecord('health', growthData, () => {
                    showToast(`成功新增${selectedType === 'weight' ? '體重' : '身高'}紀錄`);
                    closeModal();
                    
                    // 重新載入成長記錄
                    loadGrowthRecords();
                });
            });
            
            openModal();
        }

        // 顯示新增疫苗記錄彈窗
        function showAddVaccineModal(preSelectedVaccine = null) {
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            
            modalTitle.textContent = '新增疫苗接種';
            modalBody.innerHTML = `
                <form id="add-vaccine-form">
                    <div class="form-group">
                        <label class="form-label">疫苗名稱</label>
                        <input type="text" class="form-control" id="vaccine-name" placeholder="例：五合一疫苗第 1 劑" list="vaccine-list" required>
                        <datalist id="vaccine-list">
                            <option value="B 型肝炎疫苗第 1 劑">
                            <option value="B 型肝炎疫苗第 2 劑">
                            <option value="B 型肝炎疫苗第 3 劑">
                            <option value="卡介苗">
                            <option value="五合一疫苗第 1 劑">
                            <option value="五合一疫苗第 2 劑">
                            <option value="五合一疫苗第 3 劑">
                            <option value="五合一疫苗追加劑">
                            <option value="13 價結合型肺炎鏈球菌疫苗第 1 劑">
                            <option value="13 價結合型肺炎鏈球菌疫苗第 2 劑">
                            <option value="13 價結合型肺炎鏈球菌疫苗第 3 劑">
                            <option value="13 價結合型肺炎鏈球菌疫苗追加劑">
                            <option value="麻疹腮腺炎德國麻疹疫苗第 1 劑">
                            <option value="麻疹腮腺炎德國麻疹疫苗第 2 劑">
                            <option value="水痘疫苗">
                            <option value="日本腦炎疫苗第 1、2 劑">
                            <option value="日本腦炎疫苗第 3 劑">
                            <option value="A 型肝炎疫苗第 1 劑">
                            <option value="A 型肝炎疫苗第 2 劑">
                        </datalist>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">接種日期</label>
                        <input type="date" class="form-control" id="vaccine-date" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">接種地點</label>
                        <input type="text" class="form-control" id="vaccine-location" placeholder="例：台大醫院小兒科">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">備註</label>
                        <input type="text" class="form-control" id="vaccine-note" placeholder="選填">
                    </div>
                    
                    <button type="submit" class="btn" style="width: 100%;">儲存</button>
                </form>
            `;
            
            // 設定預設日期為今天
            document.getElementById('vaccine-date').value = formatDateOnly(new Date());
            
            // 如果有預選的疫苗，填入名稱
            if (preSelectedVaccine) {
                document.getElementById('vaccine-name').value = preSelectedVaccine;
            }
            
            // 表單提交
            const form = document.getElementById('add-vaccine-form');
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const name = document.getElementById('vaccine-name').value.trim();
                const date = document.getElementById('vaccine-date').value;
                const location = document.getElementById('vaccine-location').value.trim();
                const note = document.getElementById('vaccine-note').value.trim();
                
                if (!name || !date) {
                    showToast('請填寫所有必填欄位');
                    return;
                }
                
                // 創建時間（當天的當前時間）
                const dateObj = new Date(date);
                const now = new Date();
                dateObj.setHours(now.getHours(), now.getMinutes(), now.getSeconds());
                
                // 新增疫苗記錄
                const vaccineData = {
                    childId: currentChildId,
                    timestamp: dateObj.toISOString(),
                    type: 'vaccine',
                    name: name,
                    location: location,
                    note: note
                };
                
                addRecord('health', vaccineData, () => {
                    showToast('成功新增疫苗接種紀錄');
                    closeModal();
                    
                    // 重新載入疫苗記錄
                    loadVaccineRecords();
                });
            });
            
            openModal();
        }

        // 顯示新增用藥記錄彈窗
        function showAddMedicationModal() {
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            
            modalTitle.textContent = '新增用藥紀錄';
            modalBody.innerHTML = `
                <form id="add-medication-form">
                    <div class="form-group">
                        <label class="form-label">藥物名稱</label>
                        <input type="text" class="form-control" id="medication-name" placeholder="例：退燒藥" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">劑量</label>
                        <input type="text" class="form-control" id="medication-dose" placeholder="例：5ml">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">服用時間</label>
                        <input type="datetime-local" class="form-control" id="medication-time" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">備註</label>
                        <textarea class="form-control" id="medication-note" placeholder="例：發燒 38.5°C" rows="2"></textarea>
                    </div>
                    
                    <button type="submit" class="btn" style="width: 100%;">儲存</button>
                </form>
            `;
            
            // 設定預設時間為現在
            document.getElementById('medication-time').value = formatDateTimeLocal(new Date());
            
            // 表單提交
            const form = document.getElementById('add-medication-form');
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const name = document.getElementById('medication-name').value.trim();
                const dose = document.getElementById('medication-dose').value.trim();
                const time = document.getElementById('medication-time').value;
                const note = document.getElementById('medication-note').value.trim();
                
                if (!name || !time) {
                    showToast('請填寫所有必填欄位');
                    return;
                }
                
                // 新增用藥記錄
                const medicationData = {
                    childId: currentChildId,
                    timestamp: new Date(time).toISOString(),
                    type: 'medication',
                    name: name,
                    dose: dose,
                    note: note
                };
                
                addRecord('health', medicationData, () => {
                    showToast('成功新增用藥紀錄');
                    closeModal();
                    
                    // 重新載入用藥記錄
                    loadMedicationRecords();
                });
            });
            
            openModal();
        }

        // 載入設定頁面
        function loadSettingsPage() {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">寶寶資料</div>
                    </div>
                    <div class="card-content" id="child-settings">
                        <div class="loader"></div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">外觀設定</div>
                    </div>
                    <div class="card-content">
                        <div class="settings-item">
                            <div>深色模式</div>
                            <label class="form-control" style="width: auto; display: flex; align-items: center;">
                                <input type="checkbox" id="dark-mode-toggle" style="margin-right: 8px;">
                                <div id="theme-status">關閉</div>
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">資料管理</div>
                    </div>
                    <div class="card-content">
                        <div class="settings-item">
                            <div>備份資料</div>
                            <button class="btn-sm" id="backup-btn">下載備份</button>
                        </div>
                        
                        <div class="settings-item">
                            <div>還原資料</div>
                            <button class="btn-sm" id="restore-btn">上傳備份</button>
                        </div>
                        
                        <div class="settings-item">
                            <div>清除資料</div>
                            <button class="btn-sm" id="clear-data-btn" style="background-color: #ff6b6b;">清除</button>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">關於</div>
                    </div>
                    <div class="card-content">
                        <div style="text-align: center; padding: 8px 0;">
                            <div style="font-size: 1.2rem; margin-bottom: 8px;">寶寶照護筆記</div>
                            <div style="color: var(--text-light); font-size: 0.9rem;">版本 1.0.0</div>
                            <div style="color: var(--text-light); font-size: 0.9rem; margin-top: 8px;">© 2025 台灣本地化設計</div>
                        </div>
                    </div>
                </div>
            `;
            
            // 載入寶寶設定
            loadChildSettings();
            
            // 深色模式切換
            const darkModeToggle = document.getElementById('dark-mode-toggle');
            const themeStatus = document.getElementById('theme-status');
            
            // 檢查當前主題
            const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';
            darkModeToggle.checked = isDarkMode;
            themeStatus.textContent = isDarkMode ? '開啟' : '關閉';
            
            darkModeToggle.addEventListener('change', () => {
                const newTheme = darkModeToggle.checked ? 'dark' : 'light';
                document.documentElement.setAttribute('data-theme', newTheme);
                themeStatus.textContent = darkModeToggle.checked ? '開啟' : '關閉';
                
                // 儲存主題設定
                localStorage.setItem('theme', newTheme);
            });
            
            // 綁定備份按鈕
            document.getElementById('backup-btn').addEventListener('click', () => {
                backupData();
            });
            
            // 綁定還原按鈕
            document.getElementById('restore-btn').addEventListener('click', () => {
                // 創建一個隱藏的文件輸入元素
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = '.json';
                fileInput.style.display = 'none';
                document.body.appendChild(fileInput);
                
                fileInput.addEventListener('change', (e) => {
                    if (e.target.files && e.target.files[0]) {
                        const file = e.target.files[0];
                        const reader = new FileReader();
                        
                        reader.onload = (e) => {
                            try {
                                const backup = JSON.parse(e.target.result);
                                restoreData(backup);
                            } catch (error) {
                                showToast('備份檔案格式錯誤');
                                console.error('還原資料錯誤:', error);
                            }
                        };
                        
                        reader.readAsText(file);
                    }
                    
                    document.body.removeChild(fileInput);
                });
                
                fileInput.click();
            });
            
            // 綁定清除資料按鈕
            document.getElementById('clear-data-btn').addEventListener('click', () => {
                if (confirm('確定要清除所有資料嗎？此操作無法復原。')) {
                    clearAllData();
                }
            });
        }

        // 載入寶寶設定
        function loadChildSettings() {
            const childSettingsElement = document.getElementById('child-settings');
            
            const transaction = db.transaction(['children'], 'readonly');
            const childrenStore = transaction.objectStore('children');
            const request = childrenStore.getAll();
            
            request.onsuccess = () => {
                const children = request.result;
                
                if (children.length === 0) {
                    childSettingsElement.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-text">尚無寶寶資料</div>
                        </div>
                    `;
                } else {
                    childSettingsElement.innerHTML = '';
                    
                    children.forEach(child => {
                        // 計算年齡
                        const birthDate = new Date(child.birthdate);
                        const today = new Date();
                        const ageInMonths = Math.floor((today - birthDate) / (1000 * 60 * 60 * 24 * 30.44));
                        const ageYears = Math.floor(ageInMonths / 12);
                        const ageMonths = ageInMonths % 12;
                        const ageString = ageYears > 0 
                            ? `${ageYears}歲${ageMonths}個月` 
                            : `${ageMonths}個月`;
                        
                        const childItem = document.createElement('div');
                        childItem.className = 'settings-item';
                        
                        let avatarHTML = '';
                        if (child.avatar) {
                            avatarHTML = `<img src="${child.avatar}" alt="${child.name}" style="width: 40px; height: 40px; border-radius: 50%; margin-right: 10px;">`;
                        }
                        
                        childItem.innerHTML = `
                            <div style="display: flex; align-items: center;">
                                ${avatarHTML}
                                <div>
                                    <div>${child.name}</div>
                                    <div style="font-size: 0.8rem; color: var(--text-light);">${ageString} (${formatDate(birthDate)})</div>
                                </div>
                            </div>
                            <button class="btn-sm" data-id="${child.id}">編輯</button>
                        `;
                        
                        // 綁定編輯按鈕
                        childItem.querySelector('.btn-sm').addEventListener('click', () => {
                            showEditChildModal(child);
                        });
                        
                        childSettingsElement.appendChild(childItem);
                    });
                    
                    // 如果孩子數量少於 4 個，顯示新增按鈕
                    if (children.length < 4) {
                        const addButton = document.createElement('button');
                        addButton.className = 'btn';
                        addButton.style.width = '100%';
                        addButton.style.marginTop = '16px';
                        addButton.textContent = '新增寶寶';
                        
                        addButton.addEventListener('click', () => {
                            showAddChildModal();
                        });
                        
                        childSettingsElement.appendChild(addButton);
                    }
                }
            };
        }

        // 顯示編輯孩子資料彈窗
        function showEditChildModal(child) {
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            
            modalTitle.textContent = '編輯寶寶資料';
            modalBody.innerHTML = `
                <form id="edit-child-form">
                    <div class="form-group">
                        <label class="form-label">寶寶暱稱</label>
                        <input type="text" class="form-control" id="child-name" value="${child.name}" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">性別</label>
                        <div class="toggle-group" id="child-gender">
                            <div class="toggle-option ${child.gender === '男' ? 'active' : ''}" data-value="男">男寶寶</div>
                            <div class="toggle-option ${child.gender === '女' ? 'active' : ''}" data-value="女">女寶寶</div>
                            <div class="toggle-option ${child.gender === '其他' ? 'active' : ''}" data-value="其他">其他</div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">出生日期</label>
                        <input type="date" class="form-control" id="child-birthdate" value="${child.birthdate}" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">更新頭像</label>
                        <input type="file" id="child-avatar" class="file-input" accept="image/*">
                        <label for="child-avatar" class="file-label">選擇照片</label>
                        <div id="avatar-preview" class="image-preview" style="display: ${child.avatar ? 'block' : 'none'};">
                            <img id="avatar-image" src="${child.avatar || ''}" alt="預覽">
                        </div>
                    </div>
                    
                    <button type="submit" class="btn" style="width: 100%;">儲存</button>
                    
                    <button type="button" class="btn" style="width: 100%; margin-top: 16px; background-color: #ff6b6b;" id="delete-child-btn">刪除寶寶資料</button>
                </form>
            `;
            
            // 頭像預覽
            const avatarInput = document.getElementById('child-avatar');
            const avatarPreview = document.getElementById('avatar-preview');
            const avatarImage = document.getElementById('avatar-image');
            
            avatarInput.addEventListener('change', (e) => {
                if (e.target.files && e.target.files[0]) {
                    const reader = new FileReader();
                    
                    reader.onload = (e) => {
                        avatarImage.src = e.target.result;
                        avatarPreview.style.display = 'block';
                    };
                    
                    reader.readAsDataURL(e.target.files[0]);
                }
            });
            
            // 性別選擇切換
            const genderOptions = modalBody.querySelectorAll('#child-gender .toggle-option');
            let selectedGender = child.gender;
            
            genderOptions.forEach(option => {
                option.addEventListener('click', () => {
                    genderOptions.forEach(opt => opt.classList.remove('active'));
                    option.classList.add('active');
                    selectedGender = option.dataset.value;
                });
            });
            
            // 表單提交
            const form = document.getElementById('edit-child-form');
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const name = document.getElementById('child-name').value.trim();
                const birthdate = document.getElementById('child-birthdate').value;
                
                if (!name || !birthdate || !selectedGender) {
                    showToast('請填寫所有欄位');
                    return;
                }
                
                // 更新孩子資料
                const updatedChild = {
                    ...child,
                    name: name,
                    gender: selectedGender,
                    birthdate: birthdate,
                    avatar: avatarImage.src
                };
                
                updateChild(updatedChild);
            });
            
            // 綁定刪除按鈕
            document.getElementById('delete-child-btn').addEventListener('click', () => {
                if (confirm(`確定要刪除 ${child.name} 的所有資料嗎？此操作無法復原。`)) {
                    deleteChild(child.id);
                }
            });
            
            openModal();
        }

        // 更新孩子資料
        function updateChild(child) {
            const transaction = db.transaction(['children'], 'readwrite');
            const childrenStore = transaction.objectStore('children');
            
            const request = childrenStore.put(child);
            
            request.onsuccess = () => {
                showToast('成功更新寶寶資料');
                closeModal();
                
                // 刷新孩子選擇器
                loadChildrenSelector();
                
                // 刷新設定頁面
                if (currentPage === 'settings') {
                    loadChildSettings();
                }
            };
            
            request.onerror = () => {
                showToast('更新寶寶資料失敗');
            };
        }

        // 刪除孩子資料
        function deleteChild(childId) {
            // 刪除孩子資料
            const transaction = db.transaction(['children'], 'readwrite');
            const childrenStore = transaction.objectStore('children');
            
            childrenStore.delete(childId);
            
            transaction.oncomplete = () => {
                // 刪除與該孩子相關的所有記錄
                deleteChildRecords(childId, () => {
                    showToast('成功刪除寶寶資料');
                    closeModal();
                    
                    // 如果當前選中的是被刪除的孩子，重置當前選中的孩子
                    if (currentChildId === childId) {
                        currentChildId = null;
                    }
                    
                    // 刷新孩子選擇器
                    loadChildrenSelector();
                });
            };
        }

        // 刪除與孩子相關的所有記錄
        function deleteChildRecords(childId, callback) {
            const storeNames = ['feeding', 'sleep', 'diaper', 'activities', 'milestones', 'health', 'interactions'];
            let completed = 0;
            
            storeNames.forEach(storeName => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const index = store.index('childId');
                const request = index.openCursor(IDBKeyRange.only(childId));
                
                request.onsuccess = (event) => {
                    const cursor = event.target.result;
                    
                    if (cursor) {
                        store.delete(cursor.primaryKey);
                        cursor.continue();
                    }
                };
                
                transaction.oncomplete = () => {
                    completed++;
                    
                    if (completed === storeNames.length) {
                        callback();
                    }
                };
            });
        }

        // 備份資料
        function backupData() {
            const backup = {
                children: [],
                feeding: [],
                sleep: [],
                diaper: [],
                milestones: [],
                activities: [],
                health: [],
                interactions: []
            };
            
            // 保存所有數據表
            let storesCompleted = 0;
            
            // 獲取孩子資料
            const transaction1 = db.transaction(['children'], 'readonly');
            const childrenStore = transaction1.objectStore('children');
            const request1 = childrenStore.getAll();
            
            request1.onsuccess = () => {
                backup.children = request1.result;
                storesCompleted++;
                checkCompletion();
            };
            
            // 獲取餵食記錄
            const transaction2 = db.transaction(['feeding'], 'readonly');
            const feedingStore = transaction2.objectStore('feeding');
            const request2 = feedingStore.getAll();
            
            request2.onsuccess = () => {
                backup.feeding = request2.result;
                storesCompleted++;
                checkCompletion();
            };
            
            // 獲取睡眠記錄
            const transaction3 = db.transaction(['sleep'], 'readonly');
            const sleepStore = transaction3.objectStore('sleep');
            const request3 = sleepStore.getAll();
            
            request3.onsuccess = () => {
                backup.sleep = request3.result;
                storesCompleted++;
                checkCompletion();
            };
            
            // 獲取尿布記錄
            const transaction4 = db.transaction(['diaper'], 'readonly');
            const diaperStore = transaction4.objectStore('diaper');
            const request4 = diaperStore.getAll();
            
            request4.onsuccess = () => {
                backup.diaper = request4.result;
                storesCompleted++;
                checkCompletion();
            };
            
            // 獲取里程碑記錄
            const transaction5 = db.transaction(['milestones'], 'readonly');
            const milestonesStore = transaction5.objectStore('milestones');
            const request5 = milestonesStore.getAll();
            
            request5.onsuccess = () => {
                backup.milestones = request5.result;
                storesCompleted++;
                checkCompletion();
            };
            
            // 獲取活動記錄
            const transaction6 = db.transaction(['activities'], 'readonly');
            const activitiesStore = transaction6.objectStore('activities');
            const request6 = activitiesStore.getAll();
            
            request6.onsuccess = () => {
                backup.activities = request6.result;
                storesCompleted++;
                checkCompletion();
            };
            
            // 獲取健康記錄
            const transaction7 = db.transaction(['health'], 'readonly');
            const healthStore = transaction7.objectStore('health');
            const request7 = healthStore.getAll();
            
            request7.onsuccess = () => {
                backup.health = request7.result;
                storesCompleted++;
                checkCompletion();
            };
            
            // 獲取親子互動記錄
            const transaction8 = db.transaction(['interactions'], 'readonly');
            const interactionsStore = transaction8.objectStore('interactions');
            const request8 = interactionsStore.getAll();
            
            request8.onsuccess = () => {
                backup.interactions = request8.result;
                storesCompleted++;
                checkCompletion();
            };
            
            // 檢查是否完成所有數據表的備份
            function checkCompletion() {
                if (storesCompleted === 8) {
                    // 所有數據表都已備份
                    const backupJson = JSON.stringify(backup);
                    const blob = new Blob([backupJson], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    
                    // 創建下載連結
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `BabyCare_Backup_${formatDateForFilename(new Date())}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    
                    showToast('備份檔案已下載');
                }
            }
        }

        // 還原資料
        function restoreData(backup) {
            // 確認備份資料包含所有必要的表格
            const requiredTables = ['children', 'feeding', 'sleep', 'diaper', 'milestones', 'activities', 'health', 'interactions'];
            
            for (const table of requiredTables) {
                if (!backup[table] || !Array.isArray(backup[table])) {
                    showToast('備份檔案格式錯誤');
                    return;
                }
            }
            
            // 確認用戶真的要還原
            if (!confirm('還原將會覆蓋所有現有資料，確定要繼續嗎？')) {
                return;
            }
            
            // 關閉當前資料庫連接
            db.close();
            
            // 刪除資料庫
            const deleteRequest = indexedDB.deleteDatabase(DB_NAME);
            
            deleteRequest.onsuccess = () => {
                // 重新打開資料庫
                const openRequest = indexedDB.open(DB_NAME, DB_VERSION);
                
                openRequest.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    
                    // 創建所有表格
                    if (!db.objectStoreNames.contains('children')) {
                        const childrenStore = db.createObjectStore('children', { keyPath: 'id' });
                        childrenStore.createIndex('name', 'name', { unique: false });
                    }
                    
                    if (!db.objectStoreNames.contains('feeding')) {
                        const feedingStore = db.createObjectStore('feeding', { keyPath: 'id', autoIncrement: true });
                        feedingStore.createIndex('childId', 'childId', { unique: false });
                        feedingStore.createIndex('timestamp', 'timestamp', { unique: false });
                    }
                    
                    if (!db.objectStoreNames.contains('sleep')) {
                        const sleepStore = db.createObjectStore('sleep', { keyPath: 'id', autoIncrement: true });
                        sleepStore.createIndex('childId', 'childId', { unique: false });
                        sleepStore.createIndex('timestamp', 'timestamp', { unique: false });
                    }
                    
                    if (!db.objectStoreNames.contains('diaper')) {
                        const diaperStore = db.createObjectStore('diaper', { keyPath: 'id', autoIncrement: true });
                        diaperStore.createIndex('childId', 'childId', { unique: false });
                        diaperStore.createIndex('timestamp', 'timestamp', { unique: false });
                    }
                    
                    if (!db.objectStoreNames.contains('milestones')) {
                        const milestonesStore = db.createObjectStore('milestones', { keyPath: 'id', autoIncrement: true });
                        milestonesStore.createIndex('childId', 'childId', { unique: false });
                        milestonesStore.createIndex('category', 'category', { unique: false });
                    }
                    
                    if (!db.objectStoreNames.contains('activities')) {
                        const activitiesStore = db.createObjectStore('activities', { keyPath: 'id', autoIncrement: true });
                        activitiesStore.createIndex('childId', 'childId', { unique: false });
                        activitiesStore.createIndex('timestamp', 'timestamp', { unique: false });
                        activitiesStore.createIndex('type', 'type', { unique: false });
                    }
                    
                    if (!db.objectStoreNames.contains('health')) {
                        const healthStore = db.createObjectStore('health', { keyPath: 'id', autoIncrement: true });
                        healthStore.createIndex('childId', 'childId', { unique: false });
                        healthStore.createIndex('timestamp', 'timestamp', { unique: false });
                        healthStore.createIndex('type', 'type', { unique: false });
                    }
                    
                    if (!db.objectStoreNames.contains('interactions')) {
                        const interactionsStore = db.createObjectStore('interactions', { keyPath: 'id', autoIncrement: true });
                        interactionsStore.createIndex('childId', 'childId', { unique: false });
                        interactionsStore.createIndex('timestamp', 'timestamp', { unique: false });
                    }
                };
                
                openRequest.onsuccess = (event) => {
                    const db = event.target.result;
                    
                    // 恢復所有數據
                    const transaction = db.transaction(requiredTables, 'readwrite');
                    
                    // 恢復孩子資料
                    const childrenStore = transaction.objectStore('children');
                    backup.children.forEach(child => {
                        childrenStore.add(child);
                    });
                    
                    // 恢復餵食記錄
                    const feedingStore = transaction.objectStore('feeding');
                    backup.feeding.forEach(record => {
                        feedingStore.add(record);
                    });
                    
                    // 恢復睡眠記錄
                    const sleepStore = transaction.objectStore('sleep');
                    backup.sleep.forEach(record => {
                        sleepStore.add(record);
                    });
                    
                    // 恢復尿布記錄
                    const diaperStore = transaction.objectStore('diaper');
                    backup.diaper.forEach(record => {
                        diaperStore.add(record);
                    });
                    
                    // 恢復里程碑記錄
                    const milestonesStore = transaction.objectStore('milestones');
                    backup.milestones.forEach(record => {
                        milestonesStore.add(record);
                    });
                    
                    // 恢復活動記錄
                    const activitiesStore = transaction.objectStore('activities');
                    backup.activities.forEach(record => {
                        activitiesStore.add(record);
                    });
                    
                    // 恢復健康記錄
                    const healthStore = transaction.objectStore('health');
                    backup.health.forEach(record => {
                        healthStore.add(record);
                    });
                    
                    // 恢復親子互動記錄
                    const interactionsStore = transaction.objectStore('interactions');
                    backup.interactions.forEach(record => {
                        interactionsStore.add(record);
                    });
                    
                    transaction.oncomplete = () => {
                        showToast('成功還原資料');
                        
                        // 重新載入頁面
                        setTimeout(() => {
                            window.location.reload();
                        }, 2000);
                    };
                    
                    transaction.onerror = (event) => {
                        showToast('還原資料失敗');
                        console.error('還原資料錯誤:', event.target.error);
                    };
                };
            };
        }

        // 清除所有資料
        function clearAllData() {
            // 關閉當前資料庫連接
            db.close();
            
            // 刪除資料庫
            const deleteRequest = indexedDB.deleteDatabase(DB_NAME);
            
            deleteRequest.onsuccess = () => {
                showToast('已清除所有資料');
                
                // 重新載入頁面
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            };
            
            deleteRequest.onerror = () => {
                showToast('清除資料失敗');
            };
        }

        // 通用記錄操作功能

        // 新增記錄
        function addRecord(storeName, data, callback) {
            const transaction = db.transaction([storeName], 'readwrite');
            const store = transaction.objectStore(storeName);
            
            const request = store.add(data);
            
            request.onsuccess = () => {
                if (callback) callback();
            };
            
            request.onerror = () => {
                showToast(`新增${storeName}記錄失敗`);
            };
        }

        // 刪除記錄
        function deleteRecord(storeName, id, callback) {
            const transaction = db.transaction([storeName], 'readwrite');
            const store = transaction.objectStore(storeName);
            
            const request = store.delete(id);
            
            request.onsuccess = () => {
                showToast('成功刪除記錄');
                if (callback) callback();
            };
            
            request.onerror = () => {
                showToast('刪除記錄失敗');
            };
        }

        // 獲取指定孩子的記錄
        function getChildById(childId, callback) {
            const transaction = db.transaction(['children'], 'readonly');
            const childrenStore = transaction.objectStore('children');
            
            const request = childrenStore.get(childId);
            
            request.onsuccess = () => {
                if (callback) callback(request.result);
            };
        }

        // 獲取最近的記錄
        function getRecentRecords(storeName, limit, callback) {
            const transaction = db.transaction([storeName], 'readonly');
            const store = transaction.objectStore(storeName);
            const index = store.index('childId');
            const range = IDBKeyRange.only(currentChildId);
            const request = index.openCursor(range, 'prev');
            
            let records = [];
            let count = 0;
            
            request.onsuccess = (event) => {
                const cursor = event.target.result;
                
                if (cursor && count < limit) {
                    records.push(cursor.value);
                    count++;
                    cursor.continue();
                } else {
                    if (callback) callback(records);
                }
            };
        }

        // 獲取今日記錄數量
        function getTodayRecordsCount(storeName, callback) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            getRecordsBetweenDates(storeName, today, tomorrow, (records) => {
                if (callback) callback(records.length);
            });
        }

        // 獲取指定日期範圍內的記錄
        function getRecordsBetweenDates(storeName, startDate, endDate, callback) {
            const transaction = db.transaction([storeName], 'readonly');
            const store = transaction.objectStore(storeName);
            const index = store.index('timestamp');
            const range = IDBKeyRange.bound(startDate.toISOString(), endDate.toISOString());
            
            // 篩選特定孩子的記錄
            const request = store.index('childId').openCursor(IDBKeyRange.only(currentChildId));
            
            let records = [];
            
            request.onsuccess = (event) => {
                const cursor = event.target.result;
                
                if (cursor) {
                    const record = cursor.value;
                    const recordDate = new Date(record.timestamp);
                    
                    if (recordDate >= startDate && recordDate < endDate) {
                        records.push(record);
                    }
                    
                    cursor.continue();
                } else {
                    if (callback) callback(records);
                }
            };
        }

        // 獲取今日睡眠時數
        function getTodaySleepHours(callback) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            getRecordsBetweenDates('sleep', today, tomorrow, (records) => {
                const totalMinutes = records.reduce((total, record) => total + (record.duration || 0), 0);
                const hours = totalMinutes / 60;
                
                if (callback) callback(hours);
            });
        }

        // 獲取平均餵食間隔（小時）
        function getAverageFeedingInterval(callback) {
            const transaction = db.transaction(['feeding'], 'readonly');
            const store = transaction.objectStore('feeding');
            const index = store.index('childId');
            const range = IDBKeyRange.only(currentChildId);
            const request = index.openCursor(range);
            
            let timestamps = [];
            
            request.onsuccess = (event) => {
                const cursor = event.target.result;
                
                if (cursor) {
                    timestamps.push(new Date(cursor.value.timestamp));
                    cursor.continue();
                } else {
                    // 按時間排序
                    timestamps.sort((a, b) => a - b);
                    
                    // 計算間隔
                    let totalIntervals = 0;
                    let intervalCount = 0;
                    
                    for (let i = 1; i < timestamps.length; i++) {
                        const interval = (timestamps[i] - timestamps[i - 1]) / (1000 * 60 * 60); // 小時
                        
                        // 只計算 24 小時內的間隔
                        if (interval < 24) {
                            totalIntervals += interval;
                            intervalCount++;
                        }
                    }
                    
                    const avgInterval = intervalCount > 0 ? totalIntervals / intervalCount : null;
                    
                    if (callback) callback(avgInterval);
                }
            };
        }

        // 獲取平均睡眠品質
        function getAverageSleepQuality(callback) {
            const transaction = db.transaction(['sleep'], 'readonly');
            const store = transaction.objectStore('sleep');
            const index = store.index('childId');
            const range = IDBKeyRange.only(currentChildId);
            const request = index.openCursor(range);
            
            let qualityCounts = {
                good: 0,
                normal: 0,
                poor: 0
            };
            
            request.onsuccess = (event) => {
                const cursor = event.target.result;
                
                if (cursor) {
                    qualityCounts[cursor.value.quality]++;
                    cursor.continue();
                } else {
                    // 找出最多的品質
                    let maxQuality = 'normal';
                    
                    if (qualityCounts.good > qualityCounts[maxQuality]) {
                        maxQuality = 'good';
                    }
                    
                    if (qualityCounts.poor > qualityCounts[maxQuality]) {
                        maxQuality = 'poor';
                    }
                    
                    if (callback) callback(maxQuality);
                }
            };
        }

        // 獲取尿布類型分布
        function getDiaperTypeDistribution(callback) {
            const transaction = db.transaction(['diaper'], 'readonly');
            const store = transaction.objectStore('diaper');
            const index = store.index('childId');
            const range = IDBKeyRange.only(currentChildId);
            const request = index.openCursor(range);
            
            let typeCounts = {
                wet: 0,
                dirty: 0,
                mixed: 0
            };
            
            request.onsuccess = (event) => {
                const cursor = event.target.result;
                
                if (cursor) {
                    typeCounts[cursor.value.type]++;
                    cursor.continue();
                } else {
                    if (callback) callback(typeCounts);
                }
            };
        }

        // 獲取健康記錄（按類型）
        function getHealthRecordsByType(type, callback) {
            const transaction = db.transaction(['health'], 'readonly');
            const store = transaction.objectStore('health');
            const index = store.index('childId');
            const range = IDBKeyRange.only(currentChildId);
            const request = index.openCursor(range);
            
            let records = [];
            
            request.onsuccess = (event) => {
                const cursor = event.target.result;
                
                if (cursor) {
                    if (cursor.value.type === type) {
                        records.push(cursor.value);
                    }
                    cursor.continue();
                } else {
                    // 按時間排序（從新到舊）
                    records.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    
                    if (callback) callback(records);
                }
            };
        }

        // 工具函數

        // 格式化日期（年月日）
        function formatDate(date, short = false) {
            if (short) {
                return `${date.getFullYear()}/${String(date.getMonth() + 1).padStart(2, '0')}/${String(date.getDate()).padStart(2, '0')}`;
            } else {
                return `${date.getFullYear()} 年 ${date.getMonth() + 1} 月 ${date.getDate()} 日`;
            }
        }

        // 格式化日期（僅年月日，用於 input[type="date"]）
        function formatDateOnly(date) {
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        }

        // 格式化時間（時分）
        function formatTime(date) {
            return `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
        }

        // 格式化日期時間
        function formatDateTime(date) {
            return `${formatDate(date, true)} ${formatTime(date)}`;
        }

        // 格式化日期時間（用於 input[type="datetime-local"]）
        function formatDateTimeLocal(date) {
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}T${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
        }

        // 格式化星期幾
        function formatDayOfWeek(date) {
            const days = ['日', '一', '二', '三', '四', '五', '六'];
            return days[date.getDay()];
        }

        // 格式化日期（用於檔名）
        function formatDateForFilename(date) {
            return `${date.getFullYear()}${String(date.getMonth() + 1).padStart(2, '0')}${String(date.getDate()).padStart(2, '0')}_${String(date.getHours()).padStart(2, '0')}${String(date.getMinutes()).padStart(2, '0')}`;
        }

        // 載入主題設定
        function loadTheme() {
            const savedTheme = localStorage.getItem('theme');
            
            if (savedTheme) {
                document.documentElement.setAttribute('data-theme', savedTheme);
            } else {
                // 預設使用系統主題
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.documentElement.setAttribute('data-theme', 'dark');
                }
            }
        }

        // 初始化應用程式
        function init() {
            // 初始化 IndexedDB
            initDB();
            
            // 載入主題設定
            loadTheme();
            
            // 綁定導覽列項目點擊事件
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    updatePage(item.dataset.page);
                });
            });
            
            // 綁定模態框關閉按鈕
            document.getElementById('modal-close').addEventListener('click', closeModal);
            
            // 點擊模態框背景關閉
            document.getElementById('modal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('modal')) {
                    closeModal();
                }
            });
            
            // 監聽系統主題變化
            if (window.matchMedia) {
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                    if (!localStorage.getItem('theme')) {
                        document.documentElement.setAttribute('data-theme', e.matches ? 'dark' : 'light');
                    }
                });
            }
        }

        // 啟動應用程式
        init();
    </script>
   <script src="debug.js"></script>
</body>
</html>