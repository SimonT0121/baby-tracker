<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#f8f3eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>ÂØ∂ÂØ∂ÁÖßË≠∑Á≠ÜË®ò</title>
    <style>
        :root {
            --primary: #7caacb;
            --primary-light: #d4e5f7;
            --secondary: #f3a683;
            --secondary-light: #fce8d9;
            --tertiary: #a0c1b8;
            --tertiary-light: #e5f0ee;
            --background: #f8f3eb;
            --card-bg: #ffffff;
            --text: #383838;
            --text-light: #767676;
            --border: #eaeaea;
            --shadow: rgba(0, 0, 0, 0.05);
            
            --font-main: system-ui, -apple-system, "PingFang TC", "Microsoft JhengHei", sans-serif;
            --radius: 12px;
            --spacing: 16px;
        }

        [data-theme="dark"] {
            --primary: #5a89ad;
            --primary-light: #2a4053;
            --secondary: #e3855e;
            --secondary-light: #4d3328;
            --tertiary: #7ba89e;
            --tertiary-light: #2c3b38;
            --background: #1a1a1a;
            --card-bg: #2c2c2c;
            --text: #f0f0f0;
            --text-light: #a0a0a0;
            --border: #3a3a3a;
            --shadow: rgba(0, 0, 0, 0.2);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--background);
            color: var(--text);
            min-height: 100vh;
            padding-bottom: 60px;
            overflow-x: hidden;
            line-height: 1.5;
        }

        .container {
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            padding: var(--spacing);
        }

        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--spacing);
            position: sticky;
            top: 0;
            background-color: var(--background);
            z-index: 10;
            padding: 12px var(--spacing);
            border-bottom: 1px solid var(--border);
        }

        .header-title {
            font-size: 1.2rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-action {
            display: flex;
            gap: 8px;
        }

        .child-selector {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: var(--spacing);
            overflow-x: auto;
            padding-bottom: 8px;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }

        .child-selector::-webkit-scrollbar {
            display: none;
        }

        .child-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--primary-light);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary);
            cursor: pointer;
            flex-shrink: 0;
            position: relative;
            transition: transform 0.2s;
            border: 2px solid transparent;
            overflow: hidden;
        }

        .child-avatar.active {
            border-color: var(--primary);
            transform: scale(1.1);
        }

        .child-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .add-child {
            background-color: var(--border);
            color: var(--text-light);
        }

        .card {
            background-color: var(--card-bg);
            border-radius: var(--radius);
            padding: var(--spacing);
            margin-bottom: var(--spacing);
            box-shadow: 0 2px 10px var(--shadow);
            overflow: hidden;
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .card-title {
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
        }

        .card-content {
            margin-bottom: 12px;
        }

        .overview-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }

        .overview-item {
            background-color: var(--primary-light);
            border-radius: var(--radius);
            padding: 12px 8px;
            text-align: center;
        }

        .overview-item.feeding {
            background-color: var(--primary-light);
        }

        .overview-item.sleep {
            background-color: var(--secondary-light);
        }

        .overview-item.diaper {
            background-color: var(--tertiary-light);
        }

        .overview-number {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .overview-label {
            font-size: 0.85rem;
            color: var(--text-light);
        }

        .quick-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 16px;
        }

        .action-btn {
            background-color: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 8px 16px;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: background-color 0.2s;
            color: var(--text);
            flex-grow: 1;
            justify-content: center;
            white-space: nowrap;
        }

        .action-btn:active {
            background-color: var(--border);
        }

        .btn {
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 24px;
            padding: 8px 16px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .btn:active {
            opacity: 0.8;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.8rem;
        }

        .btn-text {
            background: none;
            border: none;
            color: var(--primary);
            cursor: pointer;
            font-size: 0.9rem;
        }

        .btn-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--primary-light);
            color: var(--primary);
            border: none;
            cursor: pointer;
        }

        .nav-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--card-bg);
            display: flex;
            justify-content: space-around;
            padding: 8px 0;
            box-shadow: 0 -2px 10px var(--shadow);
            z-index: 100;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 4px 0;
            cursor: pointer;
            color: var(--text-light);
            font-size: 0.7rem;
            width: 20%;
        }

        .nav-item.active {
            color: var(--primary);
        }

        .nav-icon {
            font-size: 1.3rem;
            margin-bottom: 2px;
        }

        .records-list {
            max-height: 300px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .record-item {
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .record-item:last-child {
            border-bottom: none;
        }

        .record-main {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .record-time {
            font-size: 0.8rem;
            color: var(--text-light);
        }

        .record-details {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .record-tag {
            font-size: 0.8rem;
            background-color: var(--primary-light);
            padding: 2px 8px;
            border-radius: 12px;
            color: var(--primary);
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: var(--text-light);
        }

        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-family: var(--font-main);
            font-size: 1rem;
            background-color: var(--card-bg);
            color: var(--text);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
        }

        .toggle-group {
            display: flex;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
        }

        .toggle-option {
            flex: 1;
            padding: 8px 0;
            text-align: center;
            background-color: var(--card-bg);
            cursor: pointer;
            font-size: 0.9rem;
            border-right: 1px solid var(--border);
        }

        .toggle-option:last-child {
            border-right: none;
        }

        .toggle-option.active {
            background-color: var(--primary);
            color: white;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .modal.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: var(--card-bg);
            border-radius: var(--radius);
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            padding: var(--spacing);
            transform: translateY(20px);
            transition: transform 0.3s;
        }

        .modal.active .modal-content {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .modal-title {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.5rem;
            color: var(--text-light);
            line-height: 1;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            margin-bottom: 16px;
            gap: 16px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }

        .tabs::-webkit-scrollbar {
            display: none;
        }

        .tab {
            padding: 8px 4px;
            cursor: pointer;
            font-size: 0.9rem;
            color: var(--text-light);
            position: relative;
            white-space: nowrap;
        }

        .tab.active {
            color: var(--primary);
            font-weight: 600;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background-color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .stat-chart {
            height: 150px;
            margin: 16px 0;
            display: flex;
            align-items: flex-end;
            gap: 6px;
        }

        .stat-bar {
            flex: 1;
            background-color: var(--primary-light);
            position: relative;
            border-radius: 4px 4px 0 0;
            min-height: 4px;
        }

        .stat-label {
            position: absolute;
            bottom: -24px;
            left: 0;
            right: 0;
            font-size: 0.7rem;
            text-align: center;
            color: var(--text-light);
        }

        .mini-stat {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 0.9rem;
        }

        .mini-stat-value {
            font-weight: 600;
        }

        .empty-state {
            text-align: center;
            padding: 32px 0;
            color: var(--text-light);
        }

        .empty-icon {
            font-size: 3rem;
            margin-bottom: 16px;
            opacity: 0.2;
        }

        .empty-text {
            font-size: 0.9rem;
        }

        .timer-display {
            font-size: 2.5rem;
            text-align: center;
            margin: 24px 0;
            font-weight: 600;
            font-variant-numeric: tabular-nums;
        }

        .timer-controls {
            display: flex;
            justify-content: center;
            gap: 16px;
        }

        .timer-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            border: none;
            cursor: pointer;
        }

        .timer-start {
            background-color: var(--primary);
            color: white;
        }

        .timer-stop {
            background-color: var(--secondary);
            color: white;
        }

        .milestone-item {
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            margin-bottom: 12px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .milestone-item.completed {
            background-color: var(--tertiary-light);
            border-color: var(--tertiary);
        }

        .milestone-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }

        .milestone-age {
            font-size: 0.8rem;
            color: var(--text-light);
        }

        .checkmark {
            color: var(--tertiary);
        }

        .settings-item {
            padding: 16px 0;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .settings-item:last-child {
            border-bottom: none;
        }

        .photo-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 16px;
        }

        .photo-item {
            aspect-ratio: 1;
            background-color: var(--primary-light);
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }

        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-date {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            font-size: 0.7rem;
            padding: 4px;
            text-align: center;
        }

        .interaction-photo {
            margin-top: 8px;
            width: 100%;
            border-radius: 8px;
            overflow: hidden;
            max-height: 200px;
        }

        .interaction-photo img {
            width: 100%;
            object-fit: cover;
        }

        .growth-chart {
            padding: 16px 0;
        }

        .chart-line {
            position: relative;
            height: 2px;
            background-color: var(--border);
            margin: 40px 0;
        }

        .chart-point {
            position: absolute;
            width: 12px;
            height: 12px;
            background-color: var(--primary);
            border-radius: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            cursor: pointer;
        }

        .chart-point::after {
            content: attr(data-value);
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.8rem;
            white-space: nowrap;
        }

        .chart-point::before {
            content: attr(data-date);
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.7rem;
            color: var(--text-light);
            white-space: nowrap;
        }

        .chart-section-title {
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: var(--text-light);
        }

        .toast {
            position: fixed;
            bottom: 70px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 16px;
            border-radius: 24px;
            font-size: 0.9rem;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .toast.active {
            opacity: 1;
        }

        .loader {
            width: 36px;
            height: 36px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            margin: 20px auto;
            animation: spin 1s infinite linear;
        }

        .image-preview {
            width: 100%;
            height: 200px;
            margin-top: 8px;
            border-radius: var(--radius);
            background-color: var(--primary-light);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .file-input {
            display: none;
        }

        .file-label {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 10px;
            background-color: var(--primary-light);
            color: var(--primary);
            border-radius: var(--radius);
            cursor: pointer;
        }

        .mood-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .mood-grid .toggle-option {
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 12px 8px;
            text-align: center;
            font-size: 0.85rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- Header (ÂãïÊÖãÊõ¥Êñ∞) -->
        <div class="header">
            <div class="header-title">
                <span id="page-title">È¶ñÈ†Å</span>
            </div>
            <div class="header-action" id="header-action">
                <!-- ÂãïÊÖãÊèíÂÖ•ÂÖßÂÆπ -->
            </div>
        </div>

        <!-- ÂÖíÁ´•ÈÅ∏ÊìáÂô® -->
        <div class="container" id="child-selector-container">
            <div class="child-selector" id="child-selector">
                <!-- ÂãïÊÖãÊèíÂÖ•ÂÖíÁ´•È†≠ÂÉè -->
            </div>
        </div>

        <!-- ‰∏ªË¶ÅÂÖßÂÆπÂçÄÂüü -->
        <div class="container" id="main-content">
            <!-- ÂÖßÂÆπÂ∞áÁî± JavaScript ÂãïÊÖãÁîüÊàê -->
        </div>

        <!-- Â∞éË¶ΩÂàó -->
        <div class="nav-bar">
            <div class="nav-item active" data-page="home">
                <div class="nav-icon">üè†</div>
                <div>È¶ñÈ†Å</div>
            </div>
            <div class="nav-item" data-page="care">
                <div class="nav-icon">üçº</div>
                <div>ÁÖßË≠∑</div>
            </div>
            <div class="nav-item" data-page="development">
                <div class="nav-icon">üìà</div>
                <div>ÁôºÂ±ï</div>
            </div>
            <div class="nav-item" data-page="health">
                <div class="nav-icon">üíä</div>
                <div>ÂÅ•Â∫∑</div>
            </div>
            <div class="nav-item" data-page="settings">
                <div class="nav-icon">‚öôÔ∏è</div>
                <div>Ë®≠ÂÆö</div>
            </div>
        </div>
    </div>

    <!-- Ê®°ÊÖãÊ°Ü -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modal-title">Ê®ôÈ°å</div>
                <button class="modal-close" id="modal-close">√ó</button>
            </div>
            <div class="modal-body" id="modal-body">
                <!-- Ê®°ÊÖãÂÖßÂÆπÂ∞áÁî± JavaScript ÂãïÊÖãÁîüÊàê -->
            </div>
        </div>
    </div>

    <!-- ÂêêÂè∏ÊèêÁ§∫ -->
    <div class="toast" id="toast"></div>

    <script>
        // Â¨∞ÂπºÂÖíÁÖßË≠∑ËøΩËπ§Á≥ªÁµ± - ‰∏ªË¶ÅÁ®ãÂºèÁ¢º

        // ÂàùÂßãÂåñ IndexedDB
        let db;
        const DB_NAME = 'BabyCareDB';
        const DB_VERSION = 1;
        
        // Áï∂ÂâçÈÅ∏‰∏≠ÁöÑÂ≠©Â≠ê ID ÂèäÈ†ÅÈù¢
        let currentChildId = null;
        let currentPage = 'home';

        // ÂÆöÁæ© IndexedDB Êû∂Êßã
        function initDB() {
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            
            request.onerror = (event) => {
                showToast('Ë≥áÊñôÂ∫´ÈÄ£Êé•Â§±Êïó');
                console.error('IndexedDB ÈåØË™§:', event.target.error);
            };
            
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                
                // Â≠©Â≠êË≥áÊñôË°®
                if (!db.objectStoreNames.contains('children')) {
                    const childrenStore = db.createObjectStore('children', { keyPath: 'id' });
                    childrenStore.createIndex('name', 'name', { unique: false });
                }
                
                // È§µÈ£üÁ¥ÄÈåÑË°®
                if (!db.objectStoreNames.contains('feeding')) {
                    const feedingStore = db.createObjectStore('feeding', { keyPath: 'id', autoIncrement: true });
                    feedingStore.createIndex('childId', 'childId', { unique: false });
                    feedingStore.createIndex('timestamp', 'timestamp', { unique: false });
                }
                
                // Áù°Áú†Á¥ÄÈåÑË°®
                if (!db.objectStoreNames.contains('sleep')) {
                    const sleepStore = db.createObjectStore('sleep', { keyPath: 'id', autoIncrement: true });
                    sleepStore.createIndex('childId', 'childId', { unique: false });
                    sleepStore.createIndex('timestamp', 'timestamp', { unique: false });
                }
                
                // Â∞øÂ∏ÉÁ¥ÄÈåÑË°®
                if (!db.objectStoreNames.contains('diaper')) {
                    const diaperStore = db.createObjectStore('diaper', { keyPath: 'id', autoIncrement: true });
                    diaperStore.createIndex('childId', 'childId', { unique: false });
                    diaperStore.createIndex('timestamp', 'timestamp', { unique: false });
                }
                
                // ÁôºÂ±ïÈáåÁ®ãÁ¢ëË°®
                if (!db.objectStoreNames.contains('milestones')) {
                    const milestonesStore = db.createObjectStore('milestones', { keyPath: 'id', autoIncrement: true });
                    milestonesStore.createIndex('childId', 'childId', { unique: false });
                    milestonesStore.createIndex('category', 'category', { unique: false });
                }
                
                // Ê¥ªÂãïÁ¥ÄÈåÑË°®
                if (!db.objectStoreNames.contains('activities')) {
                    const activitiesStore = db.createObjectStore('activities', { keyPath: 'id', autoIncrement: true });
                    activitiesStore.createIndex('childId', 'childId', { unique: false });
                    activitiesStore.createIndex('timestamp', 'timestamp', { unique: false });
                    activitiesStore.createIndex('type', 'type', { unique: false });
                }
                
                // ÂÅ•Â∫∑Á¥ÄÈåÑË°®
                if (!db.objectStoreNames.contains('health')) {
                    const healthStore = db.createObjectStore('health', { keyPath: 'id', autoIncrement: true });
                    healthStore.createIndex('childId', 'childId', { unique: false });
                    healthStore.createIndex('timestamp', 'timestamp', { unique: false });
                    healthStore.createIndex('type', 'type', { unique: false });
                }
                
                // Ë¶™Â≠ê‰∫íÂãïË°®
                if (!db.objectStoreNames.contains('interactions')) {
                    const interactionsStore = db.createObjectStore('interactions', { keyPath: 'id', autoIncrement: true });
                    interactionsStore.createIndex('childId', 'childId', { unique: false });
                    interactionsStore.createIndex('timestamp', 'timestamp', { unique: false });
                }
            };
            
            request.onsuccess = (event) => {
                db = event.target.result;
                console.log('IndexedDB ÈÄ£Êé•ÊàêÂäü');
                
                // Ê™¢Êü•ÊòØÂê¶Â∑≤ÊúâÂ∞èÂ≠©Ë≥áÊñôÔºåÂ¶ÇÊûúÊ≤íÊúâÂâáÈ°ØÁ§∫ÂàùÂßãË®≠ÂÆöÁï´Èù¢
                checkAndInitializeApp();
            };
        }

        // Ê™¢Êü•ÊòØÂê¶Â∑≤ÊúâË≥áÊñô‰∏¶ÂàùÂßãÂåñÊáâÁî®Á®ãÂºè
        function checkAndInitializeApp() {
            const transaction = db.transaction(['children'], 'readonly');
            const childrenStore = transaction.objectStore('children');
            const countRequest = childrenStore.count();
            
            countRequest.onsuccess = () => {
                if (countRequest.result === 0) {
                    // Ê≤íÊúâÂ≠©Â≠êË≥áÊñôÔºåÈ°ØÁ§∫Ê≠°ËøéÁï´Èù¢
                    showWelcomeScreen();
                } else {
                    // Â∑≤ÊúâÂ≠©Â≠êË≥áÊñôÔºåËºâÂÖ•Á¨¨‰∏ÄÂÄãÂ≠©Â≠êÁöÑË≥áÊñô
                    loadChildrenSelector();
                }
            };
        }

        // È°ØÁ§∫Ê≠°Ëøé/ÂàùÂßãË®≠ÂÆöÁï´Èù¢
        function showWelcomeScreen() {
            document.getElementById('page-title').textContent = 'ÂØ∂ÂØ∂ÁÖßË≠∑Á≠ÜË®ò';
            document.getElementById('child-selector-container').style.display = 'none';
            
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Ê≠°Ëøé‰ΩøÁî®ÂØ∂ÂØ∂ÁÖßË≠∑Á≠ÜË®ò</div>
                    </div>
                    <div class="card-content">
                        <p>ÈÄôÊòØ‰∏ÄÊ¨æÂ∞àÁÇ∫Âè∞ÁÅ£Áà∂ÊØçË®≠Ë®àÁöÑÂ¨∞ÂπºÂÖíÁÖßË≠∑ËøΩËπ§Á≥ªÁµ±ÔºåÂπ´Âä©ÊÇ®Á∞°ÂñÆÂú∞Ë®òÈåÑÂØ∂ÂØ∂ÁöÑÊàêÈï∑Ê≠∑Á®ã„ÄÇ</p>
                        <div class="empty-state">
                            <div class="empty-icon">üë∂</div>
                            <div class="empty-text">ÈñãÂßãÂâçÔºåË´ãÂÖàÊñ∞Â¢ûÊÇ®ÁöÑÂØ∂ÂØ∂Ë≥áÊñô</div>
                        </div>
                    </div>
                    <button class="btn" style="width: 100%;" id="add-first-child-btn">Êñ∞Â¢ûÂØ∂ÂØ∂Ë≥áÊñô</button>
                </div>
            `;
            
            // Á∂ÅÂÆöÊñ∞Â¢ûÁ¨¨‰∏ÄÂÄãÂ≠©Â≠êÊåâÈàï‰∫ã‰ª∂
            document.getElementById('add-first-child-btn').addEventListener('click', () => {
                showAddChildModal();
            });
        }

        // È°ØÁ§∫Êñ∞Â¢ûÂ≠©Â≠êÂΩàÁ™ó
        function showAddChildModal() {
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            
            modalTitle.textContent = 'Êñ∞Â¢ûÂØ∂ÂØ∂Ë≥áÊñô';
            modalBody.innerHTML = `
                <form id="add-child-form">
                    <div class="form-group">
                        <label class="form-label">ÂØ∂ÂØ∂Êö±Á®±</label>
                        <input type="text" class="form-control" id="child-name" placeholder="‰æãÔºöÂ∞èÂØ∂" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ÊÄßÂà•</label>
                        <div class="toggle-group">
                            <div class="toggle-option" data-value="Áî∑">Áî∑ÂØ∂ÂØ∂</div>
                            <div class="toggle-option" data-value="Â•≥">Â•≥ÂØ∂ÂØ∂</div>
                            <div class="toggle-option" data-value="ÂÖ∂‰ªñ">ÂÖ∂‰ªñ</div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Âá∫ÁîüÊó•Êúü</label>
                        <input type="date" class="form-control" id="child-birthdate" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">‰∏äÂÇ≥È†≠ÂÉè</label>
                        <input type="file" id="child-avatar" class="file-input" accept="image/*">
                        <label for="child-avatar" class="file-label">ÈÅ∏ÊìáÁÖßÁâá</label>
                        <div id="avatar-preview" class="image-preview" style="display: none;">
                            <img id="avatar-image" src="" alt="È†êË¶Ω">
                        </div>
                    </div>
                    <button type="submit" class="btn" style="width: 100%;">ÂÑ≤Â≠ò</button>
                </form>
            `;
            
            // ÊÄßÂà•ÈÅ∏ÊìáÂàáÊèõ
            const toggleOptions = modalBody.querySelectorAll('.toggle-option');
            let selectedGender = null;
            
            toggleOptions.forEach(option => {
                option.addEventListener('click', () => {
                    toggleOptions.forEach(opt => opt.classList.remove('active'));
                    option.classList.add('active');
                    selectedGender = option.dataset.value;
                });
            });
            
            // È†≠ÂÉèÈ†êË¶Ω
            const avatarInput = document.getElementById('child-avatar');
            const avatarPreview = document.getElementById('avatar-preview');
            const avatarImage = document.getElementById('avatar-image');
            
            avatarInput.addEventListener('change', (e) => {
                if (e.target.files && e.target.files[0]) {
                    const reader = new FileReader();
                    
                    reader.onload = (e) => {
                        avatarImage.src = e.target.result;
                        avatarPreview.style.display = 'block';
                    };
                    
                    reader.readAsDataURL(e.target.files[0]);
                }
            });
            
            // Ë°®ÂñÆÊèê‰∫§
            const form = document.getElementById('add-child-form');
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const name = document.getElementById('child-name').value.trim();
                const birthdate = document.getElementById('child-birthdate').value;
                
                if (!name || !birthdate || !selectedGender) {
                    showToast('Ë´ãÂ°´ÂØ´ÊâÄÊúâÊ¨Ñ‰Ωç');
                    return;
                }
                
                // Êñ∞Â¢ûÂ≠©Â≠êË≥áÊñôÂà∞ IndexedDB
                const childData = {
                    id: generateId(),
                    name: name,
                    gender: selectedGender,
                    birthdate: birthdate,
                    createdAt: new Date().toISOString(),
                    avatar: avatarImage.src || null
                };
                
                addChild(childData);
            });
            
            openModal();
        }

        // Êñ∞Â¢ûÂ≠©Â≠êÂà∞Ë≥áÊñôÂ∫´
        function addChild(childData) {
            const transaction = db.transaction(['children'], 'readwrite');
            const childrenStore = transaction.objectStore('children');
            
            const request = childrenStore.add(childData);
            
            request.onsuccess = () => {
                showToast('ÊàêÂäüÊñ∞Â¢ûÂØ∂ÂØ∂Ë≥áÊñô');
                closeModal();
                
                // È†êË®≠ÈÅ∏‰∏≠Êñ∞Â¢ûÁöÑÂ≠©Â≠ê
                currentChildId = childData.id;
                
                // Áî¢ÁîüÈ†êË®≠ÈáåÁ®ãÁ¢ëË≥áÊñô
                generateDefaultMilestones(childData.id);
                
                // Âà∑Êñ∞Â≠©Â≠êÈÅ∏ÊìáÂô®
                loadChildrenSelector();
                
                // È°ØÁ§∫ÂÑÄË°®Êùø
                updatePage('home');
            };
            
            request.onerror = () => {
                showToast('Êñ∞Â¢ûÂØ∂ÂØ∂Ë≥áÊñôÂ§±Êïó');
            };
        }

        // Áî¢ÁîüÈ†êË®≠ÈáåÁ®ãÁ¢ëË≥áÊñô (Êì¥ÂÖÖÁâà)
        function generateDefaultMilestones(childId) {
            const defaultMilestones = [
                // Âãï‰ΩúÁôºÂ±ïÈáåÁ®ãÁ¢ë (motor)
                { childId, category: 'motor', title: 'ËÉΩÊä¨È†≠', ageMonths: 1, completed: false, description: 'Ë∂¥ËëóÊôÇËÉΩÊä¨È†≠45Â∫¶Ëßí' },
                { childId, category: 'motor', title: 'ËÉΩÈ†≠ÈÉ®Âπ≥Á©©', ageMonths: 3, completed: false, description: 'Ë±éÊä±ÊôÇÈ†≠ÈÉ®ËÉΩ‰øùÊåÅÂπ≥Á©©' },
                { childId, category: 'motor', title: 'ÁøªË∫´(Ë∂¥Áøª‰ª∞)', ageMonths: 4, completed: false, description: 'ËÉΩÂæûË∂¥ÂßøÁøªËΩâÁÇ∫‰ª∞Ë∫∫' },
                { childId, category: 'motor', title: 'ÁøªË∫´(‰ª∞ÁøªË∂¥)', ageMonths: 5, completed: false, description: 'ËÉΩÂæû‰ª∞Ë∫∫ÁøªËΩâÁÇ∫Ë∂¥Âßø' },
                { childId, category: 'motor', title: 'Áç®Âùê', ageMonths: 6, completed: false, description: 'ËÉΩ‰∏çÊîØÊíêÁç®Ëá™ÂùêÁ´ãÁâáÂàª' },
                { childId, category: 'motor', title: 'Á©©Âùê', ageMonths: 7, completed: false, description: 'ËÉΩÁ©©ÂÆöÁç®ÂùêËºÉÈï∑ÊôÇÈñì' },
                { childId, category: 'motor', title: 'Áà¨Ë°å', ageMonths: 8, completed: false, description: 'ËÉΩÊúâÊïàÁà¨Ë°åÁßªÂãï' },
                { childId, category: 'motor', title: 'Êâ∂Á´ô', ageMonths: 9, completed: false, description: 'ËÉΩÊâ∂ËëóÁâ©È´îÁ´ôÁ´ã' },
                { childId, category: 'motor', title: 'Êâ∂Ëµ∞', ageMonths: 10, completed: false, description: 'ËÉΩÊâ∂ËëóÁâ©È´îËµ∞Ë∑Ø' },
                { childId, category: 'motor', title: 'Áç®Á´ô', ageMonths: 11, completed: false, description: 'ËÉΩ‰∏çÊâ∂Áâ©Áü≠Êö´Áç®Á´ãÁ´ôÁ´ã' },
                { childId, category: 'motor', title: 'Áç®Ëµ∞', ageMonths: 12, completed: false, description: 'ËÉΩÁç®Á´ãËµ∞ÂπæÊ≠•' },
                { childId, category: 'motor', title: 'Á©©ÂÆöËµ∞Ë∑Ø', ageMonths: 15, completed: false, description: 'ËÉΩÁ©©ÂÆöËµ∞Ë∑ØËºÉÈï∑Ë∑ùÈõ¢' },
                { childId, category: 'motor', title: 'Ëπ≤‰∏ãÂÜçÁ´ôËµ∑', ageMonths: 18, completed: false, description: 'ËÉΩÁç®Á´ãËπ≤‰∏ãÊãøÊù±Ë•øÂÜçÁ´ôËµ∑' },
                { childId, category: 'motor', title: '‰∏ä‰∏ãÊ®ìÊ¢Ø', ageMonths: 24, completed: false, description: 'ËÉΩÊâ∂ËëóÊâ∂Êâã‰∏ä‰∏ãÊ®ìÊ¢Ø' },
                { childId, category: 'motor', title: 'Ë∑≥Ë∫ç', ageMonths: 30, completed: false, description: 'ËÉΩÈõôËÖ≥Ë∑≥Ë∫ç' },
                
                // Ë™ûË®ÄËÉΩÂäõÈáåÁ®ãÁ¢ë (language)
                { childId, category: 'language', title: 'ÂíïÂíïËÅ≤', ageMonths: 2, completed: false, description: 'ËÉΩÁôºÂá∫ÂíïÂíïËÅ≤ÂõûÊáâ' },
                { childId, category: 'language', title: 'Á¨ëËÅ≤', ageMonths: 3, completed: false, description: 'ËÉΩÁôºÂá∫Á¨ëËÅ≤' },
                { childId, category: 'language', title: 'ÁâôÁâôÂ≠∏Ë™û', ageMonths: 6, completed: false, description: 'ËÉΩÁôºÂá∫ÈÄ£Á∫åÈü≥ÁØÄÂ¶Ç"Áà∏Áà∏Â™ΩÂ™Ω"' },
                { childId, category: 'language', title: 'Ê®°‰ªøËÅ≤Èü≥', ageMonths: 9, completed: false, description: 'ËÉΩÂòóË©¶Ê®°‰ªøÂ§ß‰∫∫Ë™™Ë©±ÁöÑËÅ≤Èü≥' },
                { childId, category: 'language', title: 'ÁêÜËß£Ë©ûÊÑè', ageMonths: 10, completed: false, description: 'ÊáÇÂæó"‰∏çË¶Å"„ÄÅ"ÂÜçË¶ã"Á≠âÂ∏∏Áî®Ë©û' },
                { childId, category: 'language', title: 'Á¨¨‰∏ÄÂÄãË©û', ageMonths: 12, completed: false, description: 'ËÉΩÊúâÊÑèÁæ©Âú∞Ë™™Âá∫Á¨¨‰∏ÄÂÄãË©û' },
                { childId, category: 'language', title: 'Ë©ûÂΩôÂ¢ûÂä†', ageMonths: 15, completed: false, description: 'ËÉΩË™™Âá∫5-10ÂÄãÊúâÊÑèÁæ©ÁöÑË©ûË™û' },
                { childId, category: 'language', title: 'ÂÖ©Â≠óÁµÑÂêà', ageMonths: 18, completed: false, description: 'ËÉΩÁî®ÂÖ©ÂÄãË©ûË™ûÁµÑÂêàË°®ÈÅîÊÑèÊÄù' },
                { childId, category: 'language', title: 'Á∞°ÂñÆÂè•Â≠ê', ageMonths: 24, completed: false, description: 'ËÉΩË™™Âá∫Á∞°ÂñÆÁöÑÂè•Â≠ê' },
                { childId, category: 'language', title: 'Ë§áÈõúÂ∞çË©±', ageMonths: 36, completed: false, description: 'ËÉΩÈÄ≤Ë°åÁ∞°ÂñÆÁöÑÂ∞çË©±‰∫§ÊµÅ' },
                
                // Á§æ‰∫§ËÉΩÂäõÈáåÁ®ãÁ¢ë (social)
                { childId, category: 'social', title: 'Á§æ‰∫§ÊÄßÂæÆÁ¨ë', ageMonths: 2, completed: false, description: 'ËÉΩÂ∞ç‰∫∫Ë°®ÁèæÂá∫Á§æ‰∫§ÊÄßÁöÑÂæÆÁ¨ë' },
                { childId, category: 'social', title: 'ÂõûÊáâÂêçÂ≠ó', ageMonths: 4, completed: false, description: 'ËÅΩÂà∞ÂêçÂ≠óÊôÇÊúÉÊúâÂèçÊáâ' },
                { childId, category: 'social', title: 'ÂÆ≥ÊÄïÈôåÁîü‰∫∫', ageMonths: 6, completed: false, description: 'Â∞çÈôåÁîü‰∫∫Ë°®ÁèæÂá∫‰∏çÂÆâÊàñÂÆ≥ÊÄï' },
                { childId, category: 'social', title: 'Áé©Ë∫≤Ë≤ìË≤ì', ageMonths: 7, completed: false, description: 'ÂñúÊ≠°ÂèÉËàáË∫≤Ë≤ìË≤ìÁ≠â‰∫íÂãïÈÅäÊà≤' },
                { childId, category: 'social', title: 'Ê®°‰ªøÂãï‰Ωú', ageMonths: 9, completed: false, description: 'ÊúÉÊ®°‰ªøÂ§ß‰∫∫ÁöÑÁ∞°ÂñÆÂãï‰Ωú' },
                { childId, category: 'social', title: 'ÊèÆÊâãÂÜçË¶ã', ageMonths: 10, completed: false, description: 'ÊúÉÊèÆÊâãË°®Á§∫ÂÜçË¶ã' },
                { childId, category: 'social', title: 'Â±ïÁ§∫Áâ©ÂìÅ', ageMonths: 12, completed: false, description: '‰∏ªÂãïÂêë‰ªñ‰∫∫Â±ïÁ§∫Ëá™Â∑±ÁöÑÁâ©ÂìÅ' },
                { childId, category: 'social', title: 'Âπ´ÂøôÊî∂Êãæ', ageMonths: 15, completed: false, description: 'È°òÊÑèÂèÉËàáÁ∞°ÂñÆÁöÑÂÆ∂ÂãôÊ¥ªÂãï' },
                { childId, category: 'social', title: 'Âπ≥Ë°åÈÅäÊà≤', ageMonths: 18, completed: false, description: 'ËÉΩÂú®ÂÖ∂‰ªñÂ≠©Â≠êÊóÅÈÇäÁé©ËÄç(‰ΩÜ‰∏ç‰∏ÄÂÆö‰∫íÂãï)' },
                { childId, category: 'social', title: 'Ëº™ÊµÅÁé©', ageMonths: 24, completed: false, description: 'ËÉΩÁêÜËß£Ëº™ÊµÅÁöÑÊ¶ÇÂøµ' },
                { childId, category: 'social', title: 'Âêà‰ΩúÈÅäÊà≤', ageMonths: 36, completed: false, description: 'ËÉΩËàáÂÖ∂‰ªñÂ≠©Â≠êÂêà‰ΩúÁé©ËÄç' },
                
                // Ë™çÁü•ÁôºÂ±ïÈáåÁ®ãÁ¢ë (cognitive)
                { childId, category: 'cognitive', title: 'ÁõÆÂÖâËøΩËπ§', ageMonths: 1, completed: false, description: 'ËÉΩÁî®ÁõÆÂÖâËøΩËπ§ÁßªÂãï‰∏≠ÁöÑÁâ©È´î' },
                { childId, category: 'cognitive', title: 'Ë™çË≠òÁÜü‰∫∫', ageMonths: 3, completed: false, description: 'ËÉΩË™çÂá∫ÁÜüÊÇâÁöÑ‰∫∫' },
                { childId, category: 'cognitive', title: 'Â∞ãÊâæÁâ©È´î', ageMonths: 5, completed: false, description: 'ÊúÉÂ∞ãÊâæÈÉ®ÂàÜÈö±ËóèÁöÑÁâ©È´î' },
                { childId, category: 'cognitive', title: 'Âõ†ÊûúÈóú‰øÇ', ageMonths: 7, completed: false, description: 'ÁêÜËß£Á∞°ÂñÆÁöÑÂõ†ÊûúÈóú‰øÇÔºåÂ¶ÇÊåâÈàïÁôºËÅ≤' },
                { childId, category: 'cognitive', title: 'Áâ©È´îÊÅÜÂ≠ò', ageMonths: 8, completed: false, description: 'ÁêÜËß£Áúã‰∏çË¶ãÁöÑÁâ©È´î‰ªçÁÑ∂Â≠òÂú®' },
                { childId, category: 'cognitive', title: 'ÊåáÁâ©', ageMonths: 11, completed: false, description: 'Áî®ÊâãÊåáÂêëÊÉ≥Ë¶ÅÁöÑÁâ©È´î' },
                { childId, category: 'cognitive', title: 'ÂäüËÉΩÁêÜËß£', ageMonths: 14, completed: false, description: 'ÁêÜËß£Áâ©ÂìÅÁöÑÂü∫Êú¨ÂäüËÉΩÔºåÂ¶ÇÊùØÂ≠êÁî®‰æÜÂñùÊ∞¥' },
                { childId, category: 'cognitive', title: 'Á¨¶Ëôü‰ΩøÁî®', ageMonths: 18, completed: false, description: '‰ΩøÁî®Áâ©È´î‰ª£Ë°®ÂÖ∂‰ªñ‰∫ãÁâ©ÈÄ≤Ë°åË±°ÂæµÊÄßÈÅäÊà≤' },
                { childId, category: 'cognitive', title: 'ÈÖçÂ∞çÂàÜÈ°û', ageMonths: 24, completed: false, description: 'ËÉΩÊåâÂΩ¢ÁãÄÊàñÈ°èËâ≤ÈÄ≤Ë°åÁ∞°ÂñÆÂàÜÈ°û' },
                { childId, category: 'cognitive', title: 'Êï∏ÈáèÊ¶ÇÂøµ', ageMonths: 30, completed: false, description: 'ÁêÜËß£"Â§ö"Âíå"Â∞ë"ÁöÑÂçÄÂà•' },
                { childId, category: 'cognitive', title: 'È°èËâ≤Ëæ®Ë≠ò', ageMonths: 36, completed: false, description: 'ËÉΩÊ≠£Á¢∫Ëæ®Ë™ç‰∏¶ÂëΩÂêç‰∏ªË¶ÅÈ°èËâ≤' },
                
                // ÊÉÖÁ∑íÁôºÂ±ïÈáåÁ®ãÁ¢ë (emotional)
                { childId, category: 'emotional', title: 'Ë°®ÈÅî‰∏çÈÅ©', ageMonths: 0, completed: false, description: 'ËÉΩÁî®Âì≠ËÅ≤Ë°®ÈÅî‰∏çÈÅ©ÊàñÈúÄÊ±Ç' },
                { childId, category: 'emotional', title: 'ÊÉÖÁ∑íÂàÜÂåñ', ageMonths: 3, completed: false, description: 'Ë°®ÁèæÂá∫‰∏çÂêåÊÉÖÁ∑íÂ¶ÇÈ´òËàà„ÄÅÁîüÊ∞£' },
                { childId, category: 'emotional', title: 'Ëá™ÊàëÂÆâÊí´', ageMonths: 6, completed: false, description: 'ËÉΩÁî®Âê∏ÊâãÊåáÁ≠âÊñπÂºèËá™ÊàëÂÆâÊí´' },
                { childId, category: 'emotional', title: 'ÂàÜÈõ¢ÁÑ¶ÊÖÆ', ageMonths: 8, completed: false, description: 'Áà∂ÊØçÈõ¢ÈñãÊôÇË°®ÁèæÂá∫‰∏çÂÆâ' },
                { childId, category: 'emotional', title: 'ÊÉÖÁ∑íÂèÉÁÖß', ageMonths: 10, completed: false, description: 'ÈÄöÈÅéËßÄÂØüÊàê‰∫∫ÂèçÊáâË™øÊï¥Ëá™Â∑±Ë°åÁÇ∫' },
                { childId, category: 'emotional', title: 'ÊÉÖÁ∑íË°®ÈÅî', ageMonths: 15, completed: false, description: 'ËÉΩÊòéÁ¢∫Ë°®ÈÅîËá™Â∑±ÁöÑÊÉÖÁ∑íÈúÄÊ±Ç' },
                { childId, category: 'emotional', title: 'ÊÉÖÁ∑íËæ®Ë≠ò', ageMonths: 24, completed: false, description: 'ËÉΩËæ®Ë™ç‰ªñ‰∫∫ÁöÑÂü∫Êú¨ÊÉÖÁ∑í' },
                { childId, category: 'emotional', title: 'ÊÉÖÁ∑íÊéßÂà∂', ageMonths: 36, completed: false, description: 'ÈñãÂßãÂ≠∏ÁøíÊéßÂà∂ÊÉÖÁ∑íË°®ÈÅî' },
                
                // Ëá™ÁêÜËÉΩÂäõÈáåÁ®ãÁ¢ë (self-help)
                { childId, category: 'self-help', title: 'Âê∏ÂÖÅ', ageMonths: 0, completed: false, description: 'ËÉΩÊúâÊïàÂê∏ÂÖÅ' },
                { childId, category: 'self-help', title: 'Ëá™Â∑±ÊãøÁâ©', ageMonths: 5, completed: false, description: 'ËÉΩËá™Â∑±ÊäìÂèñÂ∞èÁâ©ÂìÅ' },
                { childId, category: 'self-help', title: 'Áî®ÊùØÂñùÊ∞¥', ageMonths: 9, completed: false, description: 'ËÉΩÊâ∂ËëóÊùØÂ≠êÂñùÊ∞¥' },
                { childId, category: 'self-help', title: 'Áî®ÊπØÂåô', ageMonths: 12, completed: false, description: 'ËÉΩÂòóË©¶Áî®ÊπØÂåôÈÄ≤È£ü' },
                { childId, category: 'self-help', title: 'ËÑ´Á∞°ÂñÆË°£Áâ©', ageMonths: 18, completed: false, description: 'ËÉΩËÑ´ÊéâÁ∞°ÂñÆÁöÑË°£Áâ©Â¶ÇË•™Â≠ê' },
                { childId, category: 'self-help', title: '‰æøÁõÜË®ìÁ∑¥', ageMonths: 24, completed: false, description: 'ÈñãÂßãÈÄ≤Ë°å‰æøÁõÜË®ìÁ∑¥ÔºåË°®ÁèæÂá∫‰∏äÂªÅÊâÄÊÑèË≠ò' },
                { childId, category: 'self-help', title: 'Ëá™Â∑±Á©øË°£', ageMonths: 30, completed: false, description: 'ËÉΩÁ©ø‰∏äÁ∞°ÂñÆÁöÑË°£Áâ©' },
                { childId, category: 'self-help', title: 'Â¶ÇÂªÅËá™ÁêÜ', ageMonths: 36, completed: false, description: 'Â§ßÈÉ®ÂàÜÊôÇÈñìËÉΩËá™Â∑±Â¶ÇÂªÅ' }
            ];
            
            const transaction = db.transaction(['milestones'], 'readwrite');
            const milestonesStore = transaction.objectStore('milestones');
            
            defaultMilestones.forEach(milestone => {
                milestonesStore.add(milestone);
            });
        }

        // ËºâÂÖ•Â≠©Â≠êÈÅ∏ÊìáÂô®
        function loadChildrenSelector() {
            const transaction = db.transaction(['children'], 'readonly');
            const childrenStore = transaction.objectStore('children');
            const request = childrenStore.getAll();
            
            request.onsuccess = () => {
                const children = request.result;
                
                if (children.length > 0) {
                    document.getElementById('child-selector-container').style.display = 'block';
                    
                    const childSelector = document.getElementById('child-selector');
                    childSelector.innerHTML = '';
                    
                    children.forEach(child => {
                        const childAvatar = document.createElement('div');
                        childAvatar.className = 'child-avatar';
                        childAvatar.dataset.childId = child.id;
                        
                        if (child.avatar) {
                            childAvatar.innerHTML = `<img src="${child.avatar}" alt="${child.name}">`;
                        } else {
                            // Â¶ÇÊûúÊ≤íÊúâÈ†≠ÂÉèÔºåÈ°ØÁ§∫È¶ñÂ≠óÊØç
                            const initial = child.name.charAt(0);
                            const backgroundColor = child.gender === 'Áî∑' ? 'var(--primary-light)' : 
                                                  child.gender === 'Â•≥' ? 'var(--secondary-light)' : 'var(--tertiary-light)';
                            const textColor = child.gender === 'Áî∑' ? 'var(--primary)' : 
                                            child.gender === 'Â•≥' ? 'var(--secondary)' : 'var(--tertiary)';
                            
                            childAvatar.style.backgroundColor = backgroundColor;
                            childAvatar.style.color = textColor;
                            childAvatar.textContent = initial;
                        }
                        
                        if (!currentChildId) {
                            currentChildId = child.id;
                            childAvatar.classList.add('active');
                        } else if (child.id === currentChildId) {
                            childAvatar.classList.add('active');
                        }
                        
                        childAvatar.addEventListener('click', () => {
                            document.querySelectorAll('.child-avatar').forEach(avatar => {
                                avatar.classList.remove('active');
                            });
                            childAvatar.classList.add('active');
                            currentChildId = child.id;
                            
                            // ÈáçÊñ∞ËºâÂÖ•Áï∂ÂâçÈ†ÅÈù¢
                            updatePage(currentPage);
                        });
                        
                        childSelector.appendChild(childAvatar);
                    });
                    
                    // Â¶ÇÊûúÂ≠©Â≠êÊï∏ÈáèÂ∞ëÊñº 4 ÂÄãÔºåÈ°ØÁ§∫Êñ∞Â¢ûÊåâÈàï
                    if (children.length < 4) {
                        const addButton = document.createElement('div');
                        addButton.className = 'child-avatar add-child';
                        addButton.textContent = '+';
                        addButton.addEventListener('click', () => {
                            showAddChildModal();
                        });
                        
                        childSelector.appendChild(addButton);
                    }
                    
                    // Á¢∫‰øùÊúâÈÅ∏‰∏≠ÁöÑÂ≠©Â≠ê
                    if (!currentChildId && children.length > 0) {
                        currentChildId = children[0].id;
                    }
                    
                    // ËºâÂÖ•È¶ñÈ†ÅÂÖßÂÆπ
                    updatePage('home');
                } else {
                    // Â¶ÇÊûúÊ≤íÊúâÂ≠©Â≠êË≥áÊñôÔºåÈ°ØÁ§∫Ê≠°ËøéÁï´Èù¢
                    showWelcomeScreen();
                }
            };
        }

        // Áî¢ÁîüÂîØ‰∏Ä ID
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        }

        // È°ØÁ§∫ÂêêÂè∏ÊèêÁ§∫
        function showToast(message, duration = 2000) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('active');
            
            setTimeout(() => {
                toast.classList.remove('active');
            }, duration);
        }

        // ÈñãÂïüÊ®°ÊÖãÊ°Ü
        function openModal() {
            document.getElementById('modal').classList.add('active');
        }

        // ÈóúÈñâÊ®°ÊÖãÊ°Ü
        function closeModal() {
            document.getElementById('modal').classList.remove('active');
        }

        // ÊÉÖÁ∑íÁõ∏ÈóúÂ∑•ÂÖ∑ÂáΩÊï∏
        function getMoodEmoji(mood) {
            const moodMap = {
                'happy': 'üòÑ',
                'excited': 'ü§©',
                'calm': 'üòä',
                'sleepy': 'üò¥',
                'curious': 'ü§î',
                'playful': 'üòÜ',
                'sad': 'üò¢',
                'angry': 'üò†'
            };
            return moodMap[mood] || 'üòä';
        }

        function getMoodText(mood) {
            const moodMap = {
                'happy': 'ÈñãÂøÉ',
                'excited': 'ËààÂ•Æ',
                'calm': 'Âπ≥Èùú',
                'sleepy': 'ÊÉ≥Áù°',
                'curious': 'Â•ΩÂ•á',
                'playful': 'ÊÑõÁé©',
                'sad': 'Èõ£ÈÅé',
                'angry': 'ÁîüÊ∞£'
            };
            return moodMap[mood] || 'Âπ≥Èùú';
        }

        // Êõ¥Êñ∞È†ÅÈù¢ÂÖßÂÆπ
        function updatePage(page) {
            currentPage = page;
            
            // Êõ¥Êñ∞Â∞éË¶ΩÂàóÈÅ∏‰∏≠ÁãÄÊÖã
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`.nav-item[data-page="${page}"]`).classList.add('active');
            
            // Êõ¥Êñ∞È†ÅÈù¢Ê®ôÈ°å
            const pageTitles = {
                'home': 'È¶ñÈ†Å',
                'care': 'ÁÖßË≠∑',
                'development': 'ÁôºÂ±ï',
                'health': 'ÂÅ•Â∫∑',
                'settings': 'Ë®≠ÂÆö'
            };
            document.getElementById('page-title').textContent = pageTitles[page];
            
            // Êõ¥Êñ∞È†ÅÈù¢Êìç‰ΩúÊåâÈàï
            const headerAction = document.getElementById('header-action');
            headerAction.innerHTML = '';
            
            // ËºâÂÖ•Â∞çÊáâÈ†ÅÈù¢ÂÖßÂÆπ
            if (currentChildId) {
                switch (page) {
                    case 'home':
                        loadHomePage();
                        break;
                    case 'care':
                        loadCarePage();
                        break;
                    case 'development':
                        loadDevelopmentPage();
                        break;
                    case 'health':
                        loadHealthPage();
                        break;
                    case 'settings':
                        loadSettingsPage();
                        break;
                }
            }
        }

        // ËºâÂÖ•È¶ñÈ†Å
        function loadHomePage() {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = '<div class="loader"></div>';
            
            // Áç≤Âèñ‰ªäÊó•ÁöÑÈñãÂßãÂíåÁµêÊùüÊôÇÈñì
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            // Áç≤ÂèñÁõÆÂâçÈÅ∏ÂèñÁöÑÂØ∂ÂØ∂Ë≥áÊñô
            getChildById(currentChildId, (child) => {
                // Ë®àÁÆóÂπ¥ÈΩ°
                const birthDate = new Date(child.birthdate);
                const ageInMonths = Math.floor((today - birthDate) / (1000 * 60 * 60 * 24 * 30.44));
                const ageYears = Math.floor(ageInMonths / 12);
                const ageMonths = ageInMonths % 12;
                const ageString = ageYears > 0 
                    ? `${ageYears}Ê≠≤${ageMonths}ÂÄãÊúà` 
                    : `${ageMonths}ÂÄãÊúà`;
                
                // Áç≤Âèñ‰ªäÊó•È§µÈ£üÊ¨°Êï∏
                getTodayRecordsCount('feeding', (feedingCount) => {
                    // Áç≤Âèñ‰ªäÊó•Áù°Áú†ÊôÇÊï∏
                    getTodaySleepHours((sleepHours) => {
                        // Áç≤Âèñ‰ªäÊó•Â∞øÂ∏ÉÊ¨°Êï∏
                        getTodayRecordsCount('diaper', (diaperCount) => {
                            // Ë®≠ÂÆöÈ†ÅÈù¢ÂÖßÂÆπ
                            mainContent.innerHTML = `
                                <div class="card">
                                    <div class="card-header">
                                        <div class="card-title">
                                            <span>${child.name}</span>
                                            <span style="font-size: 0.8rem; color: var(--text-light); font-weight: normal; margin-left: 8px;">${ageString}</span>
                                        </div>
                                        <div>
                                            <span style="font-size: 0.8rem;">${formatDate(today, true)}</span>
                                        </div>
                                    </div>
                                    <div class="card-content">
                                        <div class="overview-grid">
                                            <div class="overview-item feeding">
                                                <div class="overview-number">${feedingCount}</div>
                                                <div class="overview-label">È§µÈ£üÊ¨°Êï∏</div>
                                            </div>
                                            <div class="overview-item sleep">
                                                <div class="overview-number">${sleepHours.toFixed(1)}</div>
                                                <div class="overview-label">Áù°Áú†Â∞èÊôÇ</div>
                                            </div>
                                            <div class="overview-item diaper">
                                                <div class="overview-number">${diaperCount}</div>
                                                <div class="overview-label">Â∞øÂ∏ÉÊõ¥Êèõ</div>
                                            </div>
                                        </div>
                                        
                                        <div class="quick-actions">
                                            <button class="action-btn" id="quick-feeding">
                                                <span>üçº</span>
                                                <span>Ë®òÈåÑÈ§µÈ£ü</span>
                                            </button>
                                            <button class="action-btn" id="quick-sleep">
                                                <span>üò¥</span>
                                                <span>Ë®òÈåÑÁù°Áú†</span>
                                            </button>
                                            <button class="action-btn" id="quick-diaper">
                                                <span>üß∑</span>
                                                <span>Ë®òÈåÑÂ∞øÂ∏É</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="card">
                                    <div class="card-header">
                                        <div class="card-title">‰ªäÊó•Á¥ÄÈåÑ</div>
                                    </div>
                                    <div class="records-list" id="today-records">
                                        <div class="loader"></div>
                                    </div>
                                </div>
                                
                                <div class="card">
                                    <div class="card-header">
                                        <div class="card-title">ËøëÊúüÁôºÂ±ïÈáåÁ®ãÁ¢ë</div>
                                    </div>
                                    <div id="upcoming-milestones">
                                        <div class="loader"></div>
                                    </div>
                                </div>
                            `;
                            
                            // Á∂ÅÂÆöÂø´ÈÄüÊìç‰ΩúÊåâÈàï
                            document.getElementById('quick-feeding').addEventListener('click', () => {
                                showAddFeedingModal();
                            });
                            
                            document.getElementById('quick-sleep').addEventListener('click', () => {
                                showAddSleepModal();
                            });
                            
                            document.getElementById('quick-diaper').addEventListener('click', () => {
                                showAddDiaperModal();
                            });
                            
                            // ËºâÂÖ•‰ªäÊó•Á¥ÄÈåÑ
                            loadTodayRecords();
                            
                            // ËºâÂÖ•Âç≥Â∞áÂà∞‰æÜÁöÑÈáåÁ®ãÁ¢ë
                            loadUpcomingMilestones(ageInMonths);
                        });
                    });
                });
            });
        }

        // ËºâÂÖ•‰ªäÊó•Á¥ÄÈåÑ
        function loadTodayRecords() {
            const todayRecordsElement = document.getElementById('today-records');
            
            // Áç≤Âèñ‰ªäÊó•ÁöÑÈñãÂßãÂíåÁµêÊùüÊôÇÈñì
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            // Áç≤ÂèñÊâÄÊúâÈ°ûÂûãÁöÑÁ¥ÄÈåÑ
            const recordTypes = ['feeding', 'sleep', 'diaper', 'activities', 'health', 'interactions'];
            let allRecords = [];
            let loadedTypesCount = 0;
            
            recordTypes.forEach(type => {
                getRecordsBetweenDates(type, today, tomorrow, (records) => {
                    allRecords = allRecords.concat(records.map(record => ({...record, type})));
                    loadedTypesCount++;
                    
                    if (loadedTypesCount === recordTypes.length) {
                        // ÊéíÂ∫èÊâÄÊúâÁ¥ÄÈåÑÔºàÂæûÊñ∞Âà∞ËàäÔºâ
                        allRecords.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                        
                        if (allRecords.length === 0) {
                            todayRecordsElement.innerHTML = `
                                <div class="empty-state">
                                    <div class="empty-text">‰ªäÂ§©ÈÇÑÊ≤íÊúâÁ¥ÄÈåÑ</div>
                                </div>
                            `;
                        } else {
                            // È°ØÁ§∫Á¥ÄÈåÑ
                            todayRecordsElement.innerHTML = '';
                            
                            allRecords.forEach(record => {
                                const recordItem = document.createElement('div');
                                recordItem.className = 'record-item';
                                
                                let recordContent = '';
                                let recordIcon = '';
                                
                                switch (record.type) {
                                    case 'feeding':
                                        recordIcon = 'üçº';
                                        recordContent = `
                                            <div class="record-details">
                                                <span class="record-tag">${record.method === 'breastfeeding' ? 'ÊØç‰π≥' : 
                                                                           record.method === 'formula' ? 'ÈÖçÊñπÂ•∂' : 'ÂâØÈ£üÂìÅ'}</span>
                                                ${record.method === 'breastfeeding' ? 
                                                  `<span class="record-tag">${record.side === 'left' ? 'Â∑¶ÂÅ¥' : 'Âè≥ÂÅ¥'}</span>` : ''}
                                                ${record.amount ? `<span class="record-tag">${record.amount} ml</span>` : ''}
                                            </div>
                                        `;
                                        break;
                                    case 'sleep':
                                        recordIcon = 'üò¥';
                                        recordContent = `
                                            <div class="record-details">
                                                <span class="record-tag">${record.duration} ÂàÜÈêò</span>
                                                <span class="record-tag">${record.quality === 'good' ? 'ÂÆâÁ©©' : 
                                                                           record.quality === 'normal' ? 'ÊôÆÈÄö' : '‰∏ç‰Ω≥'}</span>
                                            </div>
                                        `;
                                        break;
                                    case 'diaper':
                                        recordIcon = 'üß∑';
                                        recordContent = `
                                            <div class="record-details">
                                                <span class="record-tag">${record.type === 'wet' ? 'Â∞øÂ∏É' : 
                                                                           record.type === 'dirty' ? '‰æø‰æø' : 'Ê∑∑Âêà'}</span>
                                                ${record.note ? `<span class="record-tag">${record.note}</span>` : ''}
                                            </div>
                                        `;
                                        break;
                                    case 'activities':
                                        recordIcon = 'üéØ';
                                        recordContent = `
                                            <div class="record-details">
                                                <span class="record-tag">${record.type}</span>
                                                ${record.duration ? `<span class="record-tag">${record.duration} ÂàÜÈêò</span>` : ''}
                                            </div>
                                        `;
                                        break;
                                    case 'health':
                                        recordIcon = 'üíä';
                                        
                                        if (record.type === 'temperature') {
                                            let tempStatus = '';
                                            let tempColor = '';
                                            if (record.value >= 38) {
                                                tempStatus = 'ÁôºÁáí';
                                                tempColor = '#ff6b6b';
                                            } else if (record.value >= 37.5) {
                                                tempStatus = 'ÂæÆÁáí';
                                                tempColor = '#ffa500';
                                            } else if (record.value < 36) {
                                                tempStatus = 'ÂÅè‰Ωé';
                                                tempColor = '#6bb6ff';
                                            } else {
                                                tempStatus = 'Ê≠£Â∏∏';
                                                tempColor = '#51cf66';
                                            }
                                            
                                            recordContent = `
                                                <div class="record-details">
                                                    <span class="record-tag">È´îÊ∫´</span>
                                                    <span class="record-tag" style="background-color: ${tempColor}; color: white;">
                                                        ${record.value}¬∞C ${tempStatus}
                                                    </span>
                                                </div>
                                            `;
                                        } else if (record.type === 'weight') {
                                            recordContent = `
                                                <div class="record-details">
                                                    <span class="record-tag">È´îÈáç</span>
                                                    <span class="record-tag">${record.value} kg</span>
                                                </div>
                                            `;
                                        } else if (record.type === 'height') {
                                            recordContent = `
                                                <div class="record-details">
                                                    <span class="record-tag">Ë∫´È´ò</span>
                                                    <span class="record-tag">${record.value} cm</span>
                                                </div>
                                            `;
                                        } else if (record.type === 'vaccine') {
                                            recordContent = `
                                                <div class="record-details">
                                                    <span class="record-tag">Áñ´Ëãó</span>
                                                    <span class="record-tag">${record.name}</span>
                                                </div>
                                            `;
                                        } else if (record.type === 'medication') {
                                            recordContent = `
                                                <div class="record-details">
                                                    <span class="record-tag">Áî®Ëó•</span>
                                                    <span class="record-tag">${record.name}</span>
                                                </div>
                                            `;
                                        }
                                        break;
                                    case 'interactions':
                                        recordIcon = 'üë®‚Äçüë©‚Äçüëß';
                                        
                                        const moodEmoji = getMoodEmoji(record.mood);
                                        const moodText = getMoodText(record.mood);
                                        
                                        recordContent = `
                                            <div class="record-details">
                                                <span class="record-tag">${moodEmoji} ${moodText}</span>
                                            </div>
                                            ${record.note ? `<div style="font-size: 0.9rem; margin-top: 4px;">${record.note}</div>` : ''}
                                            ${record.photoData ? `
                                                <div class="interaction-photo">
                                                    <img src="${record.photoData}" alt="‰∫íÂãïÁÖßÁâá">
                                                </div>` : ''}
                                        `;
                                        break;
                                }
                                
                                recordItem.innerHTML = `
                                    <div style="display: flex; align-items: flex-start; gap: 10px; width: 100%;">
                                        <div style="font-size: 1.2rem;">${recordIcon}</div>
                                        <div class="record-main" style="flex-grow: 1;">
                                            <div class="record-time">${formatTime(new Date(record.timestamp))}</div>
                                            ${recordContent}
                                        </div>
                                    </div>
                                `;
                                
                                todayRecordsElement.appendChild(recordItem);
                            });
                        }
                    }
                });
            });
        }

        // ËºâÂÖ•Âç≥Â∞áÂà∞‰æÜÁöÑÈáåÁ®ãÁ¢ë
        function loadUpcomingMilestones(currentAgeMonths) {
            const upcomingMilestonesElement = document.getElementById('upcoming-milestones');
            
            const transaction = db.transaction(['milestones'], 'readonly');
            const milestonesStore = transaction.objectStore('milestones');
            const index = milestonesStore.index('childId');
            const range = IDBKeyRange.only(currentChildId);
            const request = index.openCursor(range);
            
            let milestones = [];
            
            request.onsuccess = (event) => {
                const cursor = event.target.result;
                
                if (cursor) {
                    milestones.push(cursor.value);
                    cursor.continue();
                } else {
                    // ÈÅéÊøæÊú™ÂÆåÊàê‰∏îÂπ¥ÈΩ°Êé•ËøëÁöÑÈáåÁ®ãÁ¢ëÔºà¬±3ÂÄãÊúàÔºâ
                    const relevantMilestones = milestones.filter(m => 
                        !m.completed && 
                        Math.abs(m.ageMonths - currentAgeMonths) <= 3
                    );
                    
                    // ÊéíÂ∫èÔºàÂÖàÈ°ØÁ§∫ËºÉÂç≥Â∞áÂà∞‰æÜÁöÑÔºâ
                    relevantMilestones.sort((a, b) => Math.abs(a.ageMonths - currentAgeMonths) - Math.abs(b.ageMonths - currentAgeMonths));
                    
                    if (relevantMilestones.length === 0) {
                        upcomingMilestonesElement.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-text">ÁõÆÂâçÊ≤íÊúâËøëÊúüÈáåÁ®ãÁ¢ë</div>
                            </div>
                        `;
                    } else {
                        upcomingMilestonesElement.innerHTML = '';
                        
                        // Âè™È°ØÁ§∫ÊúÄÂ§ö 3 ÂÄã
                        relevantMilestones.slice(0, 3).forEach(milestone => {
                            const monthDiff = milestone.ageMonths - currentAgeMonths;
                            let timeDescription = '';
                            
                            if (monthDiff > 0) {
                                timeDescription = `Á¥Ñ ${monthDiff} ÂÄãÊúàÂæå`;
                            } else if (monthDiff < 0) {
                                timeDescription = `Â∑≤Âª∂ÈÅ≤ ${Math.abs(monthDiff)} ÂÄãÊúà`;
                            } else {
                                timeDescription = 'ÁèæÂú®ÈÅ©ÂêàÁöÑÊôÇÈñì';
                            }
                            
                            const milestoneItem = document.createElement('div');
                            milestoneItem.className = 'milestone-item';
                            milestoneItem.dataset.id = milestone.id;
                            
                            milestoneItem.innerHTML = `
                                <div class="milestone-header">
                                    <div>${milestone.title}</div>
                                    <div class="milestone-age">${milestone.ageMonths} ÂÄãÊúà</div>
                                </div>
                                <div style="font-size: 0.8rem; color: var(--text-light);">${timeDescription}</div>
                                ${milestone.description ? `<div style="font-size: 0.85rem; margin-top: 6px;">${milestone.description}</div>` : ''}
                            `;
                            
                            // ÈªûÊìäÈáåÁ®ãÁ¢ëÂàáÊèõÂÆåÊàêÁãÄÊÖã
                            milestoneItem.addEventListener('click', () => {
                                toggleMilestoneStatus(milestone.id);
                            });
                            
                            upcomingMilestonesElement.appendChild(milestoneItem);
                        });
                    }
                }
            };
        }

        // ÂàáÊèõÈáåÁ®ãÁ¢ëÂÆåÊàêÁãÄÊÖã
        function toggleMilestoneStatus(milestoneId) {
            const transaction = db.transaction(['milestones'], 'readwrite');
            const milestonesStore = transaction.objectStore('milestones');
            const request = milestonesStore.get(milestoneId);
            
            request.onsuccess = () => {
                const milestone = request.result;
                milestone.completed = !milestone.completed;
                
                milestonesStore.put(milestone);
                
                // Êõ¥Êñ∞ UI
                const milestoneItem = document.querySelector(`.milestone-item[data-id="${milestoneId}"]`);
                
                if (milestoneItem) {
                    if (milestone.completed) {
                        milestoneItem.classList.add('completed');
                        milestoneItem.innerHTML += `<div class="checkmark">‚úì Â∑≤ÂÆåÊàê</div>`;
                        
                        // È°ØÁ§∫Á•ùË≥ÄÊèêÁ§∫
                        showToast('Â§™Ê£í‰∫ÜÔºÅÈáåÁ®ãÁ¢ëÂ∑≤ÂÆåÊàê');
                    } else {
                        milestoneItem.classList.remove('completed');
                        const checkmark = milestoneItem.querySelector('.checkmark');
                        if (checkmark) {
                            checkmark.remove();
                        }
                    }
                }
            };
        }

        // ËºâÂÖ•ÁÖßË≠∑È†ÅÈù¢
        function loadCarePage() {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <div class="tabs">
                    <div class="tab active" data-tab="feeding">È§µÈ£ü</div>
                    <div class="tab" data-tab="sleep">Áù°Áú†</div>
                    <div class="tab" data-tab="diaper">Â∞øÂ∏É</div>
                </div>
                
                <div class="tab-content active" id="feeding-content">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">È§µÈ£üË®òÈåÑ</div>
                            <button class="btn-icon" id="add-feeding-btn">+</button>
                        </div>
                        <div class="card-content">
                            <div class="stat-chart" id="feeding-chart">
                                <!-- È§µÈ£üÁµ±Ë®àÂúñË°® -->
                            </div>
                            
                            <div class="mini-stat">
                                <div>‰ªäÊó•Ê¨°Êï∏</div>
                                <div class="mini-stat-value" id="feeding-count">-</div>
                            </div>
                            
                            <div class="mini-stat">
                                <div>Âπ≥ÂùáÈñìÈöî</div>
                                <div class="mini-stat-value" id="feeding-interval">-</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">ÊúÄËøëÁ¥ÄÈåÑ</div>
                        </div>
                        <div class="records-list" id="feeding-records">
                            <div class="loader"></div>
                        </div>
                    </div>
                </div>
                
                <div class="tab-content" id="sleep-content">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Áù°Áú†Ë®àÊôÇ</div>
                        </div>
                        <div class="card-content">
                            <div class="timer-display" id="sleep-timer">00:00:00</div>
                            <div class="timer-controls">
                                <button class="timer-btn timer-start" id="sleep-timer-start">‚ñ∂</button>
                                <button class="timer-btn timer-stop" id="sleep-timer-stop" style="display: none;">‚ñ†</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Áù°Áú†Ë®òÈåÑ</div>
                            <button class="btn-icon" id="add-sleep-btn">+</button>
                        </div>
                        <div class="card-content">
                            <div class="mini-stat">
                                <div>‰ªäÊó•Áù°Áú†</div>
                                <div class="mini-stat-value" id="sleep-hours">-</div>
                            </div>
                            
                            <div class="mini-stat">
                                <div>Âπ≥ÂùáÂìÅË≥™</div>
                                <div class="mini-stat-value" id="sleep-quality">-</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">ÊúÄËøëÁ¥ÄÈåÑ</div>
                        </div>
                        <div class="records-list" id="sleep-records">
                            <div class="loader"></div>
                        </div>
                    </div>
                </div>
                
                <div class="tab-content" id="diaper-content">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Â∞øÂ∏ÉË®òÈåÑ</div>
                            <button class="btn-icon" id="add-diaper-btn">+</button>
                        </div>
                        <div class="card-content">
                            <div class="stat-chart" id="diaper-chart">
                                <!-- Â∞øÂ∏ÉÁµ±Ë®àÂúñË°® -->
                            </div>
                            
                            <div class="mini-stat">
                                <div>‰ªäÊó•Ê¨°Êï∏</div>
                                <div class="mini-stat-value" id="diaper-count">-</div>
                            </div>
                            
                            <div class="mini-stat">
                                <div>È°ûÂûãÂàÜÂ∏É</div>
                                <div class="mini-stat-value" id="diaper-types">-</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">ÊúÄËøëÁ¥ÄÈåÑ</div>
                        </div>
                        <div class="records-list" id="diaper-records">
                            <div class="loader"></div>
                        </div>
                    </div>
                </div>
            `;
            
            // Ë®≠ÂÆöÈ†ÅÁ±§ÂàáÊèõ
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    tab.classList.add('active');
                    document.getElementById(`${tab.dataset.tab}-content`).classList.add('active');
                });
            });
            
            // Á∂ÅÂÆöÊñ∞Â¢ûÊåâÈàï
            document.getElementById('add-feeding-btn').addEventListener('click', () => {
                showAddFeedingModal();
            });
            
            document.getElementById('add-sleep-btn').addEventListener('click', () => {
                showAddSleepModal();
            });
            
            document.getElementById('add-diaper-btn').addEventListener('click', () => {
                showAddDiaperModal();
            });
            
            // ËºâÂÖ•È§µÈ£üË®òÈåÑ
            loadFeedingRecords();
            
            // ËºâÂÖ•Áù°Áú†Ë®òÈåÑ
            loadSleepRecords();
            
            // ËºâÂÖ•Â∞øÂ∏ÉË®òÈåÑ
            loadDiaperRecords();
            
            // Ë®≠ÂÆöÁù°Áú†Ë®àÊôÇÂô®
            initSleepTimer();
        }

        // ÂàùÂßãÂåñÁù°Áú†Ë®àÊôÇÂô®
        let sleepTimerInterval;
        let sleepTimerStartTime;
        let sleepTimerRunning = false;
        
        function initSleepTimer() {
            const timerDisplay = document.getElementById('sleep-timer');
            const startButton = document.getElementById('sleep-timer-start');
            const stopButton = document.getElementById('sleep-timer-stop');
            
            startButton.addEventListener('click', () => {
                if (!sleepTimerRunning) {
                    sleepTimerStartTime = new Date();
                    sleepTimerRunning = true;
                    
                    sleepTimerInterval = setInterval(() => {
                        const elapsed = new Date() - sleepTimerStartTime;
                        const hours = Math.floor(elapsed / (1000 * 60 * 60));
                        const minutes = Math.floor((elapsed % (1000 * 60 * 60)) / (1000 * 60));
                        const seconds = Math.floor((elapsed % (1000 * 60)) / 1000);
                        
                        timerDisplay.textContent = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                    }, 1000);
                    
                    startButton.style.display = 'none';
                    stopButton.style.display = 'flex';
                }
            });
            
            stopButton.addEventListener('click', () => {
                if (sleepTimerRunning) {
                    clearInterval(sleepTimerInterval);
                    sleepTimerRunning = false;
                    
                    const elapsed = new Date() - sleepTimerStartTime;
                    const minutes = Math.floor(elapsed / (1000 * 60));
                    
                    // Ë©¢ÂïèÊòØÂê¶ÂÑ≤Â≠òÁù°Áú†Á¥ÄÈåÑ
                    if (minutes > 0) {
                        const sleepData = {
                            childId: currentChildId,
                            timestamp: sleepTimerStartTime.toISOString(),
                            duration: minutes,
                            quality: 'normal',
                            note: ''
                        };
                        
                        // ÂÑ≤Â≠òÁù°Áú†Á¥ÄÈåÑ
                        addRecord('sleep', sleepData, () => {
                            showToast(`Â∑≤Ë®òÈåÑ ${minutes} ÂàÜÈêòÁöÑÁù°Áú†`);
                            timerDisplay.textContent = '00:00:00';
                            loadSleepRecords();
                        });
                    }
                    
                    startButton.style.display = 'flex';
                    stopButton.style.display = 'none';
                }
            });
        }

        // ËºâÂÖ•È§µÈ£üË®òÈåÑ
        function loadFeedingRecords() {
            getTodayRecordsCount('feeding', (count) => {
                document.getElementById('feeding-count').textContent = count;
                
                getAverageFeedingInterval((interval) => {
                    document.getElementById('feeding-interval').textContent = interval ? `${interval.toFixed(1)} Â∞èÊôÇ` : '-';
                    
                    getRecentRecords('feeding', 20, (records) => {
                        renderFeedingRecords(records);
                        renderFeedingChart(records);
                    });
                });
            });
        }

        // ËºâÂÖ•Áù°Áú†Ë®òÈåÑ
        function loadSleepRecords() {
            getTodaySleepHours((hours) => {
                document.getElementById('sleep-hours').textContent = `${hours.toFixed(1)} Â∞èÊôÇ`;
                
                getAverageSleepQuality((quality) => {
                    document.getElementById('sleep-quality').textContent = quality === 'good' ? 'ËâØÂ•Ω' : quality === 'normal' ? 'ÊôÆÈÄö' : '‰∏ç‰Ω≥';
                    
                    getRecentRecords('sleep', 20, (records) => {
                        renderSleepRecords(records);
                    });
                });
            });
        }

        // ËºâÂÖ•Â∞øÂ∏ÉË®òÈåÑ
        function loadDiaperRecords() {
            getTodayRecordsCount('diaper', (count) => {
                document.getElementById('diaper-count').textContent = count;
                
                getDiaperTypeDistribution((distribution) => {
                    document.getElementById('diaper-types').textContent = 
                        `Â∞øÂ∏É ${distribution.wet || 0}„ÄÅ‰æø‰æø ${distribution.dirty || 0}„ÄÅÊ∑∑Âêà ${distribution.mixed || 0}`;
                    
                    getRecentRecords('diaper', 20, (records) => {
                        renderDiaperRecords(records);
                        renderDiaperChart(records);
                    });
                });
            });
        }

        // Ê∏≤ÊüìÈ§µÈ£üË®òÈåÑ
        function renderFeedingRecords(records) {
            const recordsElement = document.getElementById('feeding-records');
            
            if (records.length === 0) {
                recordsElement.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-text">Â∞öÁÑ°È§µÈ£üÁ¥ÄÈåÑ</div>
                    </div>
                `;
                return;
            }
            
            recordsElement.innerHTML = '';
            
            records.forEach(record => {
                const recordItem = document.createElement('div');
                recordItem.className = 'record-item';
                
                const methodText = record.method === 'breastfeeding' ? 'ÊØç‰π≥' : 
                                  record.method === 'formula' ? 'ÈÖçÊñπÂ•∂' : 'ÂâØÈ£üÂìÅ';
                
                const sideText = record.method === 'breastfeeding' ? 
                                (record.side === 'left' ? 'Â∑¶ÂÅ¥' : 'Âè≥ÂÅ¥') : '';
                
                recordItem.innerHTML = `
                    <div class="record-main">
                        <div class="record-time">${formatDateTime(new Date(record.timestamp))}</div>
                        <div class="record-details">
                            <span class="record-tag">${methodText}</span>
                            ${sideText ? `<span class="record-tag">${sideText}</span>` : ''}
                            ${record.amount ? `<span class="record-tag">${record.amount} ml</span>` : ''}
                        </div>
                    </div>
                    <button class="btn-icon" data-id="${record.id}">√ó</button>
                `;
                
                // Á∂ÅÂÆöÂà™Èô§ÊåâÈàï
                recordItem.querySelector('.btn-icon').addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteRecord('feeding', record.id, () => {
                        loadFeedingRecords();
                    });
                });
                
                recordsElement.appendChild(recordItem);
            });
        }

        // Ê∏≤ÊüìÈ§µÈ£üÁµ±Ë®àÂúñË°®
        function renderFeedingChart(records) {
            const chartElement = document.getElementById('feeding-chart');
            
            // Ëã•Ë®òÈåÑÂ∞ëÊñº 2 Á≠ÜÔºå‰∏çÈ°ØÁ§∫ÂúñË°®
            if (records.length < 2) {
                chartElement.innerHTML = `
                    <div class="empty-state" style="padding: 10px 0;">
                        <div class="empty-text">Ë≥áÊñô‰∏çË∂≥ÔºåÁÑ°Ê≥ïÈ°ØÁ§∫Ë∂®Âã¢</div>
                    </div>
                `;
                return;
            }
            
            // Ë®àÁÆóÈÅéÂéª 7 Â§©ÊØèÂ§©ÁöÑÈ§µÈ£üÊ¨°Êï∏
            const days = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                days.push({
                    date: date,
                    count: 0
                });
            }
            
            records.forEach(record => {
                const recordDate = new Date(record.timestamp);
                
                for (let day of days) {
                    if (recordDate.toDateString() === day.date.toDateString()) {
                        day.count++;
                        break;
                    }
                }
            });
            
            // ÊâæÂá∫ÊúÄÂ§ßÂÄºÔºåÁî®ÊñºË®àÁÆóÊØî‰æã
            const maxCount = Math.max(...days.map(day => day.count));
            
            // Ê∏≤ÊüìÁ∞°ÊòìÊü±ÁãÄÂúñ
            chartElement.innerHTML = '';
            
            days.forEach(day => {
                const height = day.count > 0 ? (day.count / maxCount) * 100 : 4;
                
                const bar = document.createElement('div');
                bar.className = 'stat-bar';
                bar.style.height = `${height}%`;
                
                const dayLabel = document.createElement('div');
                dayLabel.className = 'stat-label';
                dayLabel.textContent = formatDayOfWeek(day.date);
                
                bar.appendChild(dayLabel);
                chartElement.appendChild(bar);
            });
        }

        // Ê∏≤ÊüìÁù°Áú†Ë®òÈåÑ
        function renderSleepRecords(records) {
            const recordsElement = document.getElementById('sleep-records');
            
            if (records.length === 0) {
                recordsElement.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-text">Â∞öÁÑ°Áù°Áú†Á¥ÄÈåÑ</div>
                    </div>
                `;
                return;
            }
            
            recordsElement.innerHTML = '';
            
            records.forEach(record => {
                const recordItem = document.createElement('div');
                recordItem.className = 'record-item';
                
                const qualityText = record.quality === 'good' ? 'ÂÆâÁ©©' : 
                                  record.quality === 'normal' ? 'ÊôÆÈÄö' : '‰∏ç‰Ω≥';
                
                const hours = Math.floor(record.duration / 60);
                const minutes = record.duration % 60;
                const durationText = hours > 0 ? 
                                    `${hours} Â∞èÊôÇ ${minutes} ÂàÜÈêò` : 
                                    `${minutes} ÂàÜÈêò`;
                
                recordItem.innerHTML = `
                    <div class="record-main">
                        <div class="record-time">${formatDateTime(new Date(record.timestamp))}</div>
                        <div class="record-details">
                            <span class="record-tag">${durationText}</span>
                            <span class="record-tag">${qualityText}</span>
                        </div>
                    </div>
                    <button class="btn-icon" data-id="${record.id}">√ó</button>
                `;
                
                // Á∂ÅÂÆöÂà™Èô§ÊåâÈàï
                recordItem.querySelector('.btn-icon').addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteRecord('sleep', record.id, () => {
                        loadSleepRecords();
                    });
                });
                
                recordsElement.appendChild(recordItem);
            });
        }

        // Ê∏≤ÊüìÂ∞øÂ∏ÉË®òÈåÑ
        function renderDiaperRecords(records) {
            const recordsElement = document.getElementById('diaper-records');
            
            if (records.length === 0) {
                recordsElement.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-text">Â∞öÁÑ°Â∞øÂ∏ÉÁ¥ÄÈåÑ</div>
                    </div>
                `;
                return;
            }
            
            recordsElement.innerHTML = '';
            
            records.forEach(record => {
                const recordItem = document.createElement('div');
                recordItem.className = 'record-item';
                
                const typeText = record.type === 'wet' ? 'Â∞øÂ∏É' : 
                               record.type === 'dirty' ? '‰æø‰æø' : 'Ê∑∑Âêà';
                
                recordItem.innerHTML = `
                    <div class="record-main">
                        <div class="record-time">${formatDateTime(new Date(record.timestamp))}</div>
                        <div class="record-details">
                            <span class="record-tag">${typeText}</span>
                            ${record.note ? `<span class="record-tag">${record.note}</span>` : ''}
                        </div>
                    </div>
                    <button class="btn-icon" data-id="${record.id}">√ó</button>
                `;
                
                // Á∂ÅÂÆöÂà™Èô§ÊåâÈàï
                recordItem.querySelector('.btn-icon').addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteRecord('diaper', record.id, () => {
                        loadDiaperRecords();
                    });
                });
                
                recordsElement.appendChild(recordItem);
            });
        }

        // Ê∏≤ÊüìÂ∞øÂ∏ÉÁµ±Ë®àÂúñË°®
        function renderDiaperChart(records) {
            const chartElement = document.getElementById('diaper-chart');
            
            // Ëã•Ë®òÈåÑÂ∞ëÊñº 2 Á≠ÜÔºå‰∏çÈ°ØÁ§∫ÂúñË°®
            if (records.length < 2) {
                chartElement.innerHTML = `
                    <div class="empty-state" style="padding: 10px 0;">
                        <div class="empty-text">Ë≥áÊñô‰∏çË∂≥ÔºåÁÑ°Ê≥ïÈ°ØÁ§∫Ë∂®Âã¢</div>
                    </div>
                `;
                return;
            }
            
            // Ë®àÁÆóÈÅéÂéª 7 Â§©ÊØèÂ§©ÁöÑÂ∞øÂ∏ÉÊ¨°Êï∏
            const days = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                days.push({
                    date: date,
                    count: 0
                });
            }
            
            records.forEach(record => {
                const recordDate = new Date(record.timestamp);
                
                for (let day of days) {
                    if (recordDate.toDateString() === day.date.toDateString()) {
                        day.count++;
                        break;
                    }
                }
            });
            
            // ÊâæÂá∫ÊúÄÂ§ßÂÄºÔºåÁî®ÊñºË®àÁÆóÊØî‰æã
            const maxCount = Math.max(...days.map(day => day.count));
            
            // Ê∏≤ÊüìÁ∞°ÊòìÊü±ÁãÄÂúñ
            chartElement.innerHTML = '';
            
            days.forEach(day => {
                const height = day.count > 0 ? (day.count / maxCount) * 100 : 4;
                
                const bar = document.createElement('div');
                bar.className = 'stat-bar';
                bar.style.height = `${height}%`;
                bar.style.backgroundColor = 'var(--tertiary-light)';
                
                const dayLabel = document.createElement('div');
                dayLabel.className = 'stat-label';
                dayLabel.textContent = formatDayOfWeek(day.date);
                
                bar.appendChild(dayLabel);
                chartElement.appendChild(bar);
            });
        }

        // È°ØÁ§∫Êñ∞Â¢ûÈ§µÈ£üË®òÈåÑÂΩàÁ™ó
        function showAddFeedingModal() {
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            
            modalTitle.textContent = 'Êñ∞Â¢ûÈ§µÈ£üÁ¥ÄÈåÑ';
            modalBody.innerHTML = `
                <form id="add-feeding-form">
                    <div class="form-group">
                        <label class="form-label">È§µÈ£üÈ°ûÂûã</label>
                        <div class="toggle-group" id="feeding-method">
                            <div class="toggle-option active" data-value="breastfeeding">ÊØç‰π≥</div>
                            <div class="toggle-option" data-value="formula">ÈÖçÊñπÂ•∂</div>
                            <div class="toggle-option" data-value="solid">ÂâØÈ£üÂìÅ</div>
                        </div>
                    </div>
                    
                    <div class="form-group" id="breast-side-group">
                        <label class="form-label">Âì∫‰π≥ÂÅ¥ÈÇä</label>
                        <div class="toggle-group" id="breast-side">
                            <div class="toggle-option active" data-value="left">Â∑¶ÂÅ¥</div>
                            <div class="toggle-option" data-value="right">Âè≥ÂÅ¥</div>
                        </div>
                    </div>
                    
                    <div class="form-group" id="amount-group" style="display: none;">
                        <label class="form-label">È§µÈ£üÈáè (ml)</label>
                        <input type="number" class="form-control" id="feeding-amount" placeholder="‰æãÔºö120">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ÊôÇÈñì</label>
                        <input type="datetime-local" class="form-control" id="feeding-time" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ÂÇôË®ª</label>
                        <input type="text" class="form-control" id="feeding-note" placeholder="ÈÅ∏Â°´">
                    </div>
                    
                    <button type="submit" class="btn" style="width: 100%;">ÂÑ≤Â≠ò</button>
                </form>
            `;
            
            // Ë®≠ÂÆöÈ†êË®≠ÊôÇÈñìÁÇ∫ÁèæÂú®
            document.getElementById('feeding-time').value = formatDateTimeLocal(new Date());
            
            // È§µÈ£üÈ°ûÂûãÂàáÊèõ
            const methodOptions = modalBody.querySelectorAll('#feeding-method .toggle-option');
            let selectedMethod = 'breastfeeding';
            
            methodOptions.forEach(option => {
                option.addEventListener('click', () => {
                    methodOptions.forEach(opt => opt.classList.remove('active'));
                    option.classList.add('active');
                    selectedMethod = option.dataset.value;
                    
                    // Ê†πÊìöÈ§µÈ£üÈ°ûÂûãÈ°ØÁ§∫/Èö±ËóèÁõ∏ÈóúÊ¨Ñ‰Ωç
                    if (selectedMethod === 'breastfeeding') {
                        document.getElementById('breast-side-group').style.display = 'block';
                        document.getElementById('amount-group').style.display = 'none';
                    } else {
                        document.getElementById('breast-side-group').style.display = 'none';
                        document.getElementById('amount-group').style.display = 'block';
                    }
                });
            });
            
            // Âì∫‰π≥ÂÅ¥ÈÇäÂàáÊèõ
            const sideOptions = modalBody.querySelectorAll('#breast-side .toggle-option');
            let selectedSide = 'left';
            
            sideOptions.forEach(option => {
                option.addEventListener('click', () => {
                    sideOptions.forEach(opt => opt.classList.remove('active'));
                    option.classList.add('active');
                    selectedSide = option.dataset.value;
                });
            });
            
            // Ë°®ÂñÆÊèê‰∫§
            const form = document.getElementById('add-feeding-form');
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const time = document.getElementById('feeding-time').value;
                const note = document.getElementById('feeding-note').value.trim();
                const amount = document.getElementById('feeding-amount').value;
                
                if (!time) {
                    showToast('Ë´ãÈÅ∏ÊìáÊôÇÈñì');
                    return;
                }
                
                // Êñ∞Â¢ûÈ§µÈ£üË®òÈåÑ
                const feedingData = {
                    childId: currentChildId,
                    timestamp: new Date(time).toISOString(),
                    method: selectedMethod,
                    note: note
                };
                
                if (selectedMethod === 'breastfeeding') {
                    feedingData.side = selectedSide;
                } else if (amount) {
                    feedingData.amount = parseInt(amount);
                }
                
                addRecord('feeding', feedingData, () => {
                    showToast('ÊàêÂäüÊñ∞Â¢ûÈ§µÈ£üÁ¥ÄÈåÑ');
                    closeModal();
                    
                    // ÈáçÊñ∞ËºâÂÖ•È§µÈ£üË®òÈåÑ
                    loadFeedingRecords();
                    
                    // Â¶ÇÊûúÂú®È¶ñÈ†ÅÔºå‰πüÈáçÊñ∞ËºâÂÖ•‰ªäÊó•Ë®òÈåÑ
                    if (currentPage === 'home') {
                        loadTodayRecords();
                    }
                });
            });
            
            openModal();
        }

        // È°ØÁ§∫Êñ∞Â¢ûÁù°Áú†Ë®òÈåÑÂΩàÁ™ó
        function showAddSleepModal() {
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            
            modalTitle.textContent = 'Êñ∞Â¢ûÁù°Áú†Á¥ÄÈåÑ';
            modalBody.innerHTML = `
                <form id="add-sleep-form">
                    <div class="form-group">
                        <label class="form-label">ÈñãÂßãÊôÇÈñì</label>
                        <input type="datetime-local" class="form-control" id="sleep-start-time" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ÊåÅÁ∫åÊôÇÈñì (ÂàÜÈêò)</label>
                        <input type="number" class="form-control" id="sleep-duration" placeholder="‰æãÔºö120" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Áù°Áú†ÂìÅË≥™</label>
                        <div class="toggle-group" id="sleep-quality">
                            <div class="toggle-option" data-value="good">ÂÆâÁ©©</div>
                            <div class="toggle-option active" data-value="normal">ÊôÆÈÄö</div>
                            <div class="toggle-option" data-value="poor">‰∏ç‰Ω≥</div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ÂÇôË®ª</label>
                        <input type="text" class="form-control" id="sleep-note" placeholder="ÈÅ∏Â°´">
                    </div>
                    
                    <button type="submit" class="btn" style="width: 100%;">ÂÑ≤Â≠ò</button>
                </form>
            `;
            
            // Ë®≠ÂÆöÈ†êË®≠ÊôÇÈñìÁÇ∫ÁèæÂú®
            document.getElementById('sleep-start-time').value = formatDateTimeLocal(new Date(new Date().getTime() - 60 * 60 * 1000)); // È†êË®≠‰∏ÄÂ∞èÊôÇÂâç
            
            // Áù°Áú†ÂìÅË≥™ÂàáÊèõ
            const qualityOptions = modalBody.querySelectorAll('#sleep-quality .toggle-option');
            let selectedQuality = 'normal';
            
            qualityOptions.forEach(option => {
                option.addEventListener('click', () => {
                    qualityOptions.forEach(opt => opt.classList.remove('active'));
                    option.classList.add('active');
                    selectedQuality = option.dataset.value;
                });
            });
            
            // Ë°®ÂñÆÊèê‰∫§
            const form = document.getElementById('add-sleep-form');
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const startTime = document.getElementById('sleep-start-time').value;
                const duration = document.getElementById('sleep-duration').value;
                const note = document.getElementById('sleep-note').value.trim();
                
                if (!startTime || !duration) {
                    showToast('Ë´ãÂ°´ÂØ´ÊâÄÊúâÂøÖÂ°´Ê¨Ñ‰Ωç');
                    return;
                }
                
                // Êñ∞Â¢ûÁù°Áú†Ë®òÈåÑ
                const sleepData = {
                    childId: currentChildId,
                    timestamp: new Date(startTime).toISOString(),
                    duration: parseInt(duration),
                    quality: selectedQuality,
                    note: note
                };
                
                addRecord('sleep', sleepData, () => {
                    showToast('ÊàêÂäüÊñ∞Â¢ûÁù°Áú†Á¥ÄÈåÑ');
                    closeModal();
                    
                    // ÈáçÊñ∞ËºâÂÖ•Áù°Áú†Ë®òÈåÑ
                    loadSleepRecords();
                    
                    // Â¶ÇÊûúÂú®È¶ñÈ†ÅÔºå‰πüÈáçÊñ∞ËºâÂÖ•‰ªäÊó•Ë®òÈåÑ
                    if (currentPage === 'home') {
                        loadTodayRecords();
                    }
                });
            });
            
            openModal();
        }

        // È°ØÁ§∫Êñ∞Â¢ûÂ∞øÂ∏ÉË®òÈåÑÂΩàÁ™ó
        function showAddDiaperModal() {
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            
            modalTitle.textContent = 'Êñ∞Â¢ûÂ∞øÂ∏ÉÁ¥ÄÈåÑ';
            modalBody.innerHTML = `
                <form id="add-diaper-form">
                    <div class="form-group">
                        <label class="form-label">Â∞øÂ∏ÉÈ°ûÂûã</label>
                        <div class="toggle-group" id="diaper-type">
                            <div class="toggle-option active" data-value="wet">Â∞øÂ∏É</div>
                            <div class="toggle-option" data-value="dirty">‰æø‰æø</div>
                            <div class="toggle-option" data-value="mixed">Ê∑∑Âêà</div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ÊôÇÈñì</label>
                        <input type="datetime-local" class="form-control" id="diaper-time" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ÁâπÂæµ</label>
                        <input type="text" class="form-control" id="diaper-note" placeholder="‰æãÔºöÈ°èËâ≤„ÄÅË≥™Âú∞Á≠â">
                    </div>
                    
                    <button type="submit" class="btn" style="width: 100%;">ÂÑ≤Â≠ò</button>
                </form>
            `;
            
            // Ë®≠ÂÆöÈ†êË®≠ÊôÇÈñìÁÇ∫ÁèæÂú®
            document.getElementById('diaper-time').value = formatDateTimeLocal(new Date());
            
            // Â∞øÂ∏ÉÈ°ûÂûãÂàáÊèõ
            const typeOptions = modalBody.querySelectorAll('#diaper-type .toggle-option');
            let selectedType = 'wet';
            
            typeOptions.forEach(option => {
                option.addEventListener('click', () => {
                    typeOptions.forEach(opt => opt.classList.remove('active'));
                    option.classList.add('active');
                    selectedType = option.dataset.value;
                });
            });
            
            // Ë°®ÂñÆÊèê‰∫§
            const form = document.getElementById('add-diaper-form');
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const time = document.getElementById('diaper-time').value;
                const note = document.getElementById('diaper-note').value.trim();
                
                if (!time) {
                    showToast('Ë´ãÈÅ∏ÊìáÊôÇÈñì');
                    return;
                }
                
                // Êñ∞Â¢ûÂ∞øÂ∏ÉË®òÈåÑ
                const diaperData = {
                    childId: currentChildId,
                    timestamp: new Date(time).toISOString(),
                    type: selectedType,
                    note: note
                };
                
                addRecord('diaper', diaperData, () => {
                    showToast('ÊàêÂäüÊñ∞Â¢ûÂ∞øÂ∏ÉÁ¥ÄÈåÑ');
                    closeModal();
                    
                    // ÈáçÊñ∞ËºâÂÖ•Â∞øÂ∏ÉË®òÈåÑ
                    loadDiaperRecords();
                    
                    // Â¶ÇÊûúÂú®È¶ñÈ†ÅÔºå‰πüÈáçÊñ∞ËºâÂÖ•‰ªäÊó•Ë®òÈåÑ
                    if (currentPage === 'home') {
                        loadTodayRecords();
                    }
                });
            });
            
            openModal();
        }

        // ËºâÂÖ•ÁôºÂ±ïÈ†ÅÈù¢
        function loadDevelopmentPage() {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <div class="tabs">
                    <div class="tab active" data-tab="milestones">ÈáåÁ®ãÁ¢ë</div>
                    <div class="tab" data-tab="activities">Ê¥ªÂãï</div>
                    <div class="tab" data-tab="interaction">Ë¶™Â≠ê‰∫íÂãï</div>
                </div>
                
                <div class="tab-content active" id="milestones-content">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">ÁôºÂ±ïÈáåÁ®ãÁ¢ë</div>
                        </div>
                        <div class="card-content">
                            <div class="tabs" id="milestone-categories">
                                <div class="tab active" data-category="all">ÂÖ®ÈÉ®</div>
                                <div class="tab" data-category="motor">Âãï‰Ωú</div>
                                <div class="tab" data-category="language">Ë™ûË®Ä</div>
                                <div class="tab" data-category="social">Á§æ‰∫§</div>
                                <div class="tab" data-category="cognitive">Ë™çÁü•</div>
                                <div class="tab" data-category="emotional">ÊÉÖÁ∑í</div>
                                <div class="tab" data-category="self-help">Ëá™ÁêÜ</div>
                            </div>
                            
                            <div id="milestones-list">
                                <div class="loader"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="tab-content" id="activities-content">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Êó•Â∏∏Ê¥ªÂãï</div>
                            <button class="btn-icon" id="add-activity-btn">+</button>
                        </div>
                        <div class="card-content">
                            <div id="activities-list">
                                <div class="loader"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="tab-content" id="interaction-content">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Ë¶™Â≠ê‰∫íÂãï</div>
                            <button class="btn-icon" id="add-interaction-btn">+</button>
                        </div>
                        <div class="card-content">
                            <div id="interactions-list">
                                <div class="loader"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Ë®≠ÂÆöÈ†ÅÁ±§ÂàáÊèõ
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    // Ê™¢Êü•ÊòØÂê¶ÁÇ∫‰∏ªÈ†ÅÁ±§ÊàñÂ≠êÈ†ÅÁ±§
                    if (tab.closest('.tabs').id === 'milestone-categories') {
                        // Â≠êÈ†ÅÁ±§ÔºàÈáåÁ®ãÁ¢ëÂàÜÈ°ûÔºâ
                        document.querySelectorAll('#milestone-categories .tab').forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        loadMilestones(tab.dataset.category);
                    } else {
                        // ‰∏ªÈ†ÅÁ±§
                        document.querySelectorAll('.tabs:not(#milestone-categories) .tab').forEach(t => t.classList.remove('active'));
                        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                        
                        tab.classList.add('active');
                        document.getElementById(`${tab.dataset.tab}-content`).classList.add('active');
                    }
                });
            });
            
            // Á∂ÅÂÆöÊñ∞Â¢ûÊåâÈàï
            document.getElementById('add-activity-btn').addEventListener('click', () => {
                showAddActivityModal();
            });
            
            document.getElementById('add-interaction-btn').addEventListener('click', () => {
                showAddInteractionModal();
            });
            
            // ËºâÂÖ•ÈáåÁ®ãÁ¢ë
            loadMilestones('all');
            
            // ËºâÂÖ•Ê¥ªÂãïË®òÈåÑ
            loadActivities();
            
            // ËºâÂÖ•Ë¶™Â≠ê‰∫íÂãïË®òÈåÑ
            loadInteractions();
        }

        // ËºâÂÖ•ÈáåÁ®ãÁ¢ë
        function loadMilestones(category = 'all') {
            const milestonesListElement = document.getElementById('milestones-list');
            milestonesListElement.innerHTML = '<div class="loader"></div>';
            
            const transaction = db.transaction(['milestones'], 'readonly');
            const milestonesStore = transaction.objectStore('milestones');
            const index = milestonesStore.index('childId');
            const range = IDBKeyRange.only(currentChildId);
            const request = index.openCursor(range);
            
            let milestones = [];
            
            request.onsuccess = (event) => {
                const cursor = event.target.result;
                
                if (cursor) {
                    milestones.push(cursor.value);
                    cursor.continue();
                } else {
                    // Â¶ÇÊûúÊåáÂÆö‰∫ÜÂàÜÈ°ûÔºåÈÅéÊøæÈáåÁ®ãÁ¢ë
                    if (category !== 'all') {
                        milestones = milestones.filter(m => m.category === category);
                    }
                    
                    // ÊéíÂ∫èÔºàÊåâÂπ¥ÈΩ°Ôºâ
                    milestones.sort((a, b) => a.ageMonths - b.ageMonths);
                    
                    if (milestones.length === 0) {
                        milestonesListElement.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-text">Ê≤íÊúâÈáåÁ®ãÁ¢ëË®òÈåÑ</div>
                            </div>
                        `;
                    } else {
                        milestonesListElement.innerHTML = '';
                        
                        // ÊåâÈ°ûÂà•ÂàÜÁµÑÈ°ØÁ§∫
                        const categories = {
                            'motor': 'Âãï‰ΩúËÉΩÂäõ',
                            'language': 'Ë™ûË®ÄËÉΩÂäõ',
                            'social': 'Á§æ‰∫§ËÉΩÂäõ',
                            'cognitive': 'Ë™çÁü•ËÉΩÂäõ',
                            'emotional': 'ÊÉÖÁ∑íÁôºÂ±ï',
                            'self-help': 'Ëá™ÁêÜËÉΩÂäõ'
                        };
                        
                        // Â¶ÇÊûúÊòØÂÖ®ÈÉ®ÂàÜÈ°ûÔºåÂÖàÂàÜÁµÑ
                        if (category === 'all') {
                            const groupedMilestones = {};
                            
                            for (const cat in categories) {
                                groupedMilestones[cat] = milestones.filter(m => m.category === cat);
                            }
                            
                            for (const cat in groupedMilestones) {
                                if (groupedMilestones[cat].length > 0) {
                                    const categoryTitle = document.createElement('div');
                                    categoryTitle.textContent = categories[cat];
                                    categoryTitle.style.fontWeight = '600';
                                    categoryTitle.style.marginTop = '16px';
                                    categoryTitle.style.marginBottom = '8px';
                                    
                                    milestonesListElement.appendChild(categoryTitle);
                                    
                                    groupedMilestones[cat].forEach(milestone => {
                                        appendMilestoneItem(milestone, milestonesListElement);
                                    });
                                }
                            }
                        } else {
                            // ÂñÆ‰∏ÄÂàÜÈ°ûÁõ¥Êé•È°ØÁ§∫
                            milestones.forEach(milestone => {
                                appendMilestoneItem(milestone, milestonesListElement);
                            });
                        }
                    }
                }
            };
        }

        // Ê∑ªÂä†ÈáåÁ®ãÁ¢ëÈ†ÖÁõÆ
        function appendMilestoneItem(milestone, container) {
            const milestoneItem = document.createElement('div');
            milestoneItem.className = 'milestone-item';
            milestoneItem.dataset.id = milestone.id;
            
            if (milestone.completed) {
                milestoneItem.classList.add('completed');
            }
            
            milestoneItem.innerHTML = `
                <div class="milestone-header">
                    <div>${milestone.title}</div>
                    <div class="milestone-age">${milestone.ageMonths} ÂÄãÊúà</div>
                </div>
                ${milestone.description ? `<div style="font-size: 0.85rem; margin-top: 6px;">${milestone.description}</div>` : ''}
                ${milestone.completed ? '<div class="checkmark">‚úì Â∑≤ÂÆåÊàê</div>' : ''}
            `;
            
            // ÈªûÊìäÈáåÁ®ãÁ¢ëÂàáÊèõÂÆåÊàêÁãÄÊÖã
            milestoneItem.addEventListener('click', () => {
                toggleMilestoneStatus(milestone.id);
            });
            
            container.appendChild(milestoneItem);
        }

        // ËºâÂÖ•Ê¥ªÂãïË®òÈåÑ
        function loadActivities() {
            const activitiesListElement = document.getElementById('activities-list');
            
            getRecentRecords('activities', 20, (records) => {
                if (records.length === 0) {
                    activitiesListElement.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-text">Â∞öÁÑ°Ê¥ªÂãïÁ¥ÄÈåÑ</div>
                        </div>
                    `;
                } else {
                    activitiesListElement.innerHTML = '';
                    
                    records.forEach(activity => {
                        const activityItem = document.createElement('div');
                        activityItem.className = 'record-item';
                        
                        activityItem.innerHTML = `
                            <div class="record-main">
                                <div class="record-time">${formatDateTime(new Date(activity.timestamp))}</div>
                                <div class="record-details">
                                    <span class="record-tag">${activity.type}</span>
                                    ${activity.duration ? `<span class="record-tag">${activity.duration} ÂàÜÈêò</span>` : ''}
                                </div>
                                ${activity.note ? `<div style="font-size: 0.9rem; margin-top: 4px;">${activity.note}</div>` : ''}
                            </div>
                            <button class="btn-icon" data-id="${activity.id}">√ó</button>
                        `;
                        
                        // Á∂ÅÂÆöÂà™Èô§ÊåâÈàï
                        activityItem.querySelector('.btn-icon').addEventListener('click', (e) => {
                            e.stopPropagation();
                            deleteRecord('activities', activity.id, () => {
                                loadActivities();
                            });
                        });
                        
                        activitiesListElement.appendChild(activityItem);
                    });
                }
            });
        }

        // ËºâÂÖ•Ë¶™Â≠ê‰∫íÂãïË®òÈåÑ
        function loadInteractions() {
            const interactionsListElement = document.getElementById('interactions-list');
            
            getRecentRecords('interactions', 20, (records) => {
                if (records.length === 0) {
                    interactionsListElement.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-text">Â∞öÁÑ°Ë¶™Â≠ê‰∫íÂãïÁ¥ÄÈåÑ</div>
                        </div>
                    `;
                } else {
                    interactionsListElement.innerHTML = '';
                    
                    // È°ØÁ§∫ÊâÄÊúâ‰∫íÂãïË®òÈåÑÔºàÂê´ÁÖßÁâáÔºâ
                    records.forEach(interaction => {
                        const interactionItem = document.createElement('div');
                        interactionItem.className = 'record-item';
                        
                        const moodEmoji = getMoodEmoji(interaction.mood);
                        const moodText = getMoodText(interaction.mood);
                        
                        interactionItem.innerHTML = `
                            <div class="record-main">
                                <div class="record-time">${formatDateTime(new Date(interaction.timestamp))}</div>
                                <div class="record-details">
                                    <span class="record-tag">${moodEmoji} ${moodText}</span>
                                </div>
                                ${interaction.note ? `<div style="font-size: 0.9rem; margin-top: 4px;">${interaction.note}</div>` : ''}
                                ${interaction.photoData ? `
                                    <div class="interaction-photo">
                                        <img src="${interaction.photoData}" alt="‰∫íÂãïÁÖßÁâá">
                                    </div>` : ''}
                            </div>
                            <button class="btn-icon" data-id="${interaction.id}">√ó</button>
                        `;
                        
                        // Á∂ÅÂÆöÂà™Èô§ÊåâÈàï
                        interactionItem.querySelector('.btn-icon').addEventListener('click', (e) => {
                            e.stopPropagation();
                            deleteRecord('interactions', interaction.id, () => {
                                loadInteractions();
                            });
                        });
                        
                        interactionsListElement.appendChild(interactionItem);
                    });
                }
            });
        }

        // È°ØÁ§∫Êñ∞Â¢ûÊ¥ªÂãïË®òÈåÑÂΩàÁ™ó
        function showAddActivityModal() {
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            
            modalTitle.textContent = 'Êñ∞Â¢ûÊ¥ªÂãïÁ¥ÄÈåÑ';
            modalBody.innerHTML = `
                <form id="add-activity-form">
                    <div class="form-group">
                        <label class="form-label">Ê¥ªÂãïÈ°ûÂûã</label>
                        <input type="text" class="form-control" id="activity-type" placeholder="‰æãÔºöÈñ±ËÆÄ„ÄÅÁé©ËÄç„ÄÅÂ§ñÂá∫" list="activity-types" required>
                        <datalist id="activity-types">
                            <option value="Èñ±ËÆÄ">
                            <option value="Áé©ËÄç">
                            <option value="Â§ñÂá∫">
                            <option value="Ê¥óÊæ°">
                            <option value="ÈÅãÂãï">
                            <option value="Èü≥Ê®Ç">
                            <option value="Â≠∏Áøí">
                        </datalist>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ÊôÇÈñì</label>
                        <input type="datetime-local" class="form-control" id="activity-time" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ÊåÅÁ∫åÊôÇÈñì (ÂàÜÈêò)</label>
                        <input type="number" class="form-control" id="activity-duration" placeholder="ÈÅ∏Â°´">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ÂÇôË®ª</label>
                        <textarea class="form-control" id="activity-note" placeholder="ÈÅ∏Â°´" rows="3"></textarea>
                    </div>
                    
                    <button type="submit" class="btn" style="width: 100%;">ÂÑ≤Â≠ò</button>
                </form>
            `;
            
            // Ë®≠ÂÆöÈ†êË®≠ÊôÇÈñìÁÇ∫ÁèæÂú®
            document.getElementById('activity-time').value = formatDateTimeLocal(new Date());
            
            // Ë°®ÂñÆÊèê‰∫§
            const form = document.getElementById('add-activity-form');
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const type = document.getElementById('activity-type').value.trim();
                const time = document.getElementById('activity-time').value;
                const duration = document.getElementById('activity-duration').value;
                const note = document.getElementById('activity-note').value.trim();
                
                if (!type || !time) {
                    showToast('Ë´ãÂ°´ÂØ´ÊâÄÊúâÂøÖÂ°´Ê¨Ñ‰Ωç');
                    return;
                }
                
                // Êñ∞Â¢ûÊ¥ªÂãïË®òÈåÑ
                const activityData = {
                    childId: currentChildId,
                    timestamp: new Date(time).toISOString(),
                    type: type,
                    note: note
                };
                
                if (duration) {
                    activityData.duration = parseInt(duration);
                }
                
                addRecord('activities', activityData, () => {
                    showToast('ÊàêÂäüÊñ∞Â¢ûÊ¥ªÂãïÁ¥ÄÈåÑ');
                    closeModal();
                    
                    // ÈáçÊñ∞ËºâÂÖ•Ê¥ªÂãïË®òÈåÑ
                    loadActivities();
                });
            });
            
            openModal();
        }

        // È°ØÁ§∫Êñ∞Â¢ûË¶™Â≠ê‰∫íÂãïË®òÈåÑÂΩàÁ™óÔºàÂ¢ûÂº∑Áâà - 8Á®ÆÊÉÖÁ∑íÔºâ
        function showAddInteractionModal() {
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            
            modalTitle.textContent = 'Êñ∞Â¢ûË¶™Â≠ê‰∫íÂãï';
            modalBody.innerHTML = `
                <form id="add-interaction-form">
                    <div class="form-group">
                        <label class="form-label">ÊôÇÈñì</label>
                        <input type="datetime-local" class="form-control" id="interaction-time" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ÂØ∂ÂØ∂ÊÉÖÁ∑í</label>
                        <div class="mood-grid" id="interaction-mood">
                            <div class="toggle-option active" data-value="happy">üòÑ ÈñãÂøÉ</div>
                            <div class="toggle-option" data-value="excited">ü§© ËààÂ•Æ</div>
                            <div class="toggle-option" data-value="calm">üòä Âπ≥Èùú</div>
                            <div class="toggle-option" data-value="sleepy">üò¥ ÊÉ≥Áù°</div>
                            <div class="toggle-option" data-value="curious">ü§î Â•ΩÂ•á</div>
                            <div class="toggle-option" data-value="playful">üòÜ ÊÑõÁé©</div>
                            <div class="toggle-option" data-value="sad">üò¢ Èõ£ÈÅé</div>
                            <div class="toggle-option" data-value="angry">üò† ÁîüÊ∞£</div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Ë®òÈåÑÁÖßÁâá</label>
                        <input type="file" id="interaction-photo" class="file-input" accept="image/*">
                        <label for="interaction-photo" class="file-label">ÈÅ∏ÊìáÁÖßÁâá</label>
                        <div id="photo-preview" class="image-preview" style="display: none;">
                            <img id="preview-image" src="" alt="È†êË¶Ω">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ÂÇôË®ª</label>
                        <textarea class="form-control" id="interaction-note" placeholder="ÈÅ∏Â°´" rows="3"></textarea>
                    </div>
                    
                    <button type="submit" class="btn" style="width: 100%;">ÂÑ≤Â≠ò</button>
                </form>
            `;
            
            // Ë®≠ÂÆöÈ†êË®≠ÊôÇÈñìÁÇ∫ÁèæÂú®
            document.getElementById('interaction-time').value = formatDateTimeLocal(new Date());
            
            // ÊÉÖÁ∑íÂàáÊèõ - ÊîØÊè¥8Á®ÆÊÉÖÁ∑í
            const moodOptions = modalBody.querySelectorAll('#interaction-mood .toggle-option');
            let selectedMood = 'happy';
            
            moodOptions.forEach(option => {
                option.addEventListener('click', () => {
                    moodOptions.forEach(opt => opt.classList.remove('active'));
                    option.classList.add('active');
                    selectedMood = option.dataset.value;
                });
            });
            
            // ÁÖßÁâáÈ†êË¶Ω
            const photoInput = document.getElementById('interaction-photo');
            const photoPreview = document.getElementById('photo-preview');
            const previewImage = document.getElementById('preview-image');
            
            photoInput.addEventListener('change', (e) => {
                if (e.target.files && e.target.files[0]) {
                    const reader = new FileReader();
                    
                    reader.onload = (e) => {
                        previewImage.src = e.target.result;
                        photoPreview.style.display = 'block';
                    };
                    
                    reader.readAsDataURL(e.target.files[0]);
                }
            });
            
            // Ë°®ÂñÆÊèê‰∫§
            const form = document.getElementById('add-interaction-form');
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const time = document.getElementById('interaction-time').value;
                const note = document.getElementById('interaction-note').value.trim();
                
                if (!time) {
                    showToast('Ë´ãÈÅ∏ÊìáÊôÇÈñì');
                    return;
                }
                
                // Êñ∞Â¢ûË¶™Â≠ê‰∫íÂãïË®òÈåÑ
                const interactionData = {
                    childId: currentChildId,
                    timestamp: new Date(time).toISOString(),
                    mood: selectedMood,
                    note: note,
                    photoData: previewImage.src || null
                };
                
                addRecord('interactions', interactionData, () => {
                    showToast('ÊàêÂäüÊñ∞Â¢ûË¶™Â≠ê‰∫íÂãï');
                    closeModal();
                    
                    // ÈáçÊñ∞ËºâÂÖ•Ë¶™Â≠ê‰∫íÂãïË®òÈåÑ
                    loadInteractions();
                });
            });
            
            openModal();
        }

        // ËºâÂÖ•ÂÅ•Â∫∑È†ÅÈù¢ÔºàÂ¢ûÂä†È´îÊ∫´Ê®ôÁ±§È†ÅÔºâ
        function loadHealthPage() {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <div class="tabs">
                    <div class="tab active" data-tab="growth">ÊàêÈï∑</div>
                    <div class="tab" data-tab="temperature">È´îÊ∫´</div>
                    <div class="tab" data-tab="vaccine">Áñ´Ëãó</div>
                    <div class="tab" data-tab="medication">Áî®Ëó•</div>
                </div>
                
                <div class="tab-content active" id="growth-content">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Ë∫´È´òÈ´îÈáç</div>
                            <button class="btn-icon" id="add-growth-btn">+</button>
                        </div>
                        <div class="card-content">
                            <div class="growth-chart">
                                <div class="chart-section-title">È´îÈáç (kg)</div>
                                <div class="chart-line" id="weight-chart">
                                    <!-- È´îÈáçÊï∏ÊìöÈªûÂ∞áÂãïÊÖãÊ∑ªÂä† -->
                                </div>
                                
                                <div class="chart-section-title" style="margin-top: 40px;">Ë∫´È´ò (cm)</div>
                                <div class="chart-line" id="height-chart">
                                    <!-- Ë∫´È´òÊï∏ÊìöÈªûÂ∞áÂãïÊÖãÊ∑ªÂä† -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">ÊúÄËøëÁ¥ÄÈåÑ</div>
                        </div>
                        <div class="records-list" id="growth-records">
                            <div class="loader"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Êñ∞Â¢ûÈ´îÊ∫´Ë®òÈåÑÊ®ôÁ±§È†Å -->
                <div class="tab-content" id="temperature-content">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">È´îÊ∫´Ë®òÈåÑ</div>
                            <button class="btn-icon" id="add-temperature-btn">+</button>
                        </div>
                        <div class="card-content">
                            <div class="growth-chart">
                                <div class="chart-section-title">È´îÊ∫´Ë∂®Âã¢ (¬∞C)</div>
                                <div class="chart-line" id="temperature-chart">
                                    <!-- È´îÊ∫´Êï∏ÊìöÈªûÂ∞áÂãïÊÖãÊ∑ªÂä† -->
                                </div>
                            </div>
                            
                            <div class="mini-stat">
                                <div>ÊúÄËøëÈ´îÊ∫´</div>
                                <div class="mini-stat-value" id="recent-temperature">-</div>
                            </div>
                            
                            <div class="mini-stat">
                                <div>Âπ≥ÂùáÈ´îÊ∫´</div>
                                <div class="mini-stat-value" id="average-temperature">-</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">ÊúÄËøëÁ¥ÄÈåÑ</div>
                        </div>
                        <div class="records-list" id="temperature-records">
                            <div class="loader"></div>
                        </div>
                    </div>
                </div>
                
                <div class="tab-content" id="vaccine-content">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Áñ´ËãóÊé•Á®Æ</div>
                            <button class="btn-icon" id="add-vaccine-btn">+</button>
                        </div>
                        <div class="card-content">
                            <div id="vaccine-schedule">
                                <div class="loader"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="tab-content" id="medication-content">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Áî®Ëó•Á¥ÄÈåÑ</div>
                            <button class="btn-icon" id="add-medication-btn">+</button>
                        </div>
                        <div class="records-list" id="medication-records">
                            <div class="loader"></div>
                        </div>
                    </div>
                </div>
            `;
            
            // Ë®≠ÂÆöÈ†ÅÁ±§ÂàáÊèõ
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    tab.classList.add('active');
                    document.getElementById(`${tab.dataset.tab}-content`).classList.add('active');
                });
            });
            
            // Á∂ÅÂÆöÊñ∞Â¢ûÊåâÈàï
            document.getElementById('add-growth-btn').addEventListener('click', () => {
                showAddGrowthModal();
            });
            
            document.getElementById('add-temperature-btn').addEventListener('click', () => {
                showAddTemperatureModal();
            });
            
            document.getElementById('add-vaccine-btn').addEventListener('click', () => {
                showAddVaccineModal();
            });
            
            document.getElementById('add-medication-btn').addEventListener('click', () => {
                showAddMedicationModal();
            });
            
            // ËºâÂÖ•ÊàêÈï∑Ë®òÈåÑ
            loadGrowthRecords();
            
            // ËºâÂÖ•È´îÊ∫´Ë®òÈåÑ
            loadTemperatureRecords();
            
            // ËºâÂÖ•Áñ´ËãóÊé•Á®ÆË®òÈåÑ
            loadVaccineRecords();
            
            // ËºâÂÖ•Áî®Ëó•Ë®òÈåÑ
            loadMedicationRecords();
        }

        // Êñ∞Â¢ûÈ´îÊ∫´Ë®òÈåÑÁõ∏ÈóúÂäüËÉΩ
        function showAddTemperatureModal() {
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            
            modalTitle.textContent = 'Êñ∞Â¢ûÈ´îÊ∫´Ë®òÈåÑ';
            modalBody.innerHTML = `
                <form id="add-temperature-form">
                    <div class="form-group">
                        <label class="form-label">È´îÊ∫´ (¬∞C)</label>
                        <input type="number" class="form-control" id="temperature-value" 
                               step="0.1" min="30" max="45" placeholder="‰æãÔºö36.5" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Ê∏¨ÈáèÊñπÂºè</label>
                        <div class="toggle-group" id="temperature-method">
                            <div class="toggle-option active" data-value="forehead">È°çÊ∫´</div>
                            <div class="toggle-option" data-value="ear">ËÄ≥Ê∫´</div>
                            <div class="toggle-option" data-value="armpit">ËÖãÊ∫´</div>
                            <div class="toggle-option" data-value="oral">Âè£Ê∫´</div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ÊôÇÈñì</label>
                        <input type="datetime-local" class="form-control" id="temperature-time" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ÂÇôË®ª</label>
                        <textarea class="form-control" id="temperature-note" 
                                  placeholder="‰æãÔºöÁôºÁáí„ÄÅÊ¥ªÂãïÂæåÁ≠â" rows="2"></textarea>
                    </div>
                    
                    <button type="submit" class="btn" style="width: 100%;">ÂÑ≤Â≠ò</button>
                </form>
            `;
            
            // Ë®≠ÂÆöÈ†êË®≠ÊôÇÈñìÁÇ∫ÁèæÂú®
            document.getElementById('temperature-time').value = formatDateTimeLocal(new Date());
            
            // Ê∏¨ÈáèÊñπÂºèÂàáÊèõ
            const methodOptions = modalBody.querySelectorAll('#temperature-method .toggle-option');
            let selectedMethod = 'forehead';
            
            methodOptions.forEach(option => {
                option.addEventListener('click', () => {
                    methodOptions.forEach(opt => opt.classList.remove('active'));
                    option.classList.add('active');
                    selectedMethod = option.dataset.value;
                });
            });
            
            // Ë°®ÂñÆÊèê‰∫§
            const form = document.getElementById('add-temperature-form');
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const value = document.getElementById('temperature-value').value;
                const time = document.getElementById('temperature-time').value;
                const note = document.getElementById('temperature-note').value.trim();
                
                if (!value || !time) {
                    showToast('Ë´ãÂ°´ÂØ´ÊâÄÊúâÂøÖÂ°´Ê¨Ñ‰Ωç');
                    return;
                }
                
                const tempValue = parseFloat(value);
                if (tempValue < 30 || tempValue > 45) {
                    showToast('Ë´ãËº∏ÂÖ•ÂêàÁêÜÁöÑÈ´îÊ∫´ÂÄº');
                    return;
                }
                
                // Êñ∞Â¢ûÈ´îÊ∫´Ë®òÈåÑ
                const temperatureData = {
                    childId: currentChildId,
                    timestamp: new Date(time).toISOString(),
                    type: 'temperature',
                    value: tempValue,
                    method: selectedMethod,
                    note: note
                };
                
                addRecord('health', temperatureData, () => {
                    showToast('ÊàêÂäüÊñ∞Â¢ûÈ´îÊ∫´Á¥ÄÈåÑ');
                    closeModal();
                    
                    // ÈáçÊñ∞ËºâÂÖ•È´îÊ∫´Ë®òÈåÑ
                    loadTemperatureRecords();
                });
            });
            
            openModal();
        }

        function loadTemperatureRecords() {
            const temperatureRecordsElement = document.getElementById('temperature-records');
            const recentTemperatureElement = document.getElementById('recent-temperature');
            const averageTemperatureElement = document.getElementById('average-temperature');
            
            getHealthRecordsByType('temperature', (records) => {
                if (records.length === 0) {
                    temperatureRecordsElement.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-text">Â∞öÁÑ°È´îÊ∫´Á¥ÄÈåÑ</div>
                        </div>
                    `;
                    recentTemperatureElement.textContent = '-';
                    averageTemperatureElement.textContent = '-';
                } else {
                    // È°ØÁ§∫ÊúÄËøëÈ´îÊ∫´
                    recentTemperatureElement.textContent = `${records[0].value}¬∞C`;
                    
                    // Ë®àÁÆóÂπ≥ÂùáÈ´îÊ∫´
                    const avgTemp = records.reduce((sum, record) => sum + record.value, 0) / records.length;
                    averageTemperatureElement.textContent = `${avgTemp.toFixed(1)}¬∞C`;
                    
                    // Ê∏≤ÊüìË®òÈåÑÂàóË°®
                    temperatureRecordsElement.innerHTML = '';
                    
                    records.forEach(record => {
                        const recordItem = document.createElement('div');
                        recordItem.className = 'record-item';
                        
                        const methodText = {
                            'forehead': 'È°çÊ∫´',
                            'ear': 'ËÄ≥Ê∫´',
                            'armpit': 'ËÖãÊ∫´',
                            'oral': 'Âè£Ê∫´'
                        }[record.method] || 'È°çÊ∫´';
                        
                        // Âà§Êñ∑È´îÊ∫´ÁãÄÊÖã
                        let tempStatus = '';
                        let tempColor = '';
                        if (record.value >= 38) {
                            tempStatus = 'ÁôºÁáí';
                            tempColor = '#ff6b6b';
                        } else if (record.value >= 37.5) {
                            tempStatus = 'ÂæÆÁáí';
                            tempColor = '#ffa500';
                        } else if (record.value < 36) {
                            tempStatus = 'ÂÅè‰Ωé';
                            tempColor = '#6bb6ff';
                        } else {
                            tempStatus = 'Ê≠£Â∏∏';
                            tempColor = '#51cf66';
                        }
                        
                        recordItem.innerHTML = `
                            <div class="record-main">
                                <div class="record-time">${formatDateTime(new Date(record.timestamp))}</div>
                                <div class="record-details">
                                    <span class="record-tag" style="background-color: ${tempColor}; color: white;">
                                        ${record.value}¬∞C ${tempStatus}
                                    </span>
                                    <span class="record-tag">${methodText}</span>
                                </div>
                                ${record.note ? `<div style="font-size: 0.9rem; margin-top: 4px;">${record.note}</div>` : ''}
                            </div>
                            <button class="btn-icon" data-id="${record.id}">√ó</button>
                        `;
                        
                        // Á∂ÅÂÆöÂà™Èô§ÊåâÈàï
                        recordItem.querySelector('.btn-icon').addEventListener('click', (e) => {
                            e.stopPropagation();
                            deleteRecord('health', record.id, () => {
                                loadTemperatureRecords();
                            });
                        });
                        
                        temperatureRecordsElement.appendChild(recordItem);
                    });
                    
                    // Ê∏≤ÊüìÈ´îÊ∫´ÂúñË°®
                    renderTemperatureChart(records);
                }
            });
        }

        function renderTemperatureChart(records) {
            const chartElement = document.getElementById('temperature-chart');
            
            if (records.length < 2) {
                chartElement.innerHTML = `
                    <div class="empty-state" style="padding: 10px 0;">
                        <div class="empty-text">Ë≥áÊñô‰∏çË∂≥ÔºåÁÑ°Ê≥ïÈ°ØÁ§∫Ë∂®Âã¢</div>
                    </div>
                `;
                return;
            }
            
            // Â∞çË®òÈåÑÈÄ≤Ë°åÊéíÂ∫èÔºàÂæûËàäÂà∞Êñ∞Ôºâ
            const sortedRecords = [...records].sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            
            // ÂèñÊúÄËøë 10 Á≠ÜË®òÈåÑ
            const recentRecords = sortedRecords.slice(-10);
            
            // Ê∏ÖÁ©∫ÂúñË°®
            chartElement.innerHTML = '';
            
            const totalWidth = chartElement.offsetWidth;
            const stepWidth = totalWidth / (recentRecords.length > 1 ? (recentRecords.length - 1) : 2);
            
            recentRecords.forEach((record, index) => {
                const point = document.createElement('div');
                point.className = 'chart-point';
                point.style.left = `${index * stepWidth}px`;
                point.dataset.value = `${record.value}¬∞C`;
                point.dataset.date = formatDate(new Date(record.timestamp));
                
                // Ê†πÊìöÈ´îÊ∫´Ë®≠ÂÆöÈ°èËâ≤
                if (record.value >= 38) {
                    point.style.backgroundColor = '#ff6b6b';
                } else if (record.value >= 37.5) {
                    point.style.backgroundColor = '#ffa500';
                } else if (record.value < 36) {
                    point.style.backgroundColor = '#6bb6ff';
                } else {
                    point.style.backgroundColor = '#51cf66';
                }
                
                chartElement.appendChild(point);
            });
        }
        // ËºâÂÖ•ÊàêÈï∑Ë®òÈåÑ
        function loadGrowthRecords() {
            const growthRecordsElement = document.getElementById('growth-records');
            
            // Êü•Ë©¢È´îÈáçË®òÈåÑ
            getHealthRecordsByType('weight', (weightRecords) => {
                // Êü•Ë©¢Ë∫´È´òË®òÈåÑ
                getHealthRecordsByType('height', (heightRecords) => {
                    // Âêà‰Ωµ‰∏¶ÊéíÂ∫èÔºàÂæûÊñ∞Âà∞ËàäÔºâ
                    const allRecords = [...weightRecords, ...heightRecords].sort((a, b) => 
                        new Date(b.timestamp) - new Date(a.timestamp)
                    );
                    
                    if (allRecords.length === 0) {
                        growthRecordsElement.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-text">Â∞öÁÑ°Ë∫´È´òÈ´îÈáçÁ¥ÄÈåÑ</div>
                            </div>
                        `;
                    } else {
                        growthRecordsElement.innerHTML = '';
                        
                        allRecords.forEach(record => {
                            const recordItem = document.createElement('div');
                            recordItem.className = 'record-item';
                            
                            const isWeight = record.type === 'weight';
                            
                            recordItem.innerHTML = `
                                <div class="record-main">
                                    <div class="record-time">${formatDateTime(new Date(record.timestamp))}</div>
                                    <div class="record-details">
                                        <span class="record-tag">${isWeight ? 'È´îÈáç' : 'Ë∫´È´ò'}</span>
                                        <span class="record-tag">${record.value} ${isWeight ? 'kg' : 'cm'}</span>
                                    </div>
                                </div>
                                <button class="btn-icon" data-id="${record.id}">√ó</button>
                            `;
                            
                            // Á∂ÅÂÆöÂà™Èô§ÊåâÈàï
                            recordItem.querySelector('.btn-icon').addEventListener('click', (e) => {
                                e.stopPropagation();
                                deleteRecord('health', record.id, () => {
                                    loadGrowthRecords();
                                });
                            });
                            
                            growthRecordsElement.appendChild(recordItem);
                        });
                    }
                    
                    // ËºâÂÖ•ÊàêÈï∑ÂúñË°®
                    renderGrowthCharts(weightRecords, heightRecords);
                });
            });
        }

        // Ê∏≤ÊüìÊàêÈï∑ÂúñË°®
        function renderGrowthCharts(weightRecords, heightRecords) {
            const weightChartElement = document.getElementById('weight-chart');
            const heightChartElement = document.getElementById('height-chart');
            
            // Ê∏ÖÁ©∫ÂúñË°®
            weightChartElement.innerHTML = '';
            heightChartElement.innerHTML = '';
            
            // Â∞çË®òÈåÑÈÄ≤Ë°åÊéíÂ∫èÔºàÂæûËàäÂà∞Êñ∞Ôºâ
            weightRecords.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            heightRecords.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            
            // Ê∏≤ÊüìÈ´îÈáçÂúñË°®
            if (weightRecords.length > 0) {
                const totalWidth = weightChartElement.offsetWidth;
                const stepWidth = totalWidth / (weightRecords.length > 1 ? (weightRecords.length - 1) : 2);
                
                weightRecords.forEach((record, index) => {
                    const point = document.createElement('div');
                    point.className = 'chart-point';
                    point.style.left = `${index * stepWidth}px`;
                    point.dataset.value = `${record.value} kg`;
                    point.dataset.date = formatDate(new Date(record.timestamp));
                    
                    weightChartElement.appendChild(point);
                });
            }
            
            // Ê∏≤ÊüìË∫´È´òÂúñË°®
            if (heightRecords.length > 0) {
                const totalWidth = heightChartElement.offsetWidth;
                const stepWidth = totalWidth / (heightRecords.length > 1 ? (heightRecords.length - 1) : 2);
                
                heightRecords.forEach((record, index) => {
                    const point = document.createElement('div');
                    point.className = 'chart-point';
                    point.style.left = `${index * stepWidth}px`;
                    point.dataset.value = `${record.value} cm`;
                    point.dataset.date = formatDate(new Date(record.timestamp));
                    
                    heightChartElement.appendChild(point);
                });
            }
        }

        // ËºâÂÖ•Áñ´ËãóÊé•Á®ÆË®òÈåÑ
        function loadVaccineRecords() {
            const vaccineScheduleElement = document.getElementById('vaccine-schedule');
            
            // Áç≤ÂèñÂè∞ÁÅ£Áñ´ËãóÊé•Á®ÆÊôÇÁ®ãË°®
            const taiwanVaccineSchedule = [
                { month: 0, name: 'B ÂûãËÇùÁÇéÁñ´ËãóÁ¨¨ 1 Âäë' },
                { month: 1, name: 'Âç°‰ªãËãó' },
                { month: 1, name: 'B ÂûãËÇùÁÇéÁñ´ËãóÁ¨¨ 2 Âäë' },
                { month: 2, name: '13 ÂÉπÁµêÂêàÂûãËÇ∫ÁÇéÈèàÁêÉËèåÁñ´ËãóÁ¨¨ 1 Âäë' },
                { month: 2, name: '‰∫îÂêà‰∏ÄÁñ´ËãóÁ¨¨ 1 Âäë' },
                { month: 4, name: '13 ÂÉπÁµêÂêàÂûãËÇ∫ÁÇéÈèàÁêÉËèåÁñ´ËãóÁ¨¨ 2 Âäë' },
                { month: 4, name: '‰∫îÂêà‰∏ÄÁñ´ËãóÁ¨¨ 2 Âäë' },
                { month: 6, name: '13 ÂÉπÁµêÂêàÂûãËÇ∫ÁÇéÈèàÁêÉËèåÁñ´ËãóÁ¨¨ 3 Âäë' },
                { month: 6, name: '‰∫îÂêà‰∏ÄÁñ´ËãóÁ¨¨ 3 Âäë' },
                { month: 6, name: 'B ÂûãËÇùÁÇéÁñ´ËãóÁ¨¨ 3 Âäë' },
                { month: 12, name: 'È∫ªÁñπËÖÆËÖ∫ÁÇéÂæ∑ÂúãÈ∫ªÁñπÁñ´ËãóÁ¨¨ 1 Âäë' },
                { month: 12, name: 'Ê∞¥ÁóòÁñ´Ëãó' },
                { month: 12, name: 'Êó•Êú¨ËÖ¶ÁÇéÁñ´ËãóÁ¨¨ 1„ÄÅ2 Âäë' },
                { month: 15, name: '13 ÂÉπÁµêÂêàÂûãËÇ∫ÁÇéÈèàÁêÉËèåÁñ´ËãóËøΩÂä†Âäë' },
                { month: 18, name: '‰∫îÂêà‰∏ÄÁñ´ËãóËøΩÂä†Âäë' },
                { month: 18, name: 'A ÂûãËÇùÁÇéÁñ´ËãóÁ¨¨ 1 Âäë' },
                { month: 24, name: 'A ÂûãËÇùÁÇéÁñ´ËãóÁ¨¨ 2 Âäë' },
                { month: 36, name: 'Êó•Êú¨ËÖ¶ÁÇéÁñ´ËãóÁ¨¨ 3 Âäë' },
                { month: 60, name: 'È∫ªÁñπËÖÆËÖ∫ÁÇéÂæ∑ÂúãÈ∫ªÁñπÁñ´ËãóÁ¨¨ 2 Âäë' }
            ];
            
            // Áç≤ÂèñÂ∑≤Êé•Á®ÆÁöÑÁñ´ËãóË®òÈåÑ
            getHealthRecordsByType('vaccine', (vaccineRecords) => {
                // Áç≤ÂèñÂ≠©Â≠êÁöÑÂπ¥ÈΩ°ÔºàÊúàÔºâ
                getChildById(currentChildId, (child) => {
                    const birthDate = new Date(child.birthdate);
                    const today = new Date();
                    const ageInMonths = Math.floor((today - birthDate) / (1000 * 60 * 60 * 24 * 30.44));
                    
                    // Ê∏≤ÊüìÁñ´ËãóÊé•Á®ÆÊôÇÁ®ãË°®
                    vaccineScheduleElement.innerHTML = '';
                    
                    // ‰æùÂπ¥ÈΩ°ÂàÜÁµÑÈ°ØÁ§∫
                    const ageGroups = [
                        { label: 'Âá∫Áîü', months: [0] },
                        { label: '1 ÂÄãÊúà', months: [1] },
                        { label: '2 ÂÄãÊúà', months: [2] },
                        { label: '4 ÂÄãÊúà', months: [4] },
                        { label: '6 ÂÄãÊúà', months: [6] },
                        { label: '12-15 ÂÄãÊúà', months: [12, 15] },
                        { label: '18-24 ÂÄãÊúà', months: [18, 24] },
                        { label: '3-5 Ê≠≤', months: [36, 60] }
                    ];
                    
                    ageGroups.forEach(group => {
                        const groupVaccines = taiwanVaccineSchedule.filter(v => group.months.includes(v.month));
                        
                        if (groupVaccines.length > 0) {
                            const groupElement = document.createElement('div');
                            groupElement.style.marginBottom = '16px';
                            
                            const groupTitle = document.createElement('div');
                            groupTitle.textContent = group.label;
                            groupTitle.style.fontWeight = '600';
                            groupTitle.style.marginBottom = '8px';
                            
                            groupElement.appendChild(groupTitle);
                            
                            groupVaccines.forEach(vaccine => {
                                // Ê™¢Êü•Ê≠§Áñ´ËãóÊòØÂê¶Â∑≤Êé•Á®Æ
                                const isVaccinated = vaccineRecords.some(record => record.name === vaccine.name);
                                
                                // Ê™¢Êü•Ê≠§Áñ´ËãóÊòØÂê¶ÁÇ∫Áï∂ÂâçÂπ¥ÈΩ°ÊáâÊé•Á®ÆÁöÑÁñ´Ëãó
                                const isDue = ageInMonths >= vaccine.month;
                                
                                const vaccineItem = document.createElement('div');
                                vaccineItem.className = 'milestone-item';
                                
                                if (isVaccinated) {
                                    vaccineItem.classList.add('completed');
                                }
                                
                                vaccineItem.innerHTML = `
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>${vaccine.name}</div>
                                        <div>
                                            ${isVaccinated ? 
                                              '<span class="checkmark">‚úì Â∑≤Êé•Á®Æ</span>' : 
                                              isDue ? '<span style="color: var(--secondary);">ÊáâÊé•Á®Æ</span>' : ''}
                                        </div>
                                    </div>
                                `;
                                
                                // ÈªûÊìäÊú™Êé•Á®ÆÁöÑÁñ´ËãóÂèØÊñ∞Â¢ûÊé•Á®ÆË®òÈåÑ
                                if (!isVaccinated) {
                                    vaccineItem.style.cursor = 'pointer';
                                    vaccineItem.addEventListener('click', () => {
                                        showAddVaccineModal(vaccine.name);
                                    });
                                }
                                
                                groupElement.appendChild(vaccineItem);
                            });
                            
                            vaccineScheduleElement.appendChild(groupElement);
                        }
                    });
                });
            });
        }

        // ËºâÂÖ•Áî®Ëó•Ë®òÈåÑ
        function loadMedicationRecords() {
            const medicationRecordsElement = document.getElementById('medication-records');
            
            getHealthRecordsByType('medication', (records) => {
                if (records.length === 0) {
                    medicationRecordsElement.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-text">Â∞öÁÑ°Áî®Ëó•Á¥ÄÈåÑ</div>
                        </div>
                    `;
                } else {
                    medicationRecordsElement.innerHTML = '';
                    
                    records.forEach(record => {
                        const recordItem = document.createElement('div');
                        recordItem.className = 'record-item';
                        
                        recordItem.innerHTML = `
                            <div class="record-main">
                                <div class="record-time">${formatDateTime(new Date(record.timestamp))}</div>
                                <div class="record-details">
                                    <span class="record-tag">${record.name}</span>
                                    ${record.dose ? `<span class="record-tag">${record.dose}</span>` : ''}
                                </div>
                                ${record.note ? `<div style="font-size: 0.9rem; margin-top: 4px;">${record.note}</div>` : ''}
                            </div>
                            <button class="btn-icon" data-id="${record.id}">√ó</button>
                        `;
                        
                        // Á∂ÅÂÆöÂà™Èô§ÊåâÈàï
                        recordItem.querySelector('.btn-icon').addEventListener('click', (e) => {
                            e.stopPropagation();
                            deleteRecord('health', record.id, () => {
                                loadMedicationRecords();
                            });
                        });
                        
                        medicationRecordsElement.appendChild(recordItem);
                    });
                }
            });
        }

        // È°ØÁ§∫Êñ∞Â¢ûË∫´È´òÈ´îÈáçË®òÈåÑÂΩàÁ™ó
        function showAddGrowthModal() {
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            
            modalTitle.textContent = 'Êñ∞Â¢ûË∫´È´òÈ´îÈáç';
            modalBody.innerHTML = `
                <form id="add-growth-form">
                    <div class="form-group">
                        <label class="form-label">Á¥ÄÈåÑÈ°ûÂûã</label>
                        <div class="toggle-group" id="growth-type">
                            <div class="toggle-option active" data-value="weight">È´îÈáç</div>
                            <div class="toggle-option" data-value="height">Ë∫´È´ò</div>
                        </div>
                    </div>
                    
                    <div class="form-group" id="weight-input-group">
                        <label class="form-label">È´îÈáç (kg)</label>
                        <input type="number" class="form-control" id="weight-value" step="0.1" min="0" max="50" required>
                    </div>
                    
                    <div class="form-group" id="height-input-group" style="display: none;">
                        <label class="form-label">Ë∫´È´ò (cm)</label>
                        <input type="number" class="form-control" id="height-value" step="0.1" min="0" max="200" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ÊôÇÈñì</label>
                        <input type="datetime-local" class="form-control" id="growth-time" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ÂÇôË®ª</label>
                        <input type="text" class="form-control" id="growth-note" placeholder="ÈÅ∏Â°´">
                    </div>
                    
                    <button type="submit" class="btn" style="width: 100%;">ÂÑ≤Â≠ò</button>
                </form>
            `;
            
            // Ë®≠ÂÆöÈ†êË®≠ÊôÇÈñìÁÇ∫ÁèæÂú®
            document.getElementById('growth-time').value = formatDateTimeLocal(new Date());
            
            // Á¥ÄÈåÑÈ°ûÂûãÂàáÊèõ
            const typeOptions = modalBody.querySelectorAll('#growth-type .toggle-option');
            let selectedType = 'weight';
            
            typeOptions.forEach(option => {
                option.addEventListener('click', () => {
                    typeOptions.forEach(opt => opt.classList.remove('active'));
                    option.classList.add('active');
                    selectedType = option.dataset.value;
                    
                    // È°ØÁ§∫Â∞çÊáâÁöÑËº∏ÂÖ•Ê¨Ñ‰Ωç
                    document.getElementById('weight-input-group').style.display = selectedType === 'weight' ? 'block' : 'none';
                    document.getElementById('height-input-group').style.display = selectedType === 'height' ? 'block' : 'none';
                });
            });
            
            // Ë°®ÂñÆÊèê‰∫§
            const form = document.getElementById('add-growth-form');
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const time = document.getElementById('growth-time').value;
                const note = document.getElementById('growth-note').value.trim();
                
                let value;
                if (selectedType === 'weight') {
                    value = document.getElementById('weight-value').value;
                } else {
                    value = document.getElementById('height-value').value;
                }
                
                if (!time || !value) {
                    showToast('Ë´ãÂ°´ÂØ´ÊâÄÊúâÂøÖÂ°´Ê¨Ñ‰Ωç');
                    return;
                }
                
                // Êñ∞Â¢ûÊàêÈï∑Ë®òÈåÑ
                const growthData = {
                    childId: currentChildId,
                    timestamp: new Date(time).toISOString(),
                    type: selectedType,
                    value: parseFloat(value),
                    note: note
                };
                
                addRecord('health', growthData, () => {
                    showToast(`ÊàêÂäüÊñ∞Â¢û${selectedType === 'weight' ? 'È´îÈáç' : 'Ë∫´È´ò'}Á¥ÄÈåÑ`);
                    closeModal();
                    
                    // ÈáçÊñ∞ËºâÂÖ•ÊàêÈï∑Ë®òÈåÑ
                    loadGrowthRecords();
                });
            });
            
            openModal();
        }

        // È°ØÁ§∫Êñ∞Â¢ûÁñ´ËãóË®òÈåÑÂΩàÁ™ó
        function showAddVaccineModal(preSelectedVaccine = null) {
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            
            modalTitle.textContent = 'Êñ∞Â¢ûÁñ´ËãóÊé•Á®Æ';
            modalBody.innerHTML = `
                <form id="add-vaccine-form">
                    <div class="form-group">
                        <label class="form-label">Áñ´ËãóÂêçÁ®±</label>
                        <input type="text" class="form-control" id="vaccine-name" placeholder="‰æãÔºö‰∫îÂêà‰∏ÄÁñ´ËãóÁ¨¨ 1 Âäë" list="vaccine-list" required>
                        <datalist id="vaccine-list">
                            <option value="B ÂûãËÇùÁÇéÁñ´ËãóÁ¨¨ 1 Âäë">
                            <option value="B ÂûãËÇùÁÇéÁñ´ËãóÁ¨¨ 2 Âäë">
                            <option value="B ÂûãËÇùÁÇéÁñ´ËãóÁ¨¨ 3 Âäë">
                            <option value="Âç°‰ªãËãó">
                            <option value="‰∫îÂêà‰∏ÄÁñ´ËãóÁ¨¨ 1 Âäë">
                            <option value="‰∫îÂêà‰∏ÄÁñ´ËãóÁ¨¨ 2 Âäë">
                            <option value="‰∫îÂêà‰∏ÄÁñ´ËãóÁ¨¨ 3 Âäë">
                            <option value="‰∫îÂêà‰∏ÄÁñ´ËãóËøΩÂä†Âäë">
                            <option value="13 ÂÉπÁµêÂêàÂûãËÇ∫ÁÇéÈèàÁêÉËèåÁñ´ËãóÁ¨¨ 1 Âäë">
                            <option value="13 ÂÉπÁµêÂêàÂûãËÇ∫ÁÇéÈèàÁêÉËèåÁñ´ËãóÁ¨¨ 2 Âäë">
                            <option value="13 ÂÉπÁµêÂêàÂûãËÇ∫ÁÇéÈèàÁêÉËèåÁñ´ËãóÁ¨¨ 3 Âäë">
                            <option value="13 ÂÉπÁµêÂêàÂûãËÇ∫ÁÇéÈèàÁêÉËèåÁñ´ËãóËøΩÂä†Âäë">
                            <option value="È∫ªÁñπËÖÆËÖ∫ÁÇéÂæ∑ÂúãÈ∫ªÁñπÁñ´ËãóÁ¨¨ 1 Âäë">
                            <option value="È∫ªÁñπËÖÆËÖ∫ÁÇéÂæ∑ÂúãÈ∫ªÁñπÁñ´ËãóÁ¨¨ 2 Âäë">
                            <option value="Ê∞¥ÁóòÁñ´Ëãó">
                            <option value="Êó•Êú¨ËÖ¶ÁÇéÁñ´ËãóÁ¨¨ 1„ÄÅ2 Âäë">
                            <option value="Êó•Êú¨ËÖ¶ÁÇéÁñ´ËãóÁ¨¨ 3 Âäë">
                            <option value="A ÂûãËÇùÁÇéÁñ´ËãóÁ¨¨ 1 Âäë">
                            <option value="A ÂûãËÇùÁÇéÁñ´ËãóÁ¨¨ 2 Âäë">
                        </datalist>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Êé•Á®ÆÊó•Êúü</label>
                        <input type="date" class="form-control" id="vaccine-date" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Êé•Á®ÆÂú∞Èªû</label>
                        <input type="text" class="form-control" id="vaccine-location" placeholder="‰æãÔºöÂè∞Â§ßÈÜ´Èô¢Â∞èÂÖíÁßë">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ÂÇôË®ª</label>
                        <input type="text" class="form-control" id="vaccine-note" placeholder="ÈÅ∏Â°´">
                    </div>
                    
                    <button type="submit" class="btn" style="width: 100%;">ÂÑ≤Â≠ò</button>
                </form>
            `;
            
            // Ë®≠ÂÆöÈ†êË®≠Êó•ÊúüÁÇ∫‰ªäÂ§©
            document.getElementById('vaccine-date').value = formatDateOnly(new Date());
            
            // Â¶ÇÊûúÊúâÈ†êÈÅ∏ÁöÑÁñ´ËãóÔºåÂ°´ÂÖ•ÂêçÁ®±
            if (preSelectedVaccine) {
                document.getElementById('vaccine-name').value = preSelectedVaccine;
            }
            
            // Ë°®ÂñÆÊèê‰∫§
            const form = document.getElementById('add-vaccine-form');
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const name = document.getElementById('vaccine-name').value.trim();
                const date = document.getElementById('vaccine-date').value;
                const location = document.getElementById('vaccine-location').value.trim();
                const note = document.getElementById('vaccine-note').value.trim();
                
                if (!name || !date) {
                    showToast('Ë´ãÂ°´ÂØ´ÊâÄÊúâÂøÖÂ°´Ê¨Ñ‰Ωç');
                    return;
                }
                
                // ÂâµÂª∫ÊôÇÈñìÔºàÁï∂Â§©ÁöÑÁï∂ÂâçÊôÇÈñìÔºâ
                const dateObj = new Date(date);
                const now = new Date();
                dateObj.setHours(now.getHours(), now.getMinutes(), now.getSeconds());
                
                // Êñ∞Â¢ûÁñ´ËãóË®òÈåÑ
                const vaccineData = {
                    childId: currentChildId,
                    timestamp: dateObj.toISOString(),
                    type: 'vaccine',
                    name: name,
                    location: location,
                    note: note
                };
                
                addRecord('health', vaccineData, () => {
                    showToast('ÊàêÂäüÊñ∞Â¢ûÁñ´ËãóÊé•Á®ÆÁ¥ÄÈåÑ');
                    closeModal();
                    
                    // ÈáçÊñ∞ËºâÂÖ•Áñ´ËãóË®òÈåÑ
                    loadVaccineRecords();
                });
            });
            
            openModal();
        }

        // È°ØÁ§∫Êñ∞Â¢ûÁî®Ëó•Ë®òÈåÑÂΩàÁ™ó
        function showAddMedicationModal() {
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            
            modalTitle.textContent = 'Êñ∞Â¢ûÁî®Ëó•Á¥ÄÈåÑ';
            modalBody.innerHTML = `
                <form id="add-medication-form">
                    <div class="form-group">
                        <label class="form-label">Ëó•Áâ©ÂêçÁ®±</label>
                        <input type="text" class="form-control" id="medication-name" placeholder="‰æãÔºöÈÄÄÁáíËó•" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ÂäëÈáè</label>
                        <input type="text" class="form-control" id="medication-dose" placeholder="‰æãÔºö5ml">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ÊúçÁî®ÊôÇÈñì</label>
                        <input type="datetime-local" class="form-control" id="medication-time" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ÂÇôË®ª</label>
                        <textarea class="form-control" id="medication-note" placeholder="‰æãÔºöÁôºÁáí 38.5¬∞C" rows="2"></textarea>
                    </div>
                    
                    <button type="submit" class="btn" style="width: 100%;">ÂÑ≤Â≠ò</button>
                </form>
            `;
            
            // Ë®≠ÂÆöÈ†êË®≠ÊôÇÈñìÁÇ∫ÁèæÂú®
            document.getElementById('medication-time').value = formatDateTimeLocal(new Date());
            
            // Ë°®ÂñÆÊèê‰∫§
            const form = document.getElementById('add-medication-form');
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const name = document.getElementById('medication-name').value.trim();
                const dose = document.getElementById('medication-dose').value.trim();
                const time = document.getElementById('medication-time').value;
                const note = document.getElementById('medication-note').value.trim();
                
                if (!name || !time) {
                    showToast('Ë´ãÂ°´ÂØ´ÊâÄÊúâÂøÖÂ°´Ê¨Ñ‰Ωç');
                    return;
                }
                
                // Êñ∞Â¢ûÁî®Ëó•Ë®òÈåÑ
                const medicationData = {
                    childId: currentChildId,
                    timestamp: new Date(time).toISOString(),
                    type: 'medication',
                    name: name,
                    dose: dose,
                    note: note
                };
                
                addRecord('health', medicationData, () => {
                    showToast('ÊàêÂäüÊñ∞Â¢ûÁî®Ëó•Á¥ÄÈåÑ');
                    closeModal();
                    
                    // ÈáçÊñ∞ËºâÂÖ•Áî®Ëó•Ë®òÈåÑ
                    loadMedicationRecords();
                });
            });
            
            openModal();
        }

        // ËºâÂÖ•Ë®≠ÂÆöÈ†ÅÈù¢
        function loadSettingsPage() {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">ÂØ∂ÂØ∂Ë≥áÊñô</div>
                    </div>
                    <div class="card-content" id="child-settings">
                        <div class="loader"></div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Â§ñËßÄË®≠ÂÆö</div>
                    </div>
                    <div class="card-content">
                        <div class="settings-item">
                            <div>Ê∑±Ëâ≤Ê®°Âºè</div>
                            <label class="form-control" style="width: auto; display: flex; align-items: center;">
                                <input type="checkbox" id="dark-mode-toggle" style="margin-right: 8px;">
                                <div id="theme-status">ÈóúÈñâ</div>
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Ë≥áÊñôÁÆ°ÁêÜ</div>
                    </div>
                    <div class="card-content">
                        <div class="settings-item">
                            <div>ÂÇô‰ªΩË≥áÊñô</div>
                            <button class="btn-sm" id="backup-btn">‰∏ãËºâÂÇô‰ªΩ</button>
                        </div>
                        
                        <div class="settings-item">
                            <div>ÈÇÑÂéüË≥áÊñô</div>
                            <button class="btn-sm" id="restore-btn">‰∏äÂÇ≥ÂÇô‰ªΩ</button>
                        </div>
                        
                        <div class="settings-item">
                            <div>Ê∏ÖÈô§Ë≥áÊñô</div>
                            <button class="btn-sm" id="clear-data-btn" style="background-color: #ff6b6b;">Ê∏ÖÈô§</button>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">ÈóúÊñº</div>
                    </div>
                    <div class="card-content">
                        <div style="text-align: center; padding: 8px 0;">
                            <div style="font-size: 1.2rem; margin-bottom: 8px;">ÂØ∂ÂØ∂ÁÖßË≠∑Á≠ÜË®ò</div>
                            <div style="color: var(--text-light); font-size: 0.9rem;">ÁâàÊú¨ 1.0.0</div>
                            <div style="color: var(--text-light); font-size: 0.9rem; margin-top: 8px;">¬© 2025 Âè∞ÁÅ£Êú¨Âú∞ÂåñË®≠Ë®à</div>
                        </div>
                    </div>
                </div>
            `;
            
            // ËºâÂÖ•ÂØ∂ÂØ∂Ë®≠ÂÆö
            loadChildSettings();
            
            // Ê∑±Ëâ≤Ê®°ÂºèÂàáÊèõ
            const darkModeToggle = document.getElementById('dark-mode-toggle');
            const themeStatus = document.getElementById('theme-status');
            
            // Ê™¢Êü•Áï∂Ââç‰∏ªÈ°å
            const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';
            darkModeToggle.checked = isDarkMode;
            themeStatus.textContent = isDarkMode ? 'ÈñãÂïü' : 'ÈóúÈñâ';
            
            darkModeToggle.addEventListener('change', () => {
                const newTheme = darkModeToggle.checked ? 'dark' : 'light';
                document.documentElement.setAttribute('data-theme', newTheme);
                themeStatus.textContent = darkModeToggle.checked ? 'ÈñãÂïü' : 'ÈóúÈñâ';
                
                // ÂÑ≤Â≠ò‰∏ªÈ°åË®≠ÂÆö
                localStorage.setItem('theme', newTheme);
            });
            
            // Á∂ÅÂÆöÂÇô‰ªΩÊåâÈàï
            document.getElementById('backup-btn').addEventListener('click', () => {
                backupData();
            });
            
            // Á∂ÅÂÆöÈÇÑÂéüÊåâÈàï
            document.getElementById('restore-btn').addEventListener('click', () => {
                // ÂâµÂª∫‰∏ÄÂÄãÈö±ËóèÁöÑÊñá‰ª∂Ëº∏ÂÖ•ÂÖÉÁ¥†
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = '.json';
                fileInput.style.display = 'none';
                document.body.appendChild(fileInput);
                
                fileInput.addEventListener('change', (e) => {
                    if (e.target.files && e.target.files[0]) {
                        const file = e.target.files[0];
                        const reader = new FileReader();
                        
                        reader.onload = (e) => {
                            try {
                                const backup = JSON.parse(e.target.result);
                                restoreData(backup);
                            } catch (error) {
                                showToast('ÂÇô‰ªΩÊ™îÊ°àÊ†ºÂºèÈåØË™§');
                                console.error('ÈÇÑÂéüË≥áÊñôÈåØË™§:', error);
                            }
                        };
                        
                        reader.readAsText(file);
                    }
                    
                    document.body.removeChild(fileInput);
                });
                
                fileInput.click();
            });
            
            // Á∂ÅÂÆöÊ∏ÖÈô§Ë≥áÊñôÊåâÈàï
            document.getElementById('clear-data-btn').addEventListener('click', () => {
                if (confirm('Á¢∫ÂÆöË¶ÅÊ∏ÖÈô§ÊâÄÊúâË≥áÊñôÂóéÔºüÊ≠§Êìç‰ΩúÁÑ°Ê≥ïÂæ©Âéü„ÄÇ')) {
                    clearAllData();
                }
            });
        }

        // ËºâÂÖ•ÂØ∂ÂØ∂Ë®≠ÂÆö
        function loadChildSettings() {
            const childSettingsElement = document.getElementById('child-settings');
            
            const transaction = db.transaction(['children'], 'readonly');
            const childrenStore = transaction.objectStore('children');
            const request = childrenStore.getAll();
            
            request.onsuccess = () => {
                const children = request.result;
                
                if (children.length === 0) {
                    childSettingsElement.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-text">Â∞öÁÑ°ÂØ∂ÂØ∂Ë≥áÊñô</div>
                        </div>
                    `;
                } else {
                    childSettingsElement.innerHTML = '';
                    
                    children.forEach(child => {
                        // Ë®àÁÆóÂπ¥ÈΩ°
                        const birthDate = new Date(child.birthdate);
                        const today = new Date();
                        const ageInMonths = Math.floor((today - birthDate) / (1000 * 60 * 60 * 24 * 30.44));
                        const ageYears = Math.floor(ageInMonths / 12);
                        const ageMonths = ageInMonths % 12;
                        const ageString = ageYears > 0 
                            ? `${ageYears}Ê≠≤${ageMonths}ÂÄãÊúà` 
                            : `${ageMonths}ÂÄãÊúà`;
                        
                        const childItem = document.createElement('div');
                        childItem.className = 'settings-item';
                        
                        let avatarHTML = '';
                        if (child.avatar) {
                            avatarHTML = `<img src="${child.avatar}" alt="${child.name}" style="width: 40px; height: 40px; border-radius: 50%; margin-right: 10px;">`;
                        }
                        
                        childItem.innerHTML = `
                            <div style="display: flex; align-items: center;">
                                ${avatarHTML}
                                <div>
                                    <div>${child.name}</div>
                                    <div style="font-size: 0.8rem; color: var(--text-light);">${ageString} (${formatDate(birthDate)})</div>
                                </div>
                            </div>
                            <button class="btn-sm" data-id="${child.id}">Á∑®ËºØ</button>
                        `;
                        
                        // Á∂ÅÂÆöÁ∑®ËºØÊåâÈàï
                        childItem.querySelector('.btn-sm').addEventListener('click', () => {
                            showEditChildModal(child);
                        });
                        
                        childSettingsElement.appendChild(childItem);
                    });
                    
                    // Â¶ÇÊûúÂ≠©Â≠êÊï∏ÈáèÂ∞ëÊñº 4 ÂÄãÔºåÈ°ØÁ§∫Êñ∞Â¢ûÊåâÈàï
                    if (children.length < 4) {
                        const addButton = document.createElement('button');
                        addButton.className = 'btn';
                        addButton.style.width = '100%';
                        addButton.style.marginTop = '16px';
                        addButton.textContent = 'Êñ∞Â¢ûÂØ∂ÂØ∂';
                        
                        addButton.addEventListener('click', () => {
                            showAddChildModal();
                        });
                        
                        childSettingsElement.appendChild(addButton);
                    }
                }
            };
        }

        // È°ØÁ§∫Á∑®ËºØÂ≠©Â≠êË≥áÊñôÂΩàÁ™ó
        function showEditChildModal(child) {
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            
            modalTitle.textContent = 'Á∑®ËºØÂØ∂ÂØ∂Ë≥áÊñô';
            modalBody.innerHTML = `
                <form id="edit-child-form">
                    <div class="form-group">
                        <label class="form-label">ÂØ∂ÂØ∂Êö±Á®±</label>
                        <input type="text" class="form-control" id="child-name" value="${child.name}" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ÊÄßÂà•</label>
                        <div class="toggle-group" id="child-gender">
                            <div class="toggle-option ${child.gender === 'Áî∑' ? 'active' : ''}" data-value="Áî∑">Áî∑ÂØ∂ÂØ∂</div>
                            <div class="toggle-option ${child.gender === 'Â•≥' ? 'active' : ''}" data-value="Â•≥">Â•≥ÂØ∂ÂØ∂</div>
                            <div class="toggle-option ${child.gender === 'ÂÖ∂‰ªñ' ? 'active' : ''}" data-value="ÂÖ∂‰ªñ">ÂÖ∂‰ªñ</div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Âá∫ÁîüÊó•Êúü</label>
                        <input type="date" class="form-control" id="child-birthdate" value="${child.birthdate}" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Êõ¥Êñ∞È†≠ÂÉè</label>
                        <input type="file" id="child-avatar" class="file-input" accept="image/*">
                        <label for="child-avatar" class="file-label">ÈÅ∏ÊìáÁÖßÁâá</label>
                        <div id="avatar-preview" class="image-preview" style="display: ${child.avatar ? 'block' : 'none'};">
                            <img id="avatar-image" src="${child.avatar || ''}" alt="È†êË¶Ω">
                        </div>
                    </div>
                    
                    <button type="submit" class="btn" style="width: 100%;">ÂÑ≤Â≠ò</button>
                    
                    <button type="button" class="btn" style="width: 100%; margin-top: 16px; background-color: #ff6b6b;" id="delete-child-btn">Âà™Èô§ÂØ∂ÂØ∂Ë≥áÊñô</button>
                </form>
            `;
            
            // È†≠ÂÉèÈ†êË¶Ω
            const avatarInput = document.getElementById('child-avatar');
            const avatarPreview = document.getElementById('avatar-preview');
            const avatarImage = document.getElementById('avatar-image');
            
            avatarInput.addEventListener('change', (e) => {
                if (e.target.files && e.target.files[0]) {
                    const reader = new FileReader();
                    
                    reader.onload = (e) => {
                        avatarImage.src = e.target.result;
                        avatarPreview.style.display = 'block';
                    };
                    
                    reader.readAsDataURL(e.target.files[0]);
                }
            });
            
            // ÊÄßÂà•ÈÅ∏ÊìáÂàáÊèõ
            const genderOptions = modalBody.querySelectorAll('#child-gender .toggle-option');
            let selectedGender = child.gender;
            
            genderOptions.forEach(option => {
                option.addEventListener('click', () => {
                    genderOptions.forEach(opt => opt.classList.remove('active'));
                    option.classList.add('active');
                    selectedGender = option.dataset.value;
                });
            });
            
            // Ë°®ÂñÆÊèê‰∫§
            const form = document.getElementById('edit-child-form');
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const name = document.getElementById('child-name').value.trim();
                const birthdate = document.getElementById('child-birthdate').value;
                
                if (!name || !birthdate || !selectedGender) {
                    showToast('Ë´ãÂ°´ÂØ´ÊâÄÊúâÊ¨Ñ‰Ωç');
                    return;
                }
                
                // Êõ¥Êñ∞Â≠©Â≠êË≥áÊñô
                const updatedChild = {
                    ...child,
                    name: name,
                    gender: selectedGender,
                    birthdate: birthdate,
                    avatar: avatarImage.src
                };
                
                updateChild(updatedChild);
            });
            
            // Á∂ÅÂÆöÂà™Èô§ÊåâÈàï
            document.getElementById('delete-child-btn').addEventListener('click', () => {
                if (confirm(`Á¢∫ÂÆöË¶ÅÂà™Èô§ ${child.name} ÁöÑÊâÄÊúâË≥áÊñôÂóéÔºüÊ≠§Êìç‰ΩúÁÑ°Ê≥ïÂæ©Âéü„ÄÇ`)) {
                    deleteChild(child.id);
                }
            });
            
            openModal();
        }

        // Êõ¥Êñ∞Â≠©Â≠êË≥áÊñô
        function updateChild(child) {
            const transaction = db.transaction(['children'], 'readwrite');
            const childrenStore = transaction.objectStore('children');
            
            const request = childrenStore.put(child);
            
            request.onsuccess = () => {
                showToast('ÊàêÂäüÊõ¥Êñ∞ÂØ∂ÂØ∂Ë≥áÊñô');
                closeModal();
                
                // Âà∑Êñ∞Â≠©Â≠êÈÅ∏ÊìáÂô®
                loadChildrenSelector();
                
                // Âà∑Êñ∞Ë®≠ÂÆöÈ†ÅÈù¢
                if (currentPage === 'settings') {
                    loadChildSettings();
                }
            };
            
            request.onerror = () => {
                showToast('Êõ¥Êñ∞ÂØ∂ÂØ∂Ë≥áÊñôÂ§±Êïó');
            };
        }

        // Âà™Èô§Â≠©Â≠êË≥áÊñô
        function deleteChild(childId) {
            // Âà™Èô§Â≠©Â≠êË≥áÊñô
            const transaction = db.transaction(['children'], 'readwrite');
            const childrenStore = transaction.objectStore('children');
            
            childrenStore.delete(childId);
            
            transaction.oncomplete = () => {
                // Âà™Èô§ËàáË©≤Â≠©Â≠êÁõ∏ÈóúÁöÑÊâÄÊúâË®òÈåÑ
                deleteChildRecords(childId, () => {
                    showToast('ÊàêÂäüÂà™Èô§ÂØ∂ÂØ∂Ë≥áÊñô');
                    closeModal();
                    
                    // Â¶ÇÊûúÁï∂ÂâçÈÅ∏‰∏≠ÁöÑÊòØË¢´Âà™Èô§ÁöÑÂ≠©Â≠êÔºåÈáçÁΩÆÁï∂ÂâçÈÅ∏‰∏≠ÁöÑÂ≠©Â≠ê
                    if (currentChildId === childId) {
                        currentChildId = null;
                    }
                    
                    // Âà∑Êñ∞Â≠©Â≠êÈÅ∏ÊìáÂô®
                    loadChildrenSelector();
                });
            };
        }

        // Âà™Èô§ËàáÂ≠©Â≠êÁõ∏ÈóúÁöÑÊâÄÊúâË®òÈåÑ
        function deleteChildRecords(childId, callback) {
            const storeNames = ['feeding', 'sleep', 'diaper', 'activities', 'milestones', 'health', 'interactions'];
            let completed = 0;
            
            storeNames.forEach(storeName => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const index = store.index('childId');
                const request = index.openCursor(IDBKeyRange.only(childId));
                
                request.onsuccess = (event) => {
                    const cursor = event.target.result;
                    
                    if (cursor) {
                        store.delete(cursor.primaryKey);
                        cursor.continue();
                    }
                };
                
                transaction.oncomplete = () => {
                    completed++;
                    
                    if (completed === storeNames.length) {
                        callback();
                    }
                };
            });
        }

        // ÂÇô‰ªΩË≥áÊñô
        function backupData() {
            const backup = {
                children: [],
                feeding: [],
                sleep: [],
                diaper: [],
                milestones: [],
                activities: [],
                health: [],
                interactions: []
            };
            
            // ‰øùÂ≠òÊâÄÊúâÊï∏ÊìöË°®
            let storesCompleted = 0;
            
            // Áç≤ÂèñÂ≠©Â≠êË≥áÊñô
            const transaction1 = db.transaction(['children'], 'readonly');
            const childrenStore = transaction1.objectStore('children');
            const request1 = childrenStore.getAll();
            
            request1.onsuccess = () => {
                backup.children = request1.result;
                storesCompleted++;
                checkCompletion();
            };
            
            // Áç≤ÂèñÈ§µÈ£üË®òÈåÑ
            const transaction2 = db.transaction(['feeding'], 'readonly');
            const feedingStore = transaction2.objectStore('feeding');
            const request2 = feedingStore.getAll();
            
            request2.onsuccess = () => {
                backup.feeding = request2.result;
                storesCompleted++;
                checkCompletion();
            };
            
            // Áç≤ÂèñÁù°Áú†Ë®òÈåÑ
            const transaction3 = db.transaction(['sleep'], 'readonly');
            const sleepStore = transaction3.objectStore('sleep');
            const request3 = sleepStore.getAll();
            
            request3.onsuccess = () => {
                backup.sleep = request3.result;
                storesCompleted++;
                checkCompletion();
            };
            
            // Áç≤ÂèñÂ∞øÂ∏ÉË®òÈåÑ
            const transaction4 = db.transaction(['diaper'], 'readonly');
            const diaperStore = transaction4.objectStore('diaper');
            const request4 = diaperStore.getAll();
            
            request4.onsuccess = () => {
                backup.diaper = request4.result;
                storesCompleted++;
                checkCompletion();
            };
            
            // Áç≤ÂèñÈáåÁ®ãÁ¢ëË®òÈåÑ
            const transaction5 = db.transaction(['milestones'], 'readonly');
            const milestonesStore = transaction5.objectStore('milestones');
            const request5 = milestonesStore.getAll();
            
            request5.onsuccess = () => {
                backup.milestones = request5.result;
                storesCompleted++;
                checkCompletion();
            };
            
            // Áç≤ÂèñÊ¥ªÂãïË®òÈåÑ
            const transaction6 = db.transaction(['activities'], 'readonly');
            const activitiesStore = transaction6.objectStore('activities');
            const request6 = activitiesStore.getAll();
            
            request6.onsuccess = () => {
                backup.activities = request6.result;
                storesCompleted++;
                checkCompletion();
            };
            
            // Áç≤ÂèñÂÅ•Â∫∑Ë®òÈåÑ
            const transaction7 = db.transaction(['health'], 'readonly');
            const healthStore = transaction7.objectStore('health');
            const request7 = healthStore.getAll();
            
            request7.onsuccess = () => {
                backup.health = request7.result;
                storesCompleted++;
                checkCompletion();
            };
            
            // Áç≤ÂèñË¶™Â≠ê‰∫íÂãïË®òÈåÑ
            const transaction8 = db.transaction(['interactions'], 'readonly');
            const interactionsStore = transaction8.objectStore('interactions');
            const request8 = interactionsStore.getAll();
            
            request8.onsuccess = () => {
                backup.interactions = request8.result;
                storesCompleted++;
                checkCompletion();
            };
            
            // Ê™¢Êü•ÊòØÂê¶ÂÆåÊàêÊâÄÊúâÊï∏ÊìöË°®ÁöÑÂÇô‰ªΩ
            function checkCompletion() {
                if (storesCompleted === 8) {
                    // ÊâÄÊúâÊï∏ÊìöË°®ÈÉΩÂ∑≤ÂÇô‰ªΩ
                    const backupJson = JSON.stringify(backup);
                    const blob = new Blob([backupJson], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    
                    // ÂâµÂª∫‰∏ãËºâÈÄ£Áµê
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `BabyCare_Backup_${formatDateForFilename(new Date())}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    
                    showToast('ÂÇô‰ªΩÊ™îÊ°àÂ∑≤‰∏ãËºâ');
                }
            }
        }

        // ÈÇÑÂéüË≥áÊñô
        function restoreData(backup) {
            // Á¢∫Ë™çÂÇô‰ªΩË≥áÊñôÂåÖÂê´ÊâÄÊúâÂøÖË¶ÅÁöÑË°®Ê†º
            const requiredTables = ['children', 'feeding', 'sleep', 'diaper', 'milestones', 'activities', 'health', 'interactions'];
            
            for (const table of requiredTables) {
                if (!backup[table] || !Array.isArray(backup[table])) {
                    showToast('ÂÇô‰ªΩÊ™îÊ°àÊ†ºÂºèÈåØË™§');
                    return;
                }
            }
            
            // Á¢∫Ë™çÁî®Êà∂ÁúüÁöÑË¶ÅÈÇÑÂéü
            if (!confirm('ÈÇÑÂéüÂ∞áÊúÉË¶ÜËìãÊâÄÊúâÁèæÊúâË≥áÊñôÔºåÁ¢∫ÂÆöË¶ÅÁπºÁ∫åÂóéÔºü')) {
                return;
            }
            
            // ÈóúÈñâÁï∂ÂâçË≥áÊñôÂ∫´ÈÄ£Êé•
            db.close();
            
            // Âà™Èô§Ë≥áÊñôÂ∫´
            const deleteRequest = indexedDB.deleteDatabase(DB_NAME);
            
            deleteRequest.onsuccess = () => {
                // ÈáçÊñ∞ÊâìÈñãË≥áÊñôÂ∫´
                const openRequest = indexedDB.open(DB_NAME, DB_VERSION);
                
                openRequest.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    
                    // ÂâµÂª∫ÊâÄÊúâË°®Ê†º
                    if (!db.objectStoreNames.contains('children')) {
                        const childrenStore = db.createObjectStore('children', { keyPath: 'id' });
                        childrenStore.createIndex('name', 'name', { unique: false });
                    }
                    
                    if (!db.objectStoreNames.contains('feeding')) {
                        const feedingStore = db.createObjectStore('feeding', { keyPath: 'id', autoIncrement: true });
                        feedingStore.createIndex('childId', 'childId', { unique: false });
                        feedingStore.createIndex('timestamp', 'timestamp', { unique: false });
                    }
                    
                    if (!db.objectStoreNames.contains('sleep')) {
                        const sleepStore = db.createObjectStore('sleep', { keyPath: 'id', autoIncrement: true });
                        sleepStore.createIndex('childId', 'childId', { unique: false });
                        sleepStore.createIndex('timestamp', 'timestamp', { unique: false });
                    }
                    
                    if (!db.objectStoreNames.contains('diaper')) {
                        const diaperStore = db.createObjectStore('diaper', { keyPath: 'id', autoIncrement: true });
                        diaperStore.createIndex('childId', 'childId', { unique: false });
                        diaperStore.createIndex('timestamp', 'timestamp', { unique: false });
                    }
                    
                    if (!db.objectStoreNames.contains('milestones')) {
                        const milestonesStore = db.createObjectStore('milestones', { keyPath: 'id', autoIncrement: true });
                        milestonesStore.createIndex('childId', 'childId', { unique: false });
                        milestonesStore.createIndex('category', 'category', { unique: false });
                    }
                    
                    if (!db.objectStoreNames.contains('activities')) {
                        const activitiesStore = db.createObjectStore('activities', { keyPath: 'id', autoIncrement: true });
                        activitiesStore.createIndex('childId', 'childId', { unique: false });
                        activitiesStore.createIndex('timestamp', 'timestamp', { unique: false });
                        activitiesStore.createIndex('type', 'type', { unique: false });
                    }
                    
                    if (!db.objectStoreNames.contains('health')) {
                        const healthStore = db.createObjectStore('health', { keyPath: 'id', autoIncrement: true });
                        healthStore.createIndex('childId', 'childId', { unique: false });
                        healthStore.createIndex('timestamp', 'timestamp', { unique: false });
                        healthStore.createIndex('type', 'type', { unique: false });
                    }
                    
                    if (!db.objectStoreNames.contains('interactions')) {
                        const interactionsStore = db.createObjectStore('interactions', { keyPath: 'id', autoIncrement: true });
                        interactionsStore.createIndex('childId', 'childId', { unique: false });
                        interactionsStore.createIndex('timestamp', 'timestamp', { unique: false });
                    }
                };
                
                openRequest.onsuccess = (event) => {
                    const db = event.target.result;
                    
                    // ÊÅ¢Âæ©ÊâÄÊúâÊï∏Êìö
                    const transaction = db.transaction(requiredTables, 'readwrite');
                    
                    // ÊÅ¢Âæ©Â≠©Â≠êË≥áÊñô
                    const childrenStore = transaction.objectStore('children');
                    backup.children.forEach(child => {
                        childrenStore.add(child);
                    });
                    
                    // ÊÅ¢Âæ©È§µÈ£üË®òÈåÑ
                    const feedingStore = transaction.objectStore('feeding');
                    backup.feeding.forEach(record => {
                        feedingStore.add(record);
                    });
                    
                    // ÊÅ¢Âæ©Áù°Áú†Ë®òÈåÑ
                    const sleepStore = transaction.objectStore('sleep');
                    backup.sleep.forEach(record => {
                        sleepStore.add(record);
                    });
                    
                    // ÊÅ¢Âæ©Â∞øÂ∏ÉË®òÈåÑ
                    const diaperStore = transaction.objectStore('diaper');
                    backup.diaper.forEach(record => {
                        diaperStore.add(record);
                    });
                    
                    // ÊÅ¢Âæ©ÈáåÁ®ãÁ¢ëË®òÈåÑ
                    const milestonesStore = transaction.objectStore('milestones');
                    backup.milestones.forEach(record => {
                        milestonesStore.add(record);
                    });
                    
                    // ÊÅ¢Âæ©Ê¥ªÂãïË®òÈåÑ
                    const activitiesStore = transaction.objectStore('activities');
                    backup.activities.forEach(record => {
                        activitiesStore.add(record);
                    });
                    
                    // ÊÅ¢Âæ©ÂÅ•Â∫∑Ë®òÈåÑ
                    const healthStore = transaction.objectStore('health');
                    backup.health.forEach(record => {
                        healthStore.add(record);
                    });
                    
                    // ÊÅ¢Âæ©Ë¶™Â≠ê‰∫íÂãïË®òÈåÑ
                    const interactionsStore = transaction.objectStore('interactions');
                    backup.interactions.forEach(record => {
                        interactionsStore.add(record);
                    });
                    
                    transaction.oncomplete = () => {
                        showToast('ÊàêÂäüÈÇÑÂéüË≥áÊñô');
                        
                        // ÈáçÊñ∞ËºâÂÖ•È†ÅÈù¢
                        setTimeout(() => {
                            window.location.reload();
                        }, 2000);
                    };
                    
                    transaction.onerror = (event) => {
                        showToast('ÈÇÑÂéüË≥áÊñôÂ§±Êïó');
                        console.error('ÈÇÑÂéüË≥áÊñôÈåØË™§:', event.target.error);
                    };
                };
            };
        }

        // Ê∏ÖÈô§ÊâÄÊúâË≥áÊñô
        function clearAllData() {
            // ÈóúÈñâÁï∂ÂâçË≥áÊñôÂ∫´ÈÄ£Êé•
            db.close();
            
            // Âà™Èô§Ë≥áÊñôÂ∫´
            const deleteRequest = indexedDB.deleteDatabase(DB_NAME);
            
            deleteRequest.onsuccess = () => {
                showToast('Â∑≤Ê∏ÖÈô§ÊâÄÊúâË≥áÊñô');
                
                // ÈáçÊñ∞ËºâÂÖ•È†ÅÈù¢
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            };
            
            deleteRequest.onerror = () => {
                showToast('Ê∏ÖÈô§Ë≥áÊñôÂ§±Êïó');
            };
        }

        // ÈÄöÁî®Ë®òÈåÑÊìç‰ΩúÂäüËÉΩ

        // Êñ∞Â¢ûË®òÈåÑ
        function addRecord(storeName, data, callback) {
            const transaction = db.transaction([storeName], 'readwrite');
            const store = transaction.objectStore(storeName);
            
            const request = store.add(data);
            
            request.onsuccess = () => {
                if (callback) callback();
            };
            
            request.onerror = () => {
                showToast(`Êñ∞Â¢û${storeName}Ë®òÈåÑÂ§±Êïó`);
            };
        }

        // Âà™Èô§Ë®òÈåÑ
        function deleteRecord(storeName, id, callback) {
            const transaction = db.transaction([storeName], 'readwrite');
            const store = transaction.objectStore(storeName);
            
            const request = store.delete(id);
            
            request.onsuccess = () => {
                showToast('ÊàêÂäüÂà™Èô§Ë®òÈåÑ');
                if (callback) callback();
            };
            
            request.onerror = () => {
                showToast('Âà™Èô§Ë®òÈåÑÂ§±Êïó');
            };
        }

        // Áç≤ÂèñÊåáÂÆöÂ≠©Â≠êÁöÑË®òÈåÑ
        function getChildById(childId, callback) {
            const transaction = db.transaction(['children'], 'readonly');
            const childrenStore = transaction.objectStore('children');
            
            const request = childrenStore.get(childId);
            
            request.onsuccess = () => {
                if (callback) callback(request.result);
            };
        }

        // Áç≤ÂèñÊúÄËøëÁöÑË®òÈåÑ
        function getRecentRecords(storeName, limit, callback) {
            const transaction = db.transaction([storeName], 'readonly');
            const store = transaction.objectStore(storeName);
            const index = store.index('childId');
            const range = IDBKeyRange.only(currentChildId);
            const request = index.openCursor(range, 'prev');
            
            let records = [];
            let count = 0;
            
            request.onsuccess = (event) => {
                const cursor = event.target.result;
                
                if (cursor && count < limit) {
                    records.push(cursor.value);
                    count++;
                    cursor.continue();
                } else {
                    if (callback) callback(records);
                }
            };
        }

        // Áç≤Âèñ‰ªäÊó•Ë®òÈåÑÊï∏Èáè
        function getTodayRecordsCount(storeName, callback) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            getRecordsBetweenDates(storeName, today, tomorrow, (records) => {
                if (callback) callback(records.length);
            });
        }

        // Áç≤ÂèñÊåáÂÆöÊó•ÊúüÁØÑÂúçÂÖßÁöÑË®òÈåÑ
        function getRecordsBetweenDates(storeName, startDate, endDate, callback) {
            const transaction = db.transaction([storeName], 'readonly');
            const store = transaction.objectStore(storeName);
            const index = store.index('timestamp');
            const range = IDBKeyRange.bound(startDate.toISOString(), endDate.toISOString());
            
            // ÁØ©ÈÅ∏ÁâπÂÆöÂ≠©Â≠êÁöÑË®òÈåÑ
            const request = store.index('childId').openCursor(IDBKeyRange.only(currentChildId));
            
            let records = [];
            
            request.onsuccess = (event) => {
                const cursor = event.target.result;
                
                if (cursor) {
                    const record = cursor.value;
                    const recordDate = new Date(record.timestamp);
                    
                    if (recordDate >= startDate && recordDate < endDate) {
                        records.push(record);
                    }
                    
                    cursor.continue();
                } else {
                    if (callback) callback(records);
                }
            };
        }

        // Áç≤Âèñ‰ªäÊó•Áù°Áú†ÊôÇÊï∏
        function getTodaySleepHours(callback) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            getRecordsBetweenDates('sleep', today, tomorrow, (records) => {
                const totalMinutes = records.reduce((total, record) => total + (record.duration || 0), 0);
                const hours = totalMinutes / 60;
                
                if (callback) callback(hours);
            });
        }

        // Áç≤ÂèñÂπ≥ÂùáÈ§µÈ£üÈñìÈöîÔºàÂ∞èÊôÇÔºâ
        function getAverageFeedingInterval(callback) {
            const transaction = db.transaction(['feeding'], 'readonly');
            const store = transaction.objectStore('feeding');
            const index = store.index('childId');
            const range = IDBKeyRange.only(currentChildId);
            const request = index.openCursor(range);
            
            let timestamps = [];
            
            request.onsuccess = (event) => {
                const cursor = event.target.result;
                
                if (cursor) {
                    timestamps.push(new Date(cursor.value.timestamp));
                    cursor.continue();
                } else {
                    // ÊåâÊôÇÈñìÊéíÂ∫è
                    timestamps.sort((a, b) => a - b);
                    
                    // Ë®àÁÆóÈñìÈöî
                    let totalIntervals = 0;
                    let intervalCount = 0;
                    
                    for (let i = 1; i < timestamps.length; i++) {
                        const interval = (timestamps[i] - timestamps[i - 1]) / (1000 * 60 * 60); // Â∞èÊôÇ
                        
                        // Âè™Ë®àÁÆó 24 Â∞èÊôÇÂÖßÁöÑÈñìÈöî
                        if (interval < 24) {
                            totalIntervals += interval;
                            intervalCount++;
                        }
                    }
                    
                    const avgInterval = intervalCount > 0 ? totalIntervals / intervalCount : null;
                    
                    if (callback) callback(avgInterval);
                }
            };
        }

        // Áç≤ÂèñÂπ≥ÂùáÁù°Áú†ÂìÅË≥™
        function getAverageSleepQuality(callback) {
            const transaction = db.transaction(['sleep'], 'readonly');
            const store = transaction.objectStore('sleep');
            const index = store.index('childId');
            const range = IDBKeyRange.only(currentChildId);
            const request = index.openCursor(range);
            
            let qualityCounts = {
                good: 0,
                normal: 0,
                poor: 0
            };
            
            request.onsuccess = (event) => {
                const cursor = event.target.result;
                
                if (cursor) {
                    qualityCounts[cursor.value.quality]++;
                    cursor.continue();
                } else {
                    // ÊâæÂá∫ÊúÄÂ§öÁöÑÂìÅË≥™
                    let maxQuality = 'normal';
                    
                    if (qualityCounts.good > qualityCounts[maxQuality]) {
                        maxQuality = 'good';
                    }
                    
                    if (qualityCounts.poor > qualityCounts[maxQuality]) {
                        maxQuality = 'poor';
                    }
                    
                    if (callback) callback(maxQuality);
                }
            };
        }

        // Áç≤ÂèñÂ∞øÂ∏ÉÈ°ûÂûãÂàÜÂ∏É
        function getDiaperTypeDistribution(callback) {
            const transaction = db.transaction(['diaper'], 'readonly');
            const store = transaction.objectStore('diaper');
            const index = store.index('childId');
            const range = IDBKeyRange.only(currentChildId);
            const request = index.openCursor(range);
            
            let typeCounts = {
                wet: 0,
                dirty: 0,
                mixed: 0
            };
            
            request.onsuccess = (event) => {
                const cursor = event.target.result;
                
                if (cursor) {
                    typeCounts[cursor.value.type]++;
                    cursor.continue();
                } else {
                    if (callback) callback(typeCounts);
                }
            };
        }

        // Áç≤ÂèñÂÅ•Â∫∑Ë®òÈåÑÔºàÊåâÈ°ûÂûãÔºâ
        function getHealthRecordsByType(type, callback) {
            const transaction = db.transaction(['health'], 'readonly');
            const store = transaction.objectStore('health');
            const index = store.index('childId');
            const range = IDBKeyRange.only(currentChildId);
            const request = index.openCursor(range);
            
            let records = [];
            
            request.onsuccess = (event) => {
                const cursor = event.target.result;
                
                if (cursor) {
                    if (cursor.value.type === type) {
                        records.push(cursor.value);
                    }
                    cursor.continue();
                } else {
                    // ÊåâÊôÇÈñìÊéíÂ∫èÔºàÂæûÊñ∞Âà∞ËàäÔºâ
                    records.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    
                    if (callback) callback(records);
                }
            };
        }

        // Â∑•ÂÖ∑ÂáΩÊï∏

        // Ê†ºÂºèÂåñÊó•ÊúüÔºàÂπ¥ÊúàÊó•Ôºâ
        function formatDate(date, short = false) {
            if (short) {
                return `${date.getFullYear()}/${String(date.getMonth() + 1).padStart(2, '0')}/${String(date.getDate()).padStart(2, '0')}`;
            } else {
                return `${date.getFullYear()} Âπ¥ ${date.getMonth() + 1} Êúà ${date.getDate()} Êó•`;
            }
        }

        // Ê†ºÂºèÂåñÊó•ÊúüÔºàÂÉÖÂπ¥ÊúàÊó•ÔºåÁî®Êñº input[type="date"]Ôºâ
        function formatDateOnly(date) {
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        }

        // Ê†ºÂºèÂåñÊôÇÈñìÔºàÊôÇÂàÜÔºâ
        function formatTime(date) {
            return `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
        }

        // Ê†ºÂºèÂåñÊó•ÊúüÊôÇÈñì
        function formatDateTime(date) {
            return `${formatDate(date, true)} ${formatTime(date)}`;
        }

        // Ê†ºÂºèÂåñÊó•ÊúüÊôÇÈñìÔºàÁî®Êñº input[type="datetime-local"]Ôºâ
        function formatDateTimeLocal(date) {
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}T${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
        }

        // Ê†ºÂºèÂåñÊòüÊúüÂπæ
        function formatDayOfWeek(date) {
            const days = ['Êó•', '‰∏Ä', '‰∫å', '‰∏â', 'Âõõ', '‰∫î', 'ÂÖ≠'];
            return days[date.getDay()];
        }

        // Ê†ºÂºèÂåñÊó•ÊúüÔºàÁî®ÊñºÊ™îÂêçÔºâ
        function formatDateForFilename(date) {
            return `${date.getFullYear()}${String(date.getMonth() + 1).padStart(2, '0')}${String(date.getDate()).padStart(2, '0')}_${String(date.getHours()).padStart(2, '0')}${String(date.getMinutes()).padStart(2, '0')}`;
        }

        // ËºâÂÖ•‰∏ªÈ°åË®≠ÂÆö
        function loadTheme() {
            const savedTheme = localStorage.getItem('theme');
            
            if (savedTheme) {
                document.documentElement.setAttribute('data-theme', savedTheme);
            } else {
                // È†êË®≠‰ΩøÁî®Á≥ªÁµ±‰∏ªÈ°å
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.documentElement.setAttribute('data-theme', 'dark');
                }
            }
        }

        // ÂàùÂßãÂåñÊáâÁî®Á®ãÂºè
        function init() {
            // ÂàùÂßãÂåñ IndexedDB
            initDB();
            
            // ËºâÂÖ•‰∏ªÈ°åË®≠ÂÆö
            loadTheme();
            
            // Á∂ÅÂÆöÂ∞éË¶ΩÂàóÈ†ÖÁõÆÈªûÊìä‰∫ã‰ª∂
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    updatePage(item.dataset.page);
                });
            });
            
            // Á∂ÅÂÆöÊ®°ÊÖãÊ°ÜÈóúÈñâÊåâÈàï
            document.getElementById('modal-close').addEventListener('click', closeModal);
            
            // ÈªûÊìäÊ®°ÊÖãÊ°ÜËÉåÊôØÈóúÈñâ
            document.getElementById('modal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('modal')) {
                    closeModal();
                }
            });
            
            // Áõ£ËÅΩÁ≥ªÁµ±‰∏ªÈ°åËÆäÂåñ
            if (window.matchMedia) {
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                    if (!localStorage.getItem('theme')) {
                        document.documentElement.setAttribute('data-theme', e.matches ? 'dark' : 'light');
                    }
                });
            }
        }

        // ÂïüÂãïÊáâÁî®Á®ãÂºè
        init();
    </script>
   <script src="debug.js"></script>
</body>
</html>